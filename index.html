<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
  <title>MuchiNavi — あなたの住まい探しAIアシスタント</title>
  <meta name="description" content="AIがあなたにぴったりの住まい探しをサポート。住宅ローン・エリア選び・物件タイプの相談が24時間無料。不動産エージェント岡本岳大が提供するAIアシスタント。">
  <meta name="keywords" content="住宅購入,マイホーム,住宅ローン,不動産相談,AI,住まい探し,TERASS">
  <meta name="author" content="岡本岳大 | TERASS">
  <!-- OGP -->
  <meta property="og:title" content="MuchiNavi — あなたの住まい探しAIアシスタント">
  <meta property="og:description" content="AIが住宅購入をサポート。住宅ローン・エリア選び・物件探しの相談が24時間無料。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://muchinavi.com">
  <meta property="og:site_name" content="MuchiNavi">
  <meta property="og:locale" content="ja_JP">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MuchiNavi — 住まい探しAIアシスタント">
  <meta name="twitter:description" content="AIが住宅購入をサポート。24時間無料で相談できます。">
  <meta name="theme-color" content="#1d1d1f">
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MuchiNavi">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    /* パフォーマンス: 低速端末でアニメーション無効化 */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #1d1d1f;
      --accent: #0071e3;
      --accent-hover: #0077ED;
      --accent-subtle: rgba(0,113,227,0.06);
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.82);
      --text: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-light: #aeaeb2;
      --border: rgba(0,0,0,0.08);
      --success: #34c759;
      --danger: #ff3b30;
      --radius: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 48px rgba(0,0,0,0.12);
      --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* ===== Background decoration (軽量版) ===== */
    .bg-glow {
      position: fixed;
      width: 600px; height: 600px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
      z-index: 0;
      will-change: auto;
    }
    .bg-glow-1 { top: -200px; right: -100px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); }
    .bg-glow-2 { bottom: -200px; left: -100px; background: radial-gradient(circle, #5856d6 0%, transparent 70%); }

    /* ===== Container ===== */
    .container {
      position: relative;
      z-index: 1;
      max-width: 520px;
      margin: 0 auto;
      padding: 24px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* ===== Step card ===== */
    .step-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 48px 36px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      animation: cardIn 0.35s ease-out;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(24px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes cardOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-20px) scale(0.96); }
    }
    .step-card.leaving {
      animation: cardOut 0.3s ease forwards;
    }

    /* ===== Step elements ===== */
    .step-icon {
      font-size: 56px;
      margin-bottom: 20px;
      display: inline-block;
      /* floatアニメーション削除で軽量化 */
    }
    /* @keyframes float 削除済み（パフォーマンス改善） */
    .step-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      color: var(--primary);
    }
    .step-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: 28px;
    }
    .step-response {
      font-size: 14px;
      color: var(--accent);
      font-weight: 600;
      margin-top: 16px;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.2s ease;
    }
    .step-response.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ===== Progress bar ===== */
    .progress-container {
      margin-bottom: 32px;
      text-align: center;
    }
    .progress-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .progress-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s ease;
    }
    .progress-dot.active {
      background: var(--accent);
      width: 24px;
      border-radius: 4px;
    }
    .progress-dot.done {
      background: var(--success);
    }
    .progress-label {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 8px;
      font-weight: 500;
    }

    /* ===== Inputs ===== */
    .input-field {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      font-family: inherit;
      background: white;
      color: var(--text);
      outline: none;
      transition: all 0.3s ease;
      text-align: center;
    }
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }
    .input-field::placeholder {
      color: var(--text-light);
    }

    /* ===== Buttons ===== */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 40px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,113,227,0.3);
    }
    .btn-primary:active {
      transform: scale(0.97);
    }
    .btn-primary:disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 980px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover {
      background: rgba(0,0,0,0.04);
      color: var(--text);
    }
    .btn-login {
      background: none;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 12px 32px;
      border-radius: 980px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }
    .btn-login:hover {
      background: var(--accent);
      color: white;
    }

    /* ===== Login screen ===== */
    .login-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .login-screen.active { display: flex; }
    .login-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 48px 36px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 520px;
      width: 100%;
    }

    /* ===== Choice cards ===== */
    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    .choice-card {
      padding: 20px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    .choice-card:hover {
      border-color: rgba(0,113,227,0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .choice-card.selected {
      border-color: var(--accent);
      background: var(--accent-subtle);
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }
    .choice-icon { font-size: 28px; margin-bottom: 8px; }
    .choice-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
    }

    /* ===== Slider ===== */
    .slider-container {
      width: 100%;
      margin: 16px 0;
    }
    .budget-display {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, var(--accent), #5856d6);
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-light);
      margin-top: 8px;
    }

    /* ===== Sub-question ===== */
    .sub-question {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      animation: cardIn 0.4s ease;
    }
    .sub-question label {
      font-size: 13px;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 8px;
    }

    /* ===== Completion ===== */
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }
    .completion-check {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: var(--success);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      animation: checkPop 0.6s ease;
    }
    @keyframes checkPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .completion-check svg {
      width: 40px; height: 40px;
      stroke: white;
      stroke-width: 3;
      fill: none;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkDraw 0.6s 0.3s forwards;
    }
    @keyframes checkDraw {
      to { stroke-dashoffset: 0; }
    }

    /* ===== Chat UI ===== */
    .chat-screen {
      display: none;
      flex-direction: column;
      height: 100dvh;
      height: 100vh; /* fallback */
      max-width: 100%;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 100;
      overflow: hidden;
    }
    .chat-screen.active { display: flex; }

    .chat-header {
      padding: 20px 24px;
      text-align: center;
      background: #1d1d1f;
      color: white;
      transition: all 0.3s ease;
    }
    .chat-header.compact {
      padding: 8px 16px;
    }
    .chat-header.compact .chat-header-label,
    .chat-header.compact .chat-header-sub {
      display: none;
    }
    .chat-header.compact .chat-header-title {
      font-size: 15px;
    }
    .chat-header.compact .chat-header-actions {
      margin-top: 6px;
      gap: 4px;
    }
    .chat-header.compact .chat-header-btn {
      font-size: 10px;
      padding: 5px 10px;
    }
    .chat-header.compact .chat-header-btn.settings-toggle {
      padding: 5px 8px;
    }
    .chat-header.compact .chat-header-btn svg {
      width: 11px;
      height: 11px;
    }
    .chat-header-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 3px;
      opacity: 0.4;
      margin-bottom: 4px;
    }
    .chat-header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .chat-header-sub {
      font-size: 12px;
      opacity: 0.5;
      margin-top: 4px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .chat-message {
      display: flex;
      gap: 8px;
      animation: msgIn 0.4s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .chat-message.user { justify-content: flex-end; }
    .chat-bubble {
      max-width: 80%;
      padding: 14px 20px;
      font-size: 14px;
      line-height: 1.75;
      word-wrap: break-word;
    }
    .chat-message.assistant .chat-bubble {
      background: white;
      color: var(--text);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .chat-message.user .chat-bubble {
      background: var(--accent);
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
      box-shadow: 0 2px 8px rgba(0,113,227,0.25);
    }
    .chat-bubble p { margin: 0 0 8px 0; }
    .chat-bubble p:last-child { margin-bottom: 0; }
    .chat-bubble ul, .chat-bubble ol { margin: 6px 0; padding-left: 20px; }
    .chat-bubble li { margin-bottom: 4px; line-height: 1.6; }
    .chat-bubble strong { font-weight: 600; }

    /* 個人チャット用の色分け */
    .chat-bubble.direct-user {
      background: #34c759;
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
      box-shadow: 0 2px 8px rgba(52,199,89,0.25);
    }
    .chat-bubble.direct-assistant {
      background: #f0faf3;
      color: var(--text);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid rgba(52,199,89,0.2);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    .chat-input-bar {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: white;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }
    .chat-input-bar textarea {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border 0.2s;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      line-height: 1.5;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chat-input-bar textarea:focus {
      border-color: var(--accent);
    }
    .chat-input-bar button {
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      height: 44px;
    }
    .chat-input-bar button:hover { background: var(--accent-hover); }
    .chat-input-bar button:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    /* Progress Bar */
    .progress-bar-container {
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 14px 16px 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .progress-bar-container.collapsed {
      padding: 8px 16px;
    }
    .progress-bar-steps {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      margin-bottom: 8px;
      min-width: 0;
    }
    .progress-bar-container.collapsed .progress-bar-steps {
      margin-bottom: 0;
    }
    .progress-bar-container.collapsed .progress-bar-labels,
    .progress-bar-container.collapsed .progress-bar-status {
      display: none;
    }
    .progress-step {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #e5e5ea;
      border: 2px solid #e5e5ea;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .progress-step.completed {
      background: #0071e3;
      border-color: #0071e3;
    }
    .progress-step.completed svg { stroke: #fff; }
    .progress-step.active {
      background: #fff;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.15);
    }
    .progress-step.active::after {
      content: '';
      width: 8px;
      height: 8px;
      background: #0071e3;
      border-radius: 50%;
      position: absolute;
    }
    .progress-line {
      flex: 1;
      height: 2px;
      background: #e5e5ea;
      margin: 0 -1px;
      z-index: 1;
    }
    .progress-line.completed {
      background: #0071e3;
    }
    .progress-bar-labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .progress-label {
      font-size: 9px;
      color: #aeaeb2;
      text-align: center;
      width: 18px;
      overflow: visible;
      white-space: nowrap;
    }
    .progress-label.active {
      color: #0071e3;
      font-weight: 600;
    }
    .progress-label.completed {
      color: #6e6e73;
    }
    .progress-bar-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 4px;
      border-top: 1px solid rgba(0,0,0,0.04);
    }
    .progress-status-text {
      font-size: 12px;
      color: #1d1d1f;
      font-weight: 600;
    }
    .progress-status-count {
      font-size: 11px;
      color: #aeaeb2;
    }
    .progress-next-action {
      margin-top: 8px;
      padding: 10px 12px;
      background: linear-gradient(135deg, #f0f7ff, #e8f4f8);
      border-radius: 10px;
      border: 1px solid rgba(0,113,227,0.1);
      font-size: 12px;
      line-height: 1.5;
      color: #1d1d1f;
    }
    .progress-next-action .next-label {
      font-size: 10px;
      font-weight: 700;
      color: #0071e3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    .progress-next-action .next-text {
      color: #333;
    }
    .progress-next-action .next-btn {
      display: inline-block;
      margin-top: 6px;
      padding: 5px 14px;
      background: #0071e3;
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    .progress-next-action .next-btn:hover {
      background: #0077ed;
    }
    .progress-bar-container.collapsed .progress-next-action {
      display: none;
    }
    .progress-bar-container.collapsed .progress-step {
      width: 12px;
      height: 12px;
    }

    /* Mobile card view - hidden on desktop */
    .progress-mobile-card {
      display: none;
      padding: 12px 16px;
    }
    .progress-mobile-mini {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      cursor: pointer;
    }
    .progress-mobile-mini-dot {
      width: 10px;
      height: 10px;
      background: #0071e3;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .progress-mobile-mini-text {
      font-size: 12px;
      font-weight: 600;
      color: #1d1d1f;
    }
    .progress-mobile-mini-count {
      font-size: 11px;
      color: #aeaeb2;
      margin-left: auto;
    }
    .progress-card-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .progress-card-prev,
    .progress-card-next {
      font-size: 10px;
      color: #aeaeb2;
      background: #f5f5f7;
      border-radius: 12px;
      padding: 3px 10px;
      white-space: nowrap;
    }
    .progress-card-arrow {
      color: #aeaeb2;
      font-size: 10px;
    }
    .progress-card-current-label {
      font-size: 10px;
      color: #0071e3;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .progress-card-current {
      background: linear-gradient(135deg, #f0f7ff, #e8f4f8);
      border: 1px solid rgba(0,113,227,0.15);
      border-radius: 12px;
      padding: 14px 16px;
    }
    .progress-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1d1d1f;
      margin-bottom: 4px;
    }
    .progress-card-count {
      font-size: 12px;
      color: #aeaeb2;
    }
    .progress-card-dots {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 10px;
    }
    .progress-card-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #e5e5ea;
    }
    .progress-card-dot.completed { background: #0071e3; }
    .progress-card-dot.active {
      background: #0071e3;
      width: 18px;
      border-radius: 3px;
    }
    .progress-bar-container.collapsed .progress-step.active::after {
      width: 5px;
      height: 5px;
    }

    .chat-room-tabs {
      display: flex;
      background: #f5f5f7;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 0;
    }
    .chat-room-tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      background: none;
      border: none;
      color: #6e6e73;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border-bottom: 2px solid transparent;
    }
    .chat-room-tab.active {
      color: #0071e3;
      border-bottom-color: #0071e3;
    }
    .chat-room-tab .tab-badge {
      display: none;
      position: absolute;
      top: 6px;
      right: calc(50% - 40px);
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }
    .chat-room-tab .tab-badge.show { display: block; }

    .chat-welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      padding: 40px 24px;
    }
    .chat-welcome-icon { font-size: 48px; margin-bottom: 16px; }
    .chat-welcome h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .chat-welcome p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.7;
      max-width: 300px;
    }
    .chat-hints {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 20px;
      justify-content: center;
    }
    .chat-hint {
      font-size: 12px;
      padding: 8px 14px;
      background: var(--accent-subtle);
      color: var(--accent);
      border-radius: 980px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all 0.2s;
    }
    .chat-hint:hover {
      background: var(--accent);
      color: white;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 18px;
      background: white;
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid var(--border);
      width: fit-content;
    }
    .typing-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--text-light);
      animation: typingBounce 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    /* ===== Article Card ===== */
    .article-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      margin: 12px 0 8px;
      background: linear-gradient(135deg, #f0f7ff 0%, #f5f0ff 100%);
      border: 1px solid rgba(0,113,227,0.12);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
    }
    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,113,227,0.15);
      border-color: var(--accent);
    }
    .article-card-icon {
      font-size: 24px;
      flex-shrink: 0;
      display: inline-block;
    }
    .article-card-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .article-card-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 2px;
      display: block;
    }
    .article-card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      line-height: 1.4;
      display: block;
    }
    .article-card-arrow {
      font-size: 16px;
      color: var(--accent);
      flex-shrink: 0;
      display: inline-block;
    }

    /* ===== Booking Card ===== */
    .booking-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      margin: 12px 0 8px;
      background: linear-gradient(135deg, #1d1d1f 0%, #2c2c2e 100%);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: white;
    }
    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .booking-card-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .booking-card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .booking-card-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      opacity: 0.5;
      margin-bottom: 2px;
      display: block;
    }
    .booking-card-title {
      font-size: 14px;
      font-weight: 600;
      display: block;
    }
    .booking-card-sub {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
      display: block;
    }
    .booking-card-arrow {
      font-size: 18px;
      opacity: 0.4;
      display: inline-block;
    }

    /* ===== Chat header action buttons ===== */
    .chat-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .chat-header-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 9px 16px;
      border-radius: 980px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      border: none;
      line-height: 1;
    }
    /* オンライン面談 — 白地にアクセントカラー */
    .chat-header-btn.booking {
      background: white;
      color: #0071e3;
    }
    .chat-header-btn.booking:hover {
      background: #f0f0f0;
    }
    /* マイページ — 半透明白 */
    .chat-header-btn.profile {
      background: rgba(255,255,255,0.18);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .chat-header-btn.profile:hover {
      background: rgba(255,255,255,0.3);
    }
    /* 設定 — 控えめ */
    .chat-header-btn.settings-toggle {
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 9px 12px;
    }
    .chat-header-btn.settings-toggle:hover {
      background: rgba(255,255,255,0.18);
      color: white;
    }

    /* ===== Choice Chips in Chat ===== */
    .chat-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 4px;
    }
    .chat-choice-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: white;
      border: 2px solid var(--accent);
      border-radius: 980px;
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      line-height: 1.3;
    }
    .chat-choice-chip:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,113,227,0.25);
    }
    .chat-choice-chip:active {
      transform: scale(0.96);
    }
    .chat-choice-chip.used {
      background: var(--accent-subtle);
      border-color: rgba(0,113,227,0.2);
      color: var(--text-secondary);
      cursor: default;
      pointer-events: none;
    }
    .chat-choice-chip.used::before {
      content: '✓ ';
    }

    /* ===== Settings dropdown ===== */
    .settings-wrapper {
      position: relative;
    }
    .settings-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      border: 1px solid var(--border);
      min-width: 180px;
      z-index: 200;
      animation: fadeInDown 0.2s ease;
    }
    .settings-dropdown.show { display: block; }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .settings-dropdown-item {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 13px;
      font-family: inherit;
      text-align: left;
      cursor: pointer;
      color: var(--text);
      transition: background 0.15s;
    }
    .settings-dropdown-item:hover { background: var(--bg); }
    .settings-dropdown-item.danger { color: var(--danger); }

    /* ===== Withdraw / Block modals ===== */
    .overlay-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      z-index: 500;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .overlay-modal.active { display: flex; }
    .modal-inner {
      background: white;
      border-radius: var(--radius-lg);
      padding: 36px 32px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      animation: cardIn 0.4s ease;
    }
    .modal-inner-icon { font-size: 48px; margin-bottom: 16px; }
    .modal-inner-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal-inner-text { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 24px; }
    .modal-btn-row { display: flex; gap: 12px; }
    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 980px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-btn-cancel {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .modal-btn-cancel:hover { background: #e8e8ed; }
    .modal-btn-danger {
      background: var(--danger);
      border: none;
      color: white;
    }
    .modal-btn-danger:hover { background: #e63329; }

    /* Block screen */
    .blocked-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 600;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }
    .blocked-screen.active { display: flex; flex-direction: column; }
    .blocked-icon { font-size: 64px; margin-bottom: 20px; }
    .blocked-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .blocked-text { font-size: 14px; color: var(--text-secondary); line-height: 1.7; }

    /* ===== Profile Screen ===== */
    .profile-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 150;
    }
    .profile-screen.active { display: flex; }

    .profile-header {
      padding: 20px 24px;
      text-align: center;
      background: #1d1d1f;
      color: white;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .profile-back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 0;
      font-weight: 600;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }
    .profile-back-btn:hover { opacity: 0.7; }
    .profile-header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      flex: 1;
    }

    .profile-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .profile-section {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .profile-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.6;
    }

    .profile-field {
      margin-bottom: 16px;
    }
    .profile-field:last-child { margin-bottom: 0; }
    .profile-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .profile-field input,
    .profile-field select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      color: var(--text);
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .profile-field input:focus,
    .profile-field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .profile-save-btn {
      width: calc(100% - 32px);
      padding: 16px 24px;
      margin: 32px 16px 40px;
      font-size: 16px;
      font-weight: 700;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .profile-save-btn:hover { background: var(--accent-hover); }
    .profile-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .profile-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      max-width: 90%;
      text-align: center;
      z-index: 200;
    }
    .profile-toast.success {
      background: var(--success);
      color: white;
    }
    .profile-toast.error {
      background: var(--danger);
      color: white;
    }
    .profile-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Responsive ===== */
    @media (max-width: 560px) {
      /* Onboarding */
      .container { padding: 12px; }
      .step-card { padding: 28px 18px; }
      .step-icon { font-size: 40px; margin-bottom: 14px; }
      .step-title { font-size: 18px; }
      .step-subtitle { font-size: 13px; }
      .choices { grid-template-columns: 1fr 1fr; gap: 8px; }
      .choice-card { padding: 14px 10px; }
      .choice-icon { font-size: 24px; }
      .choice-label { font-size: 12px; }
      .input-field { font-size: 16px; padding: 12px 14px; }
      .next-btn { font-size: 15px; padding: 14px; }
      .prefecture-grid { grid-template-columns: repeat(5, 1fr); gap: 6px; }
      .prefecture-btn { padding: 10px 6px; font-size: 11px; }
      .birthdate-container { gap: 10px; }
      .birthdate-selector select { font-size: 13px; padding: 12px 10px; }
      .next-choice-btn { font-size: 14px; padding: 12px 28px; min-width: 140px; }

      /* Chat Header */
      .chat-header { padding: 14px 16px; }
      .chat-header-title { font-size: 17px; }
      .chat-header-label { font-size: 9px; letter-spacing: 2px; }
      .chat-header-sub { font-size: 11px; }
      .chat-header-actions { gap: 6px; margin-top: 10px; }
      .chat-header-btn { font-size: 12px; padding: 8px 14px; }
      .chat-header-btn.settings-toggle { padding: 8px 10px; }

      /* Progress Bar - mobile card view */
      .progress-bar-container { padding: 0; }
      .progress-bar-container.collapsed { padding: 0; }
      .progress-bar-scroll-wrapper { display: none; }
      .progress-bar-status { display: none !important; }
      .progress-bar-container .progress-mobile-card { display: block; }
      .progress-bar-container .progress-mobile-mini { display: none; }
      .progress-bar-container.collapsed .progress-mobile-card { display: none; }
      .progress-bar-container.collapsed .progress-next-action { display: none; }
      .progress-bar-container.collapsed .progress-mobile-mini { display: flex; }

      /* Chat Messages */
      .chat-messages { padding: 16px 10px; gap: 12px; }
      .chat-bubble {
        max-width: 88%;
        padding: 11px 14px;
        font-size: 13px;
        line-height: 1.7;
      }
      .chat-bubble p { margin: 0 0 6px 0; }
      .chat-bubble ul, .chat-bubble ol { padding-left: 16px; }

      /* Chat Input */
      .chat-input-bar { padding: 10px 10px; gap: 8px; }
      .chat-input-bar textarea {
        padding: 10px 14px;
        font-size: 16px; /* 16px prevents iOS zoom on focus */
        min-height: 40px;
        max-height: 100px;
      }
      .chat-input-bar button { padding: 10px 18px; font-size: 13px; height: 40px; }

      /* Article Card */
      .article-card { padding: 12px 14px; gap: 10px; margin: 8px 0 6px; }
      .article-card-icon { font-size: 20px; }
      .article-card-title { font-size: 12px; }
      .article-card-label { font-size: 9px; }

      /* Booking Card */
      .booking-card { padding: 14px 14px; gap: 10px; margin: 8px 0 6px; }
      .booking-card-icon { width: 36px; height: 36px; font-size: 16px; border-radius: 10px; }
      .booking-card-title { font-size: 13px; }
      .booking-card-sub { font-size: 10px; }
      .booking-card-label { font-size: 9px; }

      /* Choice Chips */
      .chat-choices { gap: 6px; margin: 8px 0 4px; }
      .chat-choice-chip { padding: 8px 12px; font-size: 12px; }

      /* Welcome */
      .chat-welcome { padding: 24px 16px; }
      .chat-welcome-icon { font-size: 36px; }
      .chat-welcome h3 { font-size: 16px; }
      .chat-welcome p { font-size: 12px; max-width: 260px; }
      .chat-hints { gap: 6px; margin-top: 14px; }
      .chat-hint { font-size: 11px; padding: 6px 10px; }

      /* Modal */
      .overlay-modal { padding: 16px; }
      .modal-inner { padding: 28px 20px; }
      .modal-inner-icon { font-size: 36px; margin-bottom: 12px; }
      .modal-inner-title { font-size: 16px; }
      .modal-inner-text { font-size: 13px; }
      .modal-btn { font-size: 14px; padding: 12px; }

      /* Settings dropdown */
      .settings-dropdown { min-width: 150px; right: 8px; }
    }

    /* Extra small screens (iPhone SE etc.) */
    @media (max-width: 375px) {
      .step-card { padding: 24px 14px; }
      .step-icon { font-size: 36px; }
      .step-title { font-size: 16px; }
      .chat-bubble { max-width: 92%; font-size: 12.5px; }
      .chat-header { padding: 12px 12px; }
      .chat-header-title { font-size: 15px; }
      .chat-input-bar textarea { padding: 10px 12px; }
      .chat-input-bar button { padding: 10px 14px; font-size: 12px; height: 38px; }
      .chat-choice-chip { padding: 6px 10px; font-size: 11px; }
      .chat-header-btn { font-size: 11px; padding: 7px 10px; }
    }

    /* Safe area support for notched devices */
    @supports (padding: env(safe-area-inset-bottom)) {
      .chat-input-bar {
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .chat-header {
        padding-top: calc(14px + env(safe-area-inset-top));
      }
      .chat-header.compact {
        padding-top: calc(6px + env(safe-area-inset-top));
      }
    }

    /* Ensure input bar is always visible */
    .chat-input-bar {
      flex-shrink: 0;
      z-index: 10;
    }
    .chat-messages {
      min-height: 0;
    }

    /* ===== Back Button ===== */
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      padding: 8px 14px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 980px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .back-button:hover {
      background: rgba(0,0,0,0.04);
      color: var(--text);
    }

    /* ===== Next Button (for choice/prefecture) ===== */
    .next-choice-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 40px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
      margin-top: 16px;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
    }
    .next-choice-btn.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .next-choice-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,113,227,0.3);
    }
    .next-choice-btn:active {
      transform: scale(0.97);
    }

    /* ===== Prefecture Grid ===== */
    .prefecture-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 16px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }
    .prefecture-region-header {
      grid-column: 1 / -1;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 8px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .prefecture-btn {
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      font-family: inherit;
    }
    .prefecture-btn:hover {
      border-color: rgba(0,113,227,0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .prefecture-btn.selected {
      border-color: var(--accent);
      background: var(--accent-subtle);
      color: var(--accent);
      font-weight: 600;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }

    /* ===== Birthdate Selectors ===== */
    .birthdate-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .birthdate-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 120px;
    }
    .birthdate-selector label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .birthdate-selector select {
      padding: 14px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      background: white;
      color: var(--text);
      outline: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .birthdate-selector select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }

    /* ===== Powered by footer ===== */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 11px;
      color: var(--text-light);
    }
    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="bg-glow bg-glow-1"></div>
  <div class="bg-glow bg-glow-2"></div>

  <!-- ===== Onboarding ===== -->
  <div class="container" id="onboarding">
    <div class="progress-container" id="progress" style="display:none;">
      <div class="progress-dots" id="progress-dots"></div>
      <div class="progress-label" id="progress-label"></div>
    </div>

    <div class="step-card" id="step-card">
      <!-- Steps will be rendered here by JS -->
    </div>

    <div class="footer">
      Powered by <a href="https://muchinochi.com" target="_blank">muchinochi</a>
    </div>
  </div>

  <!-- ===== ログイン画面 ===== -->
  <div class="login-screen" id="login-screen">
    <!-- 通常ログインフォーム -->
    <div class="login-card" id="login-form-card">
      <div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
      <h2 class="step-title">ログイン</h2>
      <p class="step-subtitle">登録時のメールアドレスとパスワードを入力してください</p>
      <div style="text-align: left; display: flex; flex-direction: column; gap: 14px; margin-top: 24px;">
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">メールアドレス</label>
          <input class="input-field" type="email" id="login-email" placeholder="example@email.com" style="text-align: left;">
        </div>
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">パスワード</label>
          <div style="position: relative;">
            <input class="input-field" type="password" id="login-password" placeholder="パスワード" style="text-align: left; padding-right: 50px;" onkeypress="if(event.key==='Enter')doLogin()">
            <button type="button" onclick="togglePasswordVisibility('login-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
          </div>
        </div>
      </div>
      <div id="login-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div style="margin-top: 24px;">
        <button class="btn-primary" onclick="doLogin()">ログイン</button>
      </div>
      <button onclick="showResetForm()" style="margin-top: 16px; background:none; border:none; color:var(--accent); font-size:13px; cursor:pointer; font-family:inherit;">パスワードをお忘れの方</button>
      <div style="margin-top: 12px;">
        <button class="btn-login" onclick="hideLoginForm()">← 新規登録に戻る</button>
      </div>
    </div>

    <!-- パスワードリセットフォーム -->
    <div class="login-card" id="reset-form-card" style="display: none;">
      <div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
      <h2 class="step-title">パスワード再設定</h2>
      <p class="step-subtitle">登録時のメールアドレスを入力してください。<br>確認後、新しいパスワードを設定できます。</p>
      <div style="text-align: left; display: flex; flex-direction: column; gap: 14px; margin-top: 24px;">
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">メールアドレス</label>
          <input class="input-field" type="email" id="reset-email" placeholder="example@email.com" style="text-align: left;">
        </div>
        <div id="reset-password-section" style="display: none;">
          <div style="margin-bottom: 14px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">新しいパスワード</label>
            <div style="position: relative;">
              <input class="input-field" type="password" id="reset-new-password" placeholder="6文字以上" style="text-align: left; padding-right: 50px;">
              <button type="button" onclick="togglePasswordVisibility('reset-new-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
            </div>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">新しいパスワード（確認）</label>
            <div style="position: relative;">
              <input class="input-field" type="password" id="reset-new-password-confirm" placeholder="もう一度入力" style="text-align: left; padding-right: 50px;" onkeypress="if(event.key==='Enter')doResetPassword()">
              <button type="button" onclick="togglePasswordVisibility('reset-new-password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
            </div>
          </div>
        </div>
      </div>
      <div id="reset-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div id="reset-success" style="color: var(--success); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div style="margin-top: 24px;">
        <button class="btn-primary" id="reset-btn" onclick="doVerifyEmail()">メールアドレスを確認</button>
      </div>
      <div style="margin-top: 12px;">
        <button class="btn-login" onclick="showLoginCard()">← ログインに戻る</button>
      </div>
    </div>
  </div>

  <!-- ===== Chat Screen ===== -->
  <div class="chat-screen" id="chat-screen">
    <div class="chat-header">
      <div class="chat-header-label">AI Assistant</div>
      <div class="chat-header-title">MuchiNavi</div>
      <div class="chat-header-sub" id="chat-customer-name"></div>
      <div class="chat-header-actions">
        <a class="chat-header-btn booking" id="chat-booking-btn" href="#" target="_blank" rel="noopener">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> オンライン面談
        </a>
        <button class="chat-header-btn profile" onclick="openProfile()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> マイページ
        </button>
        <div class="settings-wrapper">
          <button class="chat-header-btn settings-toggle" onclick="toggleSettings(event)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
          <div class="settings-dropdown" id="settings-dropdown">
            <button class="settings-dropdown-item" onclick="doLogout()">ログアウト</button>
            <button class="settings-dropdown-item danger" onclick="showWithdrawModal()">退会する</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container" id="progress-bar">
      <div class="progress-mobile-mini" onclick="toggleProgressBar()" id="progress-mobile-mini"></div>
      <div onclick="toggleProgressBar()" style="cursor:pointer;">
        <div class="progress-mobile-card" id="progress-mobile-card"></div>
        <div class="progress-bar-scroll-wrapper">
          <div class="progress-bar-steps" id="progress-steps"></div>
          <div class="progress-bar-labels" id="progress-labels"></div>
        </div>
        <div class="progress-bar-status">
          <span class="progress-status-text" id="progress-status-text"></span>
          <span class="progress-status-count" id="progress-status-count"></span>
        </div>
      </div>
      <div class="progress-next-action" id="progress-next-action"></div>
    </div>

    <!-- Chat room tab switcher -->
    <div class="chat-room-tabs">
      <button class="chat-room-tab active" id="tab-ai" onclick="switchChatRoom('ai')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="9" cy="16" r="1"/><circle cx="15" cy="16" r="1"/><path d="M8 11V7a4 4 0 0 1 8 0v4"/></svg> MuchiNavi
        <span class="tab-badge" id="badge-ai"></span>
      </button>
      <button class="chat-room-tab" id="tab-direct" onclick="switchChatRoom('direct')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> エージェントに相談
        <span class="tab-badge" id="badge-direct"></span>
      </button>
    </div>

    <!-- AI Chat Room (existing) -->
    <div class="chat-messages" id="chat-messages" style="display: flex;">
      <div class="chat-welcome" id="chat-welcome">
        <div class="chat-welcome-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
        <h3>MuchiNaviに何でも聞いてください</h3>
        <p>住宅ローン、物件の選び方、スケジュール…<br>住まい探しのことなら何でもお気軽にどうぞ。</p>
        <div class="chat-hints">
          <button class="chat-hint" onclick="sendHint('住宅ローンって何から始めればいいですか？')">住宅ローンの始め方</button>
          <button class="chat-hint" onclick="sendHint('物件探しで失敗しないコツを教えてください')">物件探しのコツ</button>
          <button class="chat-hint" onclick="sendHint('購入までのスケジュール感を教えてください')">購入スケジュール</button>
        </div>
      </div>
    </div>
    <div class="chat-input-bar" id="ai-chat-input-bar">
      <textarea id="chat-input" placeholder="MuchiNaviに質問…" rows="1"></textarea>
      <button onclick="sendMessage()" id="chat-send-btn">送信</button>
    </div>

    <!-- Direct Chat Room (new) -->
    <div class="chat-messages" id="direct-chat-messages" style="display: none;">
      <div class="chat-welcome" id="direct-chat-welcome">
        <div class="chat-welcome-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <h3>担当エージェントに直接相談できます</h3>
        <p>AIではなく、担当エージェントに直接メッセージを送れます。<br>お返事までお時間をいただく場合があります。</p>
      </div>
    </div>
    <div class="chat-input-bar" id="direct-chat-input-bar" style="display: none;">
      <textarea id="direct-chat-input" placeholder="エージェントにメッセージ…" rows="1"></textarea>
      <button onclick="sendDirectMessage()" id="direct-send-btn">送信</button>
    </div>
  </div>

  <!-- ===== プロフィール編集画面 ===== -->
  <div class="profile-screen" id="profile-screen">
    <div class="profile-header">
      <button class="profile-back-btn" onclick="closeProfile()">← チャットに戻る</button>
      <div class="profile-header-title">マイページ</div>
    </div>
    <div class="profile-body">
      <div class="profile-section">
        <div class="profile-section-title">基本情報</div>
        <div class="profile-field">
          <label>お名前</label>
          <input type="text" id="prof-name" placeholder="例: 山田太郎">
        </div>
        <div class="profile-field">
          <label>生まれ年</label>
          <select id="prof-birthYear">
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="profile-field">
          <label>生まれ月</label>
          <select id="prof-birthMonth">
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="profile-field">
          <label>お住まいの都道府県</label>
          <select id="prof-prefecture">
            <option value="">選択してください</option>
            <option value="北海道">北海道</option><option value="青森">青森</option><option value="岩手">岩手</option><option value="宮城">宮城</option><option value="秋田">秋田</option><option value="山形">山形</option><option value="福島">福島</option>
            <option value="茨城">茨城</option><option value="栃木">栃木</option><option value="群馬">群馬</option><option value="埼玉">埼玉</option><option value="千葉">千葉</option><option value="東京">東京</option><option value="神奈川">神奈川</option>
            <option value="新潟">新潟</option><option value="富山">富山</option><option value="石川">石川</option><option value="福井">福井</option><option value="山梨">山梨</option><option value="長野">長野</option><option value="岐阜">岐阜</option><option value="静岡">静岡</option><option value="愛知">愛知</option>
            <option value="三重">三重</option><option value="滋賀">滋賀</option><option value="京都">京都</option><option value="大阪">大阪</option><option value="兵庫">兵庫</option><option value="奈良">奈良</option><option value="和歌山">和歌山</option>
            <option value="鳥取">鳥取</option><option value="島根">島根</option><option value="岡山">岡山</option><option value="広島">広島</option><option value="山口">山口</option><option value="徳島">徳島</option><option value="香川">香川</option><option value="愛媛">愛媛</option><option value="高知">高知</option>
            <option value="福岡">福岡</option><option value="佐賀">佐賀</option><option value="長崎">長崎</option><option value="熊本">熊本</option><option value="大分">大分</option><option value="宮崎">宮崎</option><option value="鹿児島">鹿児島</option><option value="沖縄">沖縄</option>
          </select>
        </div>
        <div class="profile-field">
          <label>ご家族構成</label>
          <input type="text" id="prof-family" placeholder="例: 夫婦＋子ども1人">
        </div>
        <div class="profile-field">
          <label>世帯年収</label>
          <select id="prof-householdIncome" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
            <option value="">選択してください</option>
            <option value="〜499万円">〜499万円</option>
            <option value="500〜999万円">500〜999万円</option>
            <option value="1,000〜1,499万円">1,000〜1,499万円</option>
            <option value="1,500〜1,999万円">1,500〜1,999万円</option>
            <option value="2,000〜2,499万円">2,000〜2,499万円</option>
            <option value="2,500〜2,999万円">2,500〜2,999万円</option>
            <option value="3,000万円〜">3,000万円〜</option>
          </select>
        </div>
      </div>

      <div class="profile-section">
        <div class="profile-section-title">お住まいの希望</div>
        <div class="profile-field">
          <label>物件種別</label>
          <select id="prof-propertyType" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
            <option value="">選択してください</option>
            <option value="中古戸建て">中古戸建て</option>
            <option value="中古マンション">中古マンション</option>
            <option value="新築戸建て">新築戸建て</option>
            <option value="注文住宅">注文住宅</option>
          </select>
        </div>
        <div class="profile-field">
          <label>希望エリア</label>
          <input type="text" id="prof-area" placeholder="例: 東京都世田谷区">
        </div>
        <div class="profile-field">
          <label>ご予算</label>
          <input type="text" id="prof-budget" placeholder="例: 5000万円">
        </div>
      </div>

      <div class="profile-section">
        <div class="profile-section-title">連絡先</div>
        <div class="profile-field">
          <label>メールアドレス</label>
          <input type="email" id="prof-email" placeholder="example@mail.com">
        </div>
        <div class="profile-field">
          <label>電話番号</label>
          <input type="tel" id="prof-phone" placeholder="090-XXXX-XXXX">
        </div>
      </div>

      <button class="profile-save-btn" id="profile-save-btn" onclick="saveProfile()">変更を保存する</button>

      <div class="profile-section" style="margin-top: 20px;">
        <div class="profile-section-title">パスワード変更</div>
        <div class="profile-field">
          <label>新しいパスワード</label>
          <div style="position: relative;">
            <input type="password" id="prof-new-password" placeholder="6文字以上" style="padding-right: 50px;">
            <button type="button" onclick="togglePasswordVisibility('prof-new-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
          </div>
        </div>
        <div class="profile-field">
          <label>新しいパスワード（確認）</label>
          <div style="position: relative;">
            <input type="password" id="prof-new-password-confirm" placeholder="もう一度入力" style="padding-right: 50px;">
            <button type="button" onclick="togglePasswordVisibility('prof-new-password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
          </div>
        </div>
        <button class="profile-save-btn" style="margin-top: 12px; background: #34c759;" onclick="changeCustomerPassword()">パスワードを変更する</button>
      </div>

      <div class="profile-toast" id="profile-toast"></div>
    </div>
  </div>

  <!-- ===== 退会確認モーダル ===== -->
  <div class="overlay-modal" id="withdraw-modal">
    <div class="modal-inner">
      <div class="modal-inner-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div>
      <h2 class="modal-inner-title">本当に退会しますか？</h2>
      <p class="modal-inner-text">退会すると、チャット履歴を含むすべてのデータが削除されます。この操作は取り消せません。</p>
      <div class="modal-btn-row">
        <button class="modal-btn modal-btn-cancel" onclick="closeWithdrawModal()">キャンセル</button>
        <button class="modal-btn modal-btn-danger" onclick="executeWithdraw()">退会する</button>
      </div>
    </div>
  </div>

  <!-- ===== ブロック画面 ===== -->
  <div class="blocked-screen" id="blocked-screen">
    <div class="blocked-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
    <h2 class="blocked-title">ご利用いただけません</h2>
    <p class="blocked-text">このサービスは現在ご利用いただけません。<br>ご不明な点がございましたらお問い合わせください。</p>
  </div>

  <script>
    // ===== Version check =====
    console.log('[MuchiNavi v2] ページ読み込み完了 - 最新バージョン');

    // ===== State =====
    const customerData = {};
    let currentStep = 0;
    let chatMessages = [];
    let sessionToken = null;
    let selectedChoiceValue = null; // Track selected choice value for later submission
    let currentChatRoom = 'ai'; // 'ai' or 'direct'
    let directChatMessages = [];
    const TOTAL_STEPS = 14; // 0=welcome, 1=name, 2=birthdate, 3=prefecture, 4=family, 5=householdIncome, 6=propertyType, 7=purpose, 8=searchReason, 9=area, 10=budget, 11=freeComment, 12=contact, 13=password

    // Prefecture data organized by region
    const prefecturesByRegion = {
      '北海道・東北': ['北海道', '青森', '岩手', '宮城', '秋田', '山形', '福島'],
      '関東': ['茨城', '栃木', '群馬', '埼玉', '千葉', '東京', '神奈川'],
      '中部': ['新潟', '富山', '石川', '福井', '山梨', '長野', '岐阜', '静岡', '愛知'],
      '近畿': ['三重', '滋賀', '京都', '大阪', '兵庫', '奈良', '和歌山'],
      '中国・四国': ['鳥取', '島根', '岡山', '広島', '山口', '徳島', '香川', '愛媛', '高知'],
      '九州・沖縄': ['福岡', '佐賀', '長崎', '熊本', '大分', '宮崎', '鹿児島', '沖縄'],
    };

    // ===== Steps config =====
    const steps = [
      {
        type: 'welcome',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        title: 'MuchiNaviへようこそ',
        subtitle: 'AIがあなたの住まい探しをサポートします。\n簡単な質問に答えるだけで、あなた専用のアドバイザーが準備できます。',
        buttonText: 'はじめる',
      },
      {
        type: 'text',
        key: 'name',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
        title: 'お名前を教えてください',
        subtitle: '※ 本名でのご記入をお願いします（今後のやり取りで正確にサポートするため）',
        placeholder: '例: 山田太郎',
        required: true,
        response: (val) => `${val}さん、よろしくお願いします！`,
      },
      {
        type: 'birthdate',
        key: 'birthInfo',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v3"/><path d="M12 8v3"/><path d="M17 8v3"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg>',
        title: '{name}さんの生まれ年と\n生まれ月を教えてください',
        subtitle: 'ライフプランの作成に使用します',
        required: true,
        response: (val) => `ありがとうございます！`,
      },
      {
        type: 'prefecture',
        key: 'prefecture',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
        title: '{name}さんが\n今お住まいの都道府県は？',
        subtitle: '',
        required: true,
        response: (val) => `${val}にお住まいなんですね！`,
      },
      {
        type: 'choice',
        key: 'family',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        title: '{name}さんは\n誰と一緒に住む予定ですか？',
        subtitle: '',
        choices: [
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', label: 'おひとり', value: '単身' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', label: 'パートナーと', value: 'パートナーと二人' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', label: '家族で', value: '家族', hasSubQuestion: true },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', label: 'まだ決めてない', value: '未定' },
        ],
        subQuestion: {
          label: 'お子様は何人ですか？',
          type: 'choice-inline',
          options: ['1人', '2人', '3人以上'],
        },
        response: (val) => `${val}でのお住まいですね！`,
      },
      {
        type: 'choice',
        key: 'householdIncome',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        title: '{name}さんの\n世帯年収を教えてください',
        subtitle: 'ローンの目安や資金計画に活用します',
        choices: [
          { icon: '', label: '〜499万円', value: '〜499万円' },
          { icon: '', label: '500〜999万円', value: '500〜999万円' },
          { icon: '', label: '1,000〜1,499万円', value: '1,000〜1,499万円' },
          { icon: '', label: '1,500〜1,999万円', value: '1,500〜1,999万円' },
          { icon: '', label: '2,000〜2,499万円', value: '2,000〜2,499万円' },
          { icon: '', label: '2,500〜2,999万円', value: '2,500〜2,999万円' },
          { icon: '', label: '3,000万円〜', value: '3,000万円〜' },
        ],
        response: (val) => `ありがとうございます！`,
      },
      {
        type: 'choice',
        key: 'propertyType',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="16" rx="2"/><path d="M2 10h20"/><path d="M6 6V2"/><path d="M18 6V2"/><path d="M10 14h4"/><path d="M12 12v4"/></svg>',
        title: 'どんな住まいをお考えですか？',
        subtitle: '今のイメージで大丈夫です',
        choices: [
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', label: '中古戸建て', value: '中古戸建て' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><line x1="8" y1="6" x2="10" y2="6"/><line x1="14" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/></svg>', label: '中古マンション', value: '中古マンション' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/><line x1="2" y1="12" x2="7" y2="12"/><line x1="17" y1="12" x2="22" y2="12"/></svg>', label: '新築戸建て', value: '新築戸建て' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="16" rx="2"/><path d="M2 10h20"/><path d="M6 6V2"/><path d="M18 6V2"/><path d="M10 14h4"/><path d="M12 12v4"/></svg>', label: '注文住宅', value: '注文住宅' },
        ],
        response: (val) => `${val}をお探しなんですね！`,
      },
      {
        type: 'choice',
        key: 'purpose',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        title: '今回はどんなきっかけで\nご登録いただきましたか？',
        subtitle: '一番近いものをお選びください',
        choices: [
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>', label: '住まい探し全般', value: '住まい探し全般' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg>', label: '記事が参考になった', value: '記事が参考になった' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 17a4 4 0 0 0 8 0"/><path d="M5 17a4 4 0 0 0 8 0"/><path d="M2 11l4-4 4 4"/><path d="M14 7l4-4 4 4"/></svg>', label: 'ハウスメーカー紹介', value: 'ハウスメーカー紹介・割引を受けたい' },
          { icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>', label: 'とりあえず相談', value: 'とりあえず相談したい' },
        ],
        response: (val) => `なるほど、承知しました！`,
      },
      {
        type: 'textarea',
        key: 'searchReason',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        title: '{name}さんが住まいを探している\n理由を教えてください',
        subtitle: '詳しく書いていただくほど、的確なサポートができます',
        placeholder: '例: 子どもが小学校に上がるタイミングで、学区の良いエリアに引っ越したい',
        required: true,
        response: (val) => `詳しくありがとうございます！`,
      },
      {
        type: 'text',
        key: 'area',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
        title: 'どのあたりに住みたいですか？',
        subtitle: 'まだ決まっていなくても大丈夫です',
        placeholder: '例: 世田谷区、横浜市',
        skipText: 'まだ決まっていない',
        skipValue: '未定（一緒に探したい）',
        skipResponse: '大丈夫です！一緒に探しましょう',
        response: (val) => `${val}エリアですね、素敵な場所ですね！`,
      },
      {
        type: 'slider',
        key: 'budget',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
        title: 'ご予算のイメージは？',
        subtitle: 'ざっくりで大丈夫です。あとから変更もできます。',
        min: 2000,
        max: 15000,
        step: 500,
        default: 5000,
        format: (val) => {
          if (val >= 10000) return `${(val/10000).toFixed(1)}億円`;
          return `${val.toLocaleString()}万円`;
        },
        skipText: 'まだわからない',
        skipValue: '未定',
        skipResponse: '全然OKです！これから一緒に考えましょう',
        response: (val) => `了解です！ぴったりの物件を探しましょう`,
      },
      {
        type: 'textarea',
        key: 'freeComment',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        title: '最後に、何か気になることや\nご要望があればお聞かせください',
        subtitle: '何でもOKです！空白のまま進むこともできます',
        placeholder: '例: 駅近がいい、ペット可の物件が希望、予算内で最大限の広さがほしい…など',
        required: false,
        skipText: '特にないので次へ',
        skipValue: '',
        skipResponse: '了解です！',
        response: (val) => `ありがとうございます！しっかり参考にさせていただきます`,
      },
      {
        type: 'contact',
        key: 'contact',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
        title: '連絡先を教えてください',
        subtitle: '個人チャットの通知や、重要なご連絡に使用します。\n情報は厳重に管理しますのでご安心ください。',
        response: () => '次へ進みます！',
      },
      {
        type: 'password',
        key: 'password',
        icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
        title: 'パスワードを設定してください',
        subtitle: '他の端末からもログインできるようになります',
        required: true,
        response: () => '設定完了！',
      },
    ];

    // ===== Render step =====
    function renderStep(stepIdx) {
      const step = steps[stepIdx];
      const card = document.getElementById('step-card');
      const progress = document.getElementById('progress');

      // Show progress from step 1
      if (stepIdx > 0) {
        progress.style.display = 'block';
        renderProgress(stepIdx);
      }

      // Replace title template
      let title = step.title;
      if (customerData.name) {
        title = title.replace('{name}', customerData.name);
      }
      let subtitle = step.subtitle || '';

      // Back button (appended after action buttons, not on welcome step 0)
      let backButtonHTML = '';
      if (stepIdx > 0) {
        backButtonHTML = `<div style="margin-top: 12px;"><button class="back-button" onclick="prevStep()">← 戻る</button></div>`;
      }

      let html = `
        <div class="step-icon">${step.icon}</div>
        <h2 class="step-title">${title.replace(/\n/g, '<br>')}</h2>
        ${subtitle ? `<p class="step-subtitle">${subtitle.replace(/\n/g, '<br>')}</p>` : ''}
      `;

      if (step.type === 'welcome') {
        html += `<button class="btn-primary" onclick="nextStep()">${step.buttonText}</button>`;
        html += `
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">すでにアカウントをお持ちの方</p>
            <button class="btn-login" onclick="showLoginForm()">ログイン</button>
          </div>
        `;
      }
      else if (step.type === 'text') {
        const prefillValue = step.key && customerData[step.key] ? customerData[step.key] : '';
        html += `
          <input class="input-field" type="text" id="step-input"
            placeholder="${step.placeholder || ''}"
            value="${prefillValue}"
            onkeypress="if(event.key==='Enter' && this.value.trim())nextStep(this.value.trim())">
          <div style="margin-top: 16px;">
            <button class="btn-primary" onclick="submitTextStep()" id="next-btn">次へ →</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'textarea') {
        const prefillValue = step.key && customerData[step.key] ? customerData[step.key] : '';
        html += `
          <textarea class="input-field" id="step-input"
            placeholder="${step.placeholder || ''}"
            rows="4"
            style="resize: vertical; min-height: 100px; font-family: inherit; line-height: 1.6;">${prefillValue}</textarea>
          <div style="margin-top: 16px;">
            <button class="btn-primary" onclick="submitTextStep()" id="next-btn">次へ →</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'choice') {
        html += `<div class="choices">`;
        step.choices.forEach((c, i) => {
          const isSelected = selectedChoiceValue === c.value;
          const selectedClass = isSelected ? 'selected' : '';
          html += `
            <div class="choice-card ${selectedClass}" onclick="selectChoice(${i}, '${c.value}', ${!!c.hasSubQuestion})">
              <div class="choice-icon">${c.icon}</div>
              <div class="choice-label">${c.label}</div>
            </div>
          `;
        });
        html += `</div>`;
        html += `<div id="sub-question-area"></div>`;
        const btnShowClass = selectedChoiceValue !== null ? 'show' : '';
        html += `<button class="next-choice-btn ${btnShowClass}" id="next-choice-btn" onclick="submitChoiceStep()">次へ →</button>`;
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'birthdate') {
        const currentYear = new Date().getFullYear();
        let yearOptions = '';
        for (let y = 2010; y >= 1950; y--) {
          const selected = customerData.birthYear === y ? 'selected' : '';
          yearOptions += `<option value="${y}" ${selected}>${y}年</option>`;
        }
        let monthOptions = '';
        for (let m = 1; m <= 12; m++) {
          const selected = customerData.birthMonth === m ? 'selected' : '';
          monthOptions += `<option value="${m}" ${selected}>${m}月</option>`;
        }
        html += `
          <div class="birthdate-container">
            <div class="birthdate-selector">
              <label>生まれ年</label>
              <select id="birth-year" onchange="validateBirthdate()">
                <option value="">選択してください</option>
                ${yearOptions}
              </select>
            </div>
            <div class="birthdate-selector">
              <label>生まれ月</label>
              <select id="birth-month" onchange="validateBirthdate()">
                <option value="">選択してください</option>
                ${monthOptions}
              </select>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-primary" id="submit-birthdate-btn" onclick="submitBirthdate()" disabled>次へ →</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'prefecture') {
        let prefectureHTML = '';
        for (const [region, prefs] of Object.entries(prefecturesByRegion)) {
          prefectureHTML += `<div class="prefecture-region-header">${region}</div>`;
          prefs.forEach(pref => {
            const selected = customerData.prefecture === pref ? 'selected' : '';
            prefectureHTML += `<button class="prefecture-btn ${selected}" onclick="selectPrefecture('${pref}', event)">${pref}</button>`;
          });
        }
        html += `
          <div class="prefecture-grid">
            ${prefectureHTML}
          </div>
          <button class="next-choice-btn" id="next-prefecture-btn" onclick="submitPrefectureStep()" style="display: ${customerData.prefecture ? 'inline-flex' : 'none'};">次へ →</button>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'slider') {
        // Try to restore previous budget value from customerData
        let sliderValue = step.default;
        if (step.key && customerData[step.key]) {
          // Extract the numeric value from the formatted budget string
          const budgetStr = customerData[step.key];
          const numMatch = budgetStr.match(/(\d+)/);
          if (numMatch) {
            sliderValue = parseInt(numMatch[1]) * 500; // Assuming 500 step
          }
        }
        html += `
          <div class="slider-container">
            <div class="budget-display" id="budget-display">${step.format(sliderValue)}</div>
            <input type="range" id="budget-slider"
              min="${step.min}" max="${step.max}" step="${step.step}" value="${sliderValue}"
              oninput="updateBudget(this.value)">
            <div class="slider-labels">
              <span>${step.format(step.min)}</span>
              <span>${step.format(step.max)}〜</span>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-primary" onclick="submitSlider()">次へ →</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'contact') {
        html += `
          <div style="text-align: left; display: flex; flex-direction: column; gap: 14px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">メールアドレス <span style="color: var(--danger);">*</span></label>
              <input class="input-field" type="email" id="contact-email" placeholder="example@email.com" style="text-align: left;">
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">電話番号（任意）</label>
              <input class="input-field" type="tel" id="contact-phone" placeholder="090-xxxx-xxxx" style="text-align: left;">
            </div>
          </div>
          <div style="margin-top: 24px;">
            <button class="btn-primary" onclick="submitContact()">次へ →</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'password') {
        html += `
          <div style="text-align: left; display: flex; flex-direction: column; gap: 14px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">パスワード <span style="color: var(--danger);">*</span></label>
              <div style="position: relative;">
                <input class="input-field" type="password" id="password-input" placeholder="6文字以上" style="text-align: left; padding-right: 50px;">
                <button type="button" onclick="togglePasswordVisibility('password-input', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
              </div>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">パスワード（確認） <span style="color: var(--danger);">*</span></label>
              <div style="position: relative;">
                <input class="input-field" type="password" id="password-confirm" placeholder="もう一度入力" style="text-align: left; padding-right: 50px;">
                <button type="button" onclick="togglePasswordVisibility('password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">表示</button>
              </div>
            </div>
            <p style="font-size: 11px; color: var(--text-light); margin-top: 4px;">
              ※ メールアドレスとこのパスワードで、どの端末からでもログインできます
            </p>
          </div>
          <div style="margin-top: 24px;">
            <button class="btn-primary" onclick="submitPassword()">登録する</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }

      // Append back button at the bottom (after all action buttons)
      html += backButtonHTML;

      // Animate transition
      card.classList.add('leaving');
      setTimeout(() => {
        card.classList.remove('leaving');
        card.innerHTML = html;
        card.style.animation = 'none';
        card.offsetHeight; // trigger reflow
        card.style.animation = '';

        // Focus input
        const input = document.getElementById('step-input');
        if (input) setTimeout(() => input.focus(), 300);
      }, 250);
    }

    function renderProgress(stepIdx) {
      const dots = document.getElementById('progress-dots');
      const label = document.getElementById('progress-label');
      let html = '';
      for (let i = 1; i < TOTAL_STEPS; i++) {
        let cls = 'progress-dot';
        if (i < stepIdx) cls += ' done';
        else if (i === stepIdx) cls += ' active';
        html += `<div class="${cls}"></div>`;
      }
      dots.innerHTML = html;
      label.textContent = `ステップ ${stepIdx} / ${TOTAL_STEPS - 1}`;
    }

    // ===== Step handlers =====
    function nextStep(value) {
      const step = steps[currentStep];
      if (value !== undefined && step.key) {
        customerData[step.key] = value;
      }

      // Show response if exists
      if (step.response && value !== undefined) {
        showResponse(step.response(value));
        setTimeout(() => {
          currentStep++;
          if (currentStep < TOTAL_STEPS) {
            renderStep(currentStep);
          } else {
            showCompletion();
          }
        }, 1200);
      } else {
        currentStep++;
        if (currentStep < TOTAL_STEPS) {
          renderStep(currentStep);
        } else {
          showCompletion();
        }
      }
    }

    function submitTextStep() {
      const input = document.getElementById('step-input');
      const val = input.value.trim();
      if (!val) {
        input.style.borderColor = 'var(--danger)';
        input.focus();
        return;
      }
      nextStep(val);
    }

    function skipStep() {
      const step = steps[currentStep];
      customerData[step.key] = step.skipValue;
      showResponse(step.skipResponse);
      setTimeout(() => {
        currentStep++;
        renderStep(currentStep);
      }, 1200);
    }

    function selectChoice(idx, value, hasSub) {
      // Highlight selected
      document.querySelectorAll('.choice-card').forEach((c, i) => {
        c.classList.toggle('selected', i === idx);
      });

      if (hasSub) {
        const step = steps[currentStep];
        const area = document.getElementById('sub-question-area');
        selectedChoiceValue = value; // Store the value with sub-question
        area.innerHTML = `
          <div class="sub-question">
            <label>${step.subQuestion.label}</label>
            <div style="display: flex; gap: 8px; justify-content: center;">
              ${step.subQuestion.options.map(opt =>
                `<button class="chat-hint" onclick="submitChoiceWithSub('${value}', '${opt}')" style="font-size: 14px; padding: 10px 18px;">${opt}</button>`
              ).join('')}
            </div>
          </div>
        `;
        // Show next button after sub-question appears
        const nextBtn = document.getElementById('next-choice-btn');
        if (nextBtn) {
          setTimeout(() => nextBtn.classList.add('show'), 100);
        }
      } else {
        // No sub-question: store value and show next button
        selectedChoiceValue = value;
        const nextBtn = document.getElementById('next-choice-btn');
        if (nextBtn) {
          nextBtn.classList.add('show');
        }
      }
    }

    function submitChoiceStep() {
      if (selectedChoiceValue !== null) {
        nextStep(selectedChoiceValue);
        selectedChoiceValue = null;
      }
    }

    function submitChoiceWithSub(mainVal, subVal) {
      nextStep(`${mainVal}（子ども${subVal}）`);
      selectedChoiceValue = null;
    }

    function validateBirthdate() {
      const yearSelect = document.getElementById('birth-year');
      const monthSelect = document.getElementById('birth-month');
      const submitBtn = document.getElementById('submit-birthdate-btn');
      const year = yearSelect.value;
      const month = monthSelect.value;

      if (year && month) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
    }

    function submitBirthdate() {
      const year = parseInt(document.getElementById('birth-year').value);
      const month = parseInt(document.getElementById('birth-month').value);

      if (!year || !month) {
        return;
      }

      // Calculate age
      const today = new Date();
      let age = today.getFullYear() - year;
      if (today.getMonth() < month - 1 || (today.getMonth() === month - 1 && today.getDate() < 1)) {
        age--;
      }

      customerData.birthYear = year;
      customerData.birthMonth = month;
      customerData.age = age;

      nextStep(`${year}年${month}月生まれ`);
    }

    function selectPrefecture(prefName, evt) {
      // Unselect all, select this one
      document.querySelectorAll('.prefecture-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      if (evt && evt.target) {
        evt.target.classList.add('selected');
      }
      customerData.prefecture = prefName;

      // Show next button
      const nextBtn = document.getElementById('next-prefecture-btn');
      if (nextBtn) {
        nextBtn.style.display = 'inline-flex';
        setTimeout(() => nextBtn.classList.add('show'), 50);
      }
    }

    function submitPrefectureStep() {
      if (customerData.prefecture) {
        nextStep(customerData.prefecture);
      }
    }

    function prevStep() {
      // Go back one step
      if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
      }
    }

    function updateBudget(val) {
      const step = steps[currentStep];
      document.getElementById('budget-display').textContent = step.format(parseInt(val));
    }

    function submitSlider() {
      const step = steps[currentStep];
      const val = document.getElementById('budget-slider').value;
      nextStep(step.format(parseInt(val)));
    }

    function submitContact() {
      const email = document.getElementById('contact-email').value.trim();
      const phone = document.getElementById('contact-phone').value.trim();

      if (!email || !email.includes('@')) {
        document.getElementById('contact-email').style.borderColor = 'var(--danger)';
        document.getElementById('contact-email').focus();
        return;
      }

      customerData.email = email;
      customerData.phone = phone || '未入力';
      nextStep('contact-done');
    }

    function submitPassword() {
      const pw = document.getElementById('password-input').value;
      const pwConfirm = document.getElementById('password-confirm').value;

      if (!pw || pw.length < 6) {
        document.getElementById('password-input').style.borderColor = 'var(--danger)';
        document.getElementById('password-input').focus();
        return;
      }
      if (pw !== pwConfirm) {
        document.getElementById('password-confirm').style.borderColor = 'var(--danger)';
        document.getElementById('password-confirm').focus();
        return;
      }

      customerData.password = pw;
      // パスワード自体を value として渡す（nextStepでstep.key='password'にpwが入る＝上書きされても同じ値）
      nextStep(pw);
    }

    function showResponse(text) {
      const el = document.getElementById('step-response');
      if (el) {
        el.textContent = text;
        setTimeout(() => el.classList.add('show'), 50);
      }
    }

    // ===== Login Functions =====
    function showLoginForm() {
      document.getElementById('login-screen').classList.add('active');
      setTimeout(() => document.getElementById('login-email').focus(), 100);
    }

    function hideLoginForm() {
      document.getElementById('login-screen').classList.remove('active');
      document.getElementById('login-error').style.display = 'none';
    }

    // ===== パスワード表示切替 =====
    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = '非表示';
      } else {
        input.type = 'password';
        btn.textContent = '表示';
      }
    }

    // ===== リセットフォーム表示切替 =====
    function showResetForm() {
      document.getElementById('login-form-card').style.display = 'none';
      document.getElementById('reset-form-card').style.display = '';
      document.getElementById('reset-email').value = '';
      document.getElementById('reset-error').style.display = 'none';
      document.getElementById('reset-success').style.display = 'none';
      document.getElementById('reset-password-section').style.display = 'none';
      document.getElementById('reset-btn').textContent = 'メールアドレスを確認';
      document.getElementById('reset-btn').onclick = doVerifyEmail;
      setTimeout(() => document.getElementById('reset-email').focus(), 100);
    }

    function showLoginCard() {
      document.getElementById('reset-form-card').style.display = 'none';
      document.getElementById('login-form-card').style.display = '';
      document.getElementById('login-error').style.display = 'none';
      setTimeout(() => document.getElementById('login-email').focus(), 100);
    }

    // ===== メール確認 → パスワードリセット =====
    async function doVerifyEmail() {
      const email = document.getElementById('reset-email').value.trim();
      const errorDiv = document.getElementById('reset-error');
      const successDiv = document.getElementById('reset-success');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!email) {
        errorDiv.textContent = 'メールアドレスを入力してください';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        const data = await res.json();

        if (!res.ok || !data.verified) {
          errorDiv.textContent = data.error || '確認に失敗しました';
          errorDiv.style.display = 'block';
          return;
        }

        // メール確認成功 → パスワード入力欄を表示
        successDiv.textContent = 'メールアドレスが確認できました。新しいパスワードを設定してください。';
        successDiv.style.display = 'block';
        document.getElementById('reset-password-section').style.display = '';
        document.getElementById('reset-email').disabled = true;
        document.getElementById('reset-btn').textContent = 'パスワードを再設定する';
        document.getElementById('reset-btn').onclick = doResetPassword;
        setTimeout(() => document.getElementById('reset-new-password').focus(), 100);
      } catch (e) {
        errorDiv.textContent = 'ネットワークエラーが発生しました';
        errorDiv.style.display = 'block';
      }
    }

    async function doResetPassword() {
      const email = document.getElementById('reset-email').value.trim();
      const pw = document.getElementById('reset-new-password').value;
      const pwConfirm = document.getElementById('reset-new-password-confirm').value;
      const errorDiv = document.getElementById('reset-error');
      const successDiv = document.getElementById('reset-success');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!pw || pw.length < 6) {
        errorDiv.textContent = 'パスワードは6文字以上で入力してください';
        errorDiv.style.display = 'block';
        return;
      }
      if (pw !== pwConfirm) {
        errorDiv.textContent = 'パスワードが一致しません';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: pw }),
        });
        const data = await res.json();

        if (!res.ok || !data.reset) {
          errorDiv.textContent = data.error || '再設定に失敗しました';
          errorDiv.style.display = 'block';
          return;
        }

        successDiv.textContent = 'パスワードを再設定しました！ログイン画面に戻ってログインしてください。';
        successDiv.style.display = 'block';
        document.getElementById('reset-btn').style.display = 'none';
        setTimeout(() => showLoginCard(), 2500);
      } catch (e) {
        errorDiv.textContent = 'ネットワークエラーが発生しました';
        errorDiv.style.display = 'block';
      }
    }

    async function doLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');

      if (!email) {
        errorDiv.textContent = 'メールアドレスを入力してください';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: password || '' }),
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          errorDiv.textContent = data.error || 'ログインに失敗しました';
          errorDiv.style.display = 'block';
          return;
        }

        // Login success
        sessionToken = data.token;
        localStorage.setItem('muchinavi_token', sessionToken);
        history.replaceState(null, '', `?t=${sessionToken}`);
        Object.assign(customerData, data.customer);
        chatMessages = data.chatHistory || [];
        directChatMessages = data.directChatHistory || [];

        hideLoginForm();
        startChat();

        // パスワード未設定の場合、マイページを開いてパスワード設定を促す
        if (data.needsPassword) {
          setTimeout(() => {
            openProfile();
            showProfileToast('セキュリティのため、パスワードを設定してください', 'error');
          }, 500);
        }
      } catch (e) {
        errorDiv.textContent = 'ネットワークエラーが発生しました';
        errorDiv.style.display = 'block';
      }
    }

    // ===== Completion =====
    function showCompletion() {
      document.getElementById('progress').style.display = 'none';
      const card = document.getElementById('step-card');
      card.classList.add('leaving');

      setTimeout(() => {
        card.classList.remove('leaving');
        card.innerHTML = `
          <div class="completion-check">
            <svg viewBox="0 0 24 24"><polyline points="4 12 10 18 20 6"></polyline></svg>
          </div>
          <h2 class="step-title">登録完了！</h2>
          <p class="step-subtitle">
            ${customerData.name}さん専用の<br>AIアシスタントが準備できました
          </p>
          <button class="btn-primary" onclick="startChat()" style="margin-top: 8px;">
            MuchiNaviに相談する
          </button>
          <p style="font-size: 11px; color: var(--text-light); margin-top: 16px;">
            岡本から直接ご連絡させていただきます
          </p>
        `;
        card.style.animation = 'none';
        card.offsetHeight;
        card.style.animation = '';

        // Send notification to agent
        notifyAgent();
      }, 250);
    }

    // ===== Notify Agent & Save =====
    async function notifyAgent() {
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customerData),
        });
        const data = await res.json();
        if (data.token) {
          sessionToken = data.token;
          // Save token to localStorage AND update URL
          localStorage.setItem('muchinavi_token', sessionToken);
          history.replaceState(null, '', `?t=${sessionToken}`);
        }
      } catch (e) {
        console.error('通知送信エラー:', e);
      }
    }

    // ===== Chat =====
    function startChat() {
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('chat-screen').classList.add('active');
      document.getElementById('chat-customer-name').textContent =
        `${customerData.name}さんの住まい相談`;

      // Restore chat history if any
      if (chatMessages.length > 0) {
        document.getElementById('chat-welcome').style.display = 'none';
        renderChatMessages();
      }

      // Load and render progress bar
      loadProgressBar();

      // ヘッダー自動縮小を有効化
      setTimeout(setupCompactHeader, 100);

      document.getElementById('chat-input').focus();
    }

    // ===== Progress Bar =====
    const STAGE_LABELS = ['登録', '情報入力', '面談予約', '相談中', 'ライフプラン', '物件探し・内見', '契約', '引渡し'];
    const STAGE_ICONS = [
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
    ];

    async function loadProgressBar() {
      // まず即座にデフォルト表示（フリーズ防止）
      renderProgressBar(1, {});
      try {
        const token = sessionToken || customerData.token || localStorage.getItem('muchinavi_token');
        if (!token) return;
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);
        const res = await fetch(`/api/customer/profile/${token}`, { signal: controller.signal });
        clearTimeout(timeout);
        const data = await res.json();
        const stage = data.profile?.stage || 1;
        const profile = data.profile || {};
        renderProgressBar(stage, profile);
      } catch(e) {
        console.error('進捗バー読み込みエラー:', e);
      }
    }

    function renderProgressBar(stage, profile) {
      profile = profile || {};
      const stepsEl = document.getElementById('progress-steps');
      const labelsEl = document.getElementById('progress-labels');
      const statusText = document.getElementById('progress-status-text');
      const statusCount = document.getElementById('progress-status-count');

      stepsEl.innerHTML = '';
      labelsEl.innerHTML = '';

      STAGE_LABELS.forEach((label, i) => {
        const stepNum = i + 1;
        const isCompleted = stepNum < stage;
        const isActive = stepNum === stage;

        // Step circle
        const step = document.createElement('div');
        step.className = 'progress-step' + (isCompleted ? ' completed' : '') + (isActive ? ' active' : '');
        if (isCompleted) step.innerHTML = STAGE_ICONS[i];
        stepsEl.appendChild(step);

        // Connecting line (except after last step)
        if (i < STAGE_LABELS.length - 1) {
          const line = document.createElement('div');
          line.className = 'progress-line' + (stepNum < stage ? ' completed' : '');
          stepsEl.appendChild(line);
        }

        // Label
        const labelEl = document.createElement('div');
        labelEl.className = 'progress-label' + (isCompleted ? ' completed' : '') + (isActive ? ' active' : '');
        labelEl.textContent = label;
        labelsEl.appendChild(labelEl);
      });

      statusText.textContent = `現在: ${STAGE_LABELS[stage - 1]}`;
      statusCount.textContent = `${stage} / ${STAGE_LABELS.length}`;

      // Mobile card view
      const mobileCard = document.getElementById('progress-mobile-card');
      const mobileMini = document.getElementById('progress-mobile-mini');
      if (mobileCard) {
        const prevLabel = stage > 1 ? STAGE_LABELS[stage - 2] : '';
        const nextLabel = stage < STAGE_LABELS.length ? STAGE_LABELS[stage] : '';
        const navHtml = `<div class="progress-card-nav">
          ${prevLabel ? `<span class="progress-card-prev">${prevLabel}</span><span class="progress-card-arrow">→</span>` : ''}
          <span style="font-size:11px;font-weight:700;color:#0071e3;">現在地</span>
          ${nextLabel ? `<span class="progress-card-arrow">→</span><span class="progress-card-next">${nextLabel}</span>` : ''}
        </div>`;
        const dotsHtml = STAGE_LABELS.map((_, i) => {
          const num = i + 1;
          if (num < stage) return '<span class="progress-card-dot completed"></span>';
          if (num === stage) return '<span class="progress-card-dot active"></span>';
          return '<span class="progress-card-dot"></span>';
        }).join('');
        mobileCard.innerHTML = `
          ${navHtml}
          <div class="progress-card-current">
            <div class="progress-card-current-label">ステップ ${stage}</div>
            <div class="progress-card-title">${STAGE_LABELS[stage - 1]}</div>
            <div class="progress-card-count">${stage} / ${STAGE_LABELS.length} ステップ完了</div>
          </div>
          <div class="progress-card-dots">${dotsHtml}</div>
        `;
      }
      if (mobileMini) {
        mobileMini.innerHTML = `
          <span class="progress-mobile-mini-dot"></span>
          <span class="progress-mobile-mini-text">${STAGE_LABELS[stage - 1]}</span>
          <span class="progress-mobile-mini-count">${stage}/${STAGE_LABELS.length}</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#aeaeb2" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        `;
      }

      // Next action guide
      const nextActionEl = document.getElementById('progress-next-action');
      // Check missing profile fields for stage 1
      const fieldLabels = {
        name: 'お名前', birthYear: '生まれ年', prefecture: '都道府県',
        family: 'ご家族構成', householdIncome: '世帯年収', propertyType: '物件種別',
        area: '希望エリア', budget: 'ご予算', email: 'メール', phone: '電話番号'
      };
      const missingFields = Object.entries(fieldLabels)
        .filter(([k]) => !profile[k] || profile[k] === '' || profile[k] === '-' || profile[k] === '未入力')
        .map(([, v]) => v);
      const filledCount = Object.keys(fieldLabels).length - missingFields.length;
      const totalFields = Object.keys(fieldLabels).length;

      const nextActions = {
        1: {
          custom_stage1: true
        },
        2: {
          custom: true
        },
        3: {
          text: '面談予約ありがとうございます！当日まで気になることがあれば、チャットでご相談ください。',
          btn: null
        },
        4: {
          text: '岡本とのオンライン相談が始まりました。住まいの希望やお悩みを何でもお話しください。',
          btn: null
        },
        5: {
          text: 'ライフプランを作成中です。将来の資金計画を一緒に考えて、無理のない住宅購入を実現しましょう。',
          btn: null
        },
        6: {
          text: '物件探し・内見を進めています。気になる物件があれば、岡本がプロの目線で同行・アドバイスします。',
          btn: null
        },
        7: {
          text: '契約手続きを進めています。必要書類やスケジュールなど、気になることがあれば聞いてください。',
          btn: null
        },
        8: {
          text: 'おめでとうございます！新しいお住まいでの生活をお楽しみください。何かあればいつでもご連絡ください。',
          btn: null
        }
      };

      const action = nextActions[stage];
      if (action && action.custom_stage1) {
        // Stage 1: show profile completion status
        if (missingFields.length === 0) {
          nextActionEl.innerHTML = `
            <div class="next-label">情報入力完了</div>
            <div class="next-text">プロフィール情報がすべて入力されています。次のステップへ進む準備ができました！</div>
          `;
        } else {
          const pct = Math.round((filledCount / totalFields) * 100);
          const missingList = missingFields.map(f => `<span style="display:inline-block;padding:2px 8px;background:rgba(255,59,48,0.08);color:#ff3b30;border-radius:10px;font-size:11px;margin:2px;">${f}</span>`).join(' ');
          nextActionEl.innerHTML = `
            <div class="next-label">Next Step — プロフィール入力 ${pct}%</div>
            <div style="background:#e5e5ea;border-radius:4px;height:6px;margin:6px 0 8px;overflow:hidden;">
              <div style="background:#0071e3;height:100%;width:${pct}%;border-radius:4px;transition:width 0.5s ease;"></div>
            </div>
            <div class="next-text">以下の項目を入力すると、より的確なアドバイスが受けられます。</div>
            <div style="margin:6px 0 8px;">${missingList}</div>
            <button class="next-btn" onclick="event.stopPropagation(); openProfile()">マイページで入力する</button>
          `;
        }
      } else if (action && action.custom) {
        // Stage 2: booking flow with two-step (book → confirm)
        const bookingClicked = sessionStorage.getItem('booking_clicked');
        if (!bookingClicked) {
          nextActionEl.innerHTML = `
            <div class="next-label">Next Step</div>
            <div class="next-text">オンライン面談を予約して、住まい探しの専門家に直接相談してみませんか？</div>
            <button class="next-btn" onclick="event.stopPropagation(); openBookingAndTrack()">オンライン面談を予約</button>
          `;
        } else {
          nextActionEl.innerHTML = `
            <div class="next-label">予約は完了しましたか？</div>
            <div class="next-text">オンライン面談の予約が完了した方は、下のボタンを押してください。</div>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="next-btn" onclick="event.stopPropagation(); confirmBooking()" style="background:#34c759;">予約しました</button>
              <button class="next-btn" onclick="event.stopPropagation(); openBookingAndTrack()" style="background:#6e6e73;">まだ予約していない</button>
            </div>
          `;
        }
      } else if (action) {
        nextActionEl.innerHTML = `
          <div class="next-label">Next Step</div>
          <div class="next-text">${action.text}</div>
          ${action.btn ? `<button class="next-btn" onclick="event.stopPropagation(); ${action.action}">${action.btn}</button>` : ''}
        `;
      }
    }

    function openBookingAndTrack() {
      sessionStorage.setItem('booking_clicked', 'true');
      const bookingBtn = document.getElementById('chat-booking-btn');
      if (bookingBtn && bookingBtn.href) {
        window.open(bookingBtn.href, '_blank');
      }
      // Re-render progress bar to show confirmation UI
      loadProgressBar();
    }

    async function confirmBooking() {
      try {
        const token = sessionToken || customerData.token || localStorage.getItem('muchinavi_token');
        if (!token) { console.error('トークンが見つかりません'); return; }
        const res = await fetch(`/api/customer/advance-stage/${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stage: 3 })
        });
        const data = await res.json();
        if (data.success) {
          sessionStorage.removeItem('booking_clicked');
          loadProgressBar();
        } else {
          console.error('ステージ更新失敗:', data);
        }
      } catch(e) {
        console.error('ステージ更新エラー:', e);
      }
    }

    function toggleProgressBar() {
      document.getElementById('progress-bar').classList.toggle('collapsed');
    }

    // ヘッダー自動縮小（startChatから呼び出し）
    let headerListenerAttached = false;
    function setupCompactHeader() {
      if (headerListenerAttached) return;
      headerListenerAttached = true;
      try {
        const msgEl = document.querySelector('.chat-messages');
        const hdr = document.querySelector('.chat-header');
        if (!msgEl || !hdr) return;
        msgEl.addEventListener('scroll', function() {
          if (msgEl.scrollTop > 30) {
            hdr.classList.add('compact');
          } else {
            hdr.classList.remove('compact');
          }
        }, { passive: true });
        hdr.addEventListener('click', function(e) {
          if (e.target.closest('.chat-header-btn') || e.target.closest('.settings-wrapper')) return;
          hdr.classList.toggle('compact');
        });
      } catch(e) { console.error('compact header error:', e); }
    }

    function sendHint(text) {
      document.getElementById('chat-input').value = text;
      sendMessage();
    }

    async function sendMessage() {
      console.log('[MuchiNavi v2] sendMessage called, isSending:', isSending);
      if (isSending) { console.log('[MuchiNavi] blocked: isSending is true'); return; }

      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) { console.log('[MuchiNavi] blocked: empty text'); return; }

      isSending = true;
      console.log('[MuchiNavi] sending:', text);

      // Hide welcome (may not exist if session restored)
      const welcomeEl = document.getElementById('chat-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';

      // Add user message
      chatMessages.push({ role: 'user', content: text });
      renderChatMessages();
      input.value = '';
      input.style.height = 'auto';
      input.focus();

      // Show typing indicator
      showTyping();

      // Disable send
      document.getElementById('chat-send-btn').disabled = true;

      try {
        console.log('[MuchiNavi] fetching /api/chat...');
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000);

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer: customerData,
            messages: chatMessages,
            token: sessionToken,
          }),
          signal: controller.signal,
        });
        clearTimeout(timeout);
        console.log('[MuchiNavi] response status:', res.status);
        const data = await res.json();
        console.log('[MuchiNavi] response data:', data);
        hideTyping();

        if (data.error) {
          chatMessages.push({ role: 'assistant', content: data.error });
        } else {
          chatMessages.push({ role: 'assistant', content: data.reply });
        }
        renderChatMessages();
      } catch (e) {
        console.error('[MuchiNavi] fetch error:', e);
        hideTyping();
        const msg = e.name === 'AbortError'
          ? '回答の生成に時間がかかっています。もう一度お試しください。'
          : 'ネットワークエラーが発生しました。再度お試しください。';
        chatMessages.push({ role: 'assistant', content: msg });
        renderChatMessages();
      }

      document.getElementById('chat-send-btn').disabled = false;
      isSending = false;
    }

    function switchChatRoom(room) {
      currentChatRoom = room;

      // Toggle tab active state
      document.getElementById('tab-ai').classList.toggle('active', room === 'ai');
      document.getElementById('tab-direct').classList.toggle('active', room === 'direct');

      // Toggle message containers
      document.getElementById('chat-messages').style.display = room === 'ai' ? 'flex' : 'none';
      document.getElementById('ai-chat-input-bar').style.display = room === 'ai' ? 'flex' : 'none';
      document.getElementById('direct-chat-messages').style.display = room === 'direct' ? 'flex' : 'none';
      document.getElementById('direct-chat-input-bar').style.display = room === 'direct' ? 'flex' : 'none';

      // Clear badge
      document.getElementById(`badge-${room}`).classList.remove('show');

      if (room === 'direct') {
        renderDirectMessages();
        scrollDirectChat();
      }
    }

    function renderDirectMessages() {
      const container = document.getElementById('direct-chat-messages');
      const welcome = document.getElementById('direct-chat-welcome');

      if (directChatMessages.length === 0) {
        // Show welcome, clear any rendered messages except welcome
        container.innerHTML = '';
        const welcomeClone = welcome.cloneNode(true);
        container.appendChild(welcomeClone);
        return;
      }

      // Build messages HTML (LINE風: 自分が右、エージェントが左)
      let html = '';
      directChatMessages.forEach(msg => {
        const isUser = msg.role === 'user';
        const side = isUser ? 'user' : 'assistant';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : '';
        html += `<div class="chat-message ${side}">
          <div class="chat-bubble direct-${side}">
            ${isUser ? '' : '<div style="font-size:10px;font-weight:600;color:#34c759;margin-bottom:4px;">担当エージェント</div>'}
            <div style="white-space:pre-wrap;">${msg.content}</div>
            ${time ? `<div style="font-size:10px;color:${isUser ? 'rgba(255,255,255,0.6)' : '#aeaeb2'};margin-top:4px;text-align:${isUser?'right':'left'}">${time}</div>` : ''}
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function scrollDirectChat() {
      const el = document.getElementById('direct-chat-messages');
      setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
    }

    async function sendDirectMessage() {
      const input = document.getElementById('direct-chat-input');
      const text = input.value.trim();
      if (!text) return;

      const msg = { role: 'user', content: text, timestamp: new Date().toISOString() };
      directChatMessages.push(msg);
      renderDirectMessages();
      scrollDirectChat();
      input.value = '';
      input.style.height = 'auto';
      input.focus();

      // Save to server
      try {
        await fetch(`/api/direct-chat-history/${sessionToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: directChatMessages }),
        });
      } catch (e) {
        console.error('Direct chat save error:', e);
      }
    }

    // Poll for new direct messages every 15 seconds
    setInterval(async () => {
      if (!sessionToken) return;
      try {
        const res = await fetch(`/api/session/${sessionToken}`);
        const data = await res.json();
        if (data.directChatHistory && data.directChatHistory.length > directChatMessages.length) {
          directChatMessages = data.directChatHistory;
          if (currentChatRoom === 'direct') {
            renderDirectMessages();
            scrollDirectChat();
          } else {
            // Show badge on direct tab
            document.getElementById('badge-direct').classList.add('show');
          }
        }
      } catch (e) {}
    }, 15000);

    // TimeRex URL (injected from server config)
    let timerexURL = '';
    fetch('/api/config').then(r => r.json()).then(d => { timerexURL = d.timerexURL || ''; updateBookingButton(); }).catch(() => {});

    function updateBookingButton() {
      const btn = document.getElementById('chat-booking-btn');
      if (btn && timerexURL) {
        btn.href = timerexURL;
        btn.style.display = 'inline-flex';
      } else if (btn) {
        btn.style.display = 'none';
      }
    }

    function formatContent(text) {
      if (!text) return '';

      // Extract article tags before HTML escaping
      const articles = [];
      text = text.replace(/\{\{ARTICLE\|(.+?)\|(.+?)\}\}/g, (_, title, url) => {
        articles.push({ title, url });
        return `__ARTICLE_${articles.length - 1}__`;
      });

      // Extract choice chips
      const choiceSets = [];
      text = text.replace(/\{\{CHOICES\|(.+?)\}\}/g, (_, choicesStr) => {
        const options = choicesStr.split('|').map(s => s.trim()).filter(Boolean);
        choiceSets.push(options);
        return `__CHOICES_${choiceSets.length - 1}__`;
      });

      // Extract TERASS Picks tags
      let terassPicksInfo = null;
      text = text.replace(/\{\{TERASS_PICKS\|(.+?)\|(.+?)\}\}/g, (_, desc, cta) => {
        terassPicksInfo = { desc, cta };
        return '__TERASS_PICKS__';
      });

      // Extract booking tags
      let bookingURL = '';
      text = text.replace(/\{\{BOOKING\|(.+?)\}\}/g, (_, url) => {
        bookingURL = url;
        return '__BOOKING__';
      });

      let html = text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/【(.+?)】/g, '<strong>【$1】</strong>')
        .replace(/^[\-•]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/^\d+[\.\)]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
        .replace(/\n\n+/g, '</p><p>')
        .replace(/\n/g, '<br>');
      html = '<p>' + html + '</p>';
      html = html.replace(/<p>\s*<\/p>/g, '').replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');

      // Replace article placeholders with cards (use <span> to avoid <p>/<div> nesting issues)
      articles.forEach((a, i) => {
        const card = `</p><a class="article-card" href="${a.url}" target="_blank" rel="noopener"><span class="article-card-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></span><span class="article-card-content"><span class="article-card-label">おすすめ記事</span><span class="article-card-title">${a.title}</span></span><span class="article-card-arrow">→</span></a><p>`;
        html = html.replace(`__ARTICLE_${i}__`, card);
      });

      // Replace booking placeholder with card
      if (bookingURL) {
        const card = `</p><a class="booking-card" href="${bookingURL}" target="_blank" rel="noopener"><span class="booking-card-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span class="booking-card-content"><span class="booking-card-label">無料相談</span><span class="booking-card-title">岡本とオンライン面談</span><span class="booking-card-sub">ご都合のいい日時を選べます</span></span><span class="booking-card-arrow">→</span></a><p>`;
        html = html.replace('__BOOKING__', card);
      }

      // Replace TERASS Picks placeholder with card
      if (terassPicksInfo) {
        const card = `</p><div style="background: linear-gradient(135deg, #f0f7ff, #e8f4f8); border: 1px solid #b3d4fc; border-radius: 16px; padding: 20px; margin: 12px 0;"><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;"><span><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span><strong style="color: #0071e3; font-size: 15px;">TERASS Picks</strong></div><p style="font-size: 14px; line-height: 1.7; color: #333; margin: 0 0 12px 0;">${terassPicksInfo.desc}</p><p style="font-size: 13px; color: #666; margin: 0;">${terassPicksInfo.cta}</p></div><p>`;
        html = html.replace('__TERASS_PICKS__', card);
      }

      // Replace choice chip placeholders
      choiceSets.forEach((options, i) => {
        const chips = `</p><div class="chat-choices" data-choice-set="${i}">${options.map(opt => `<button class="chat-choice-chip" onclick="selectChatChoice(this, '${opt.replace(/'/g, "\\'")}')">${opt}</button>`).join('')}</div><p>`;
        html = html.replace(`__CHOICES_${i}__`, chips);
      });

      // Clean up empty <p> tags and stray <br> around cards
      html = html.replace(/<p>\s*<\/p>/g, '');
      html = html.replace(/<br>\s*(<a class="article-card)/g, '$1');
      html = html.replace(/<br>\s*(<a class="booking-card)/g, '$1');
      html = html.replace(/<br>\s*(<div class="chat-choices)/g, '$1');
      html = html.replace(/<br>\s*(<div style="background: linear-gradient)/g, '$1');
      html = html.replace(/(<\/a>)\s*<br>/g, '$1');
      html = html.replace(/(<\/div>)\s*<br>/g, '$1');

      return html;
    }

    let isSending = false; // 二重送信防止

    // ===== textarea 自動高さ調整 & キーハンドラ =====
    function setupChatTextarea(textareaId, sendFunction) {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;

      // 自動高さ調整
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // PC: Enter = 改行（デフォルト動作）、Shift+Enter = 送信
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          sendFunction();
        }
      });
    }

    // DOM読み込み後にセットアップ
    document.addEventListener('DOMContentLoaded', function() {
      setupChatTextarea('chat-input', sendMessage);
      setupChatTextarea('direct-chat-input', sendDirectMessage);
    });

    function selectChatChoice(btn, text) {
      if (isSending) return; // 送信中なら無視

      // 全チップを無効化
      const container = btn.closest('.chat-choices');
      if (container) {
        container.querySelectorAll('.chat-choice-chip').forEach(chip => {
          chip.classList.add('used');
          chip.onclick = null;
        });
        btn.classList.remove('used');
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
      }

      // 直接メッセージを送信（inputを経由しない）
      sendChoiceMessage(text);
    }

    async function sendChoiceMessage(text) {
      if (isSending || !text) return;
      isSending = true;

      // Hide welcome (may not exist if session restored)
      const welcomeEl = document.getElementById('chat-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';
      chatMessages.push({ role: 'user', content: text });
      renderChatMessages();
      document.getElementById('chat-input').value = '';
      showTyping();
      document.getElementById('chat-send-btn').disabled = true;

      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000);

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer: customerData,
            messages: chatMessages,
            token: sessionToken,
          }),
          signal: controller.signal,
        });
        clearTimeout(timeout);
        const data = await res.json();
        hideTyping();
        if (data.error) {
          chatMessages.push({ role: 'assistant', content: data.error });
        } else {
          chatMessages.push({ role: 'assistant', content: data.reply });
        }
        renderChatMessages();
      } catch (e) {
        hideTyping();
        const msg = e.name === 'AbortError'
          ? '回答の生成に時間がかかっています。もう一度お試しください。'
          : 'ネットワークエラーが発生しました。再度お試しください。';
        chatMessages.push({ role: 'assistant', content: msg });
        renderChatMessages();
      }

      document.getElementById('chat-send-btn').disabled = false;
      isSending = false;
    }

    function renderChatMessages() {
      const container = document.getElementById('chat-messages');
      container.innerHTML = chatMessages.map((m, idx) => {
        if (m.role === 'user') {
          const escaped = m.content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div class="chat-message user"><div class="chat-bubble" style="white-space:pre-wrap;">${escaped}</div></div>`;
        }
        // AI message - check if the NEXT message is a user picking a choice
        const nextMsg = chatMessages[idx + 1];
        let content = formatContent(m.content);

        // If next user message exists and this AI message had choices, mark them as used
        if (nextMsg && nextMsg.role === 'user' && content.includes('chat-choices')) {
          const selectedText = nextMsg.content;
          // Disable all chips and highlight the selected one
          content = content.replace(/class="chat-choice-chip"/g, 'class="chat-choice-chip used" disabled');
          content = content.replace(
            new RegExp(`class="chat-choice-chip used" disabled>` + selectedText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + `<`),
            `class="chat-choice-chip" style="background:var(--accent);color:white;border-color:var(--accent);pointer-events:none">${selectedText}<`
          );
          // Remove onclick from all chips in this message
          content = content.replace(/onclick="selectChatChoice\([^"]*\)"/g, '');
        }

        return `<div class="chat-message assistant"><div class="chat-bubble">${content}</div></div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('chat-messages');
      const el = document.createElement('div');
      el.id = 'typing';
      el.className = 'chat-message assistant';
      el.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById('typing');
      if (el) el.remove();
    }

    // ===== Init: Check for existing session =====
    async function init() {
      // Check URL param first, then localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromURL = urlParams.get('t');
      const tokenFromStorage = localStorage.getItem('muchinavi_token');
      const token = tokenFromURL || tokenFromStorage;
      const withdrawParam = urlParams.get('withdraw');

      if (token) {
        try {
          const res = await fetch(`/api/session/${token}`);
          const data = await res.json();

          // ブロック済み
          if (data.found && data.blocked) {
            localStorage.removeItem('muchinavi_token');
            showBlockedScreen();
            return;
          }

          if (data.found) {
            // Restore session
            sessionToken = token;
            localStorage.setItem('muchinavi_token', token);
            history.replaceState(null, '', `?t=${token}`);

            // Restore customer data
            Object.assign(customerData, data.customer);
            chatMessages = data.chatHistory || [];
            if (data.directChatHistory && data.directChatHistory.length > 0) {
              directChatMessages = data.directChatHistory;
            }

            // URLに withdraw=true がある場合は退会確認を表示
            if (withdrawParam === 'true') {
              startChat();
              showWithdrawModal();
              return;
            }

            // Skip onboarding, go to chat
            startChat();
            return;
          }
        } catch (e) {
          console.error('セッション復元エラー:', e);
        }
      }

      // No session found — show onboarding
      renderStep(0);
    }

    // ===== Settings menu =====
    function toggleSettings(event) {
      event.stopPropagation();
      const dd = document.getElementById('settings-dropdown');
      dd.classList.toggle('show');
    }
    // Close dropdown when clicking elsewhere
    document.addEventListener('click', () => {
      document.getElementById('settings-dropdown').classList.remove('show');
    });

    // ===== Logout =====
    function doLogout() {
      document.getElementById('settings-dropdown').classList.remove('show');
      localStorage.removeItem('muchinavi_token');
      sessionToken = null;
      chatMessages = [];
      directChatMessages = [];
      Object.keys(customerData).forEach(k => delete customerData[k]);
      // Reload to show welcome/login screen
      window.location.href = window.location.pathname;
    }

    // ===== Withdraw (退会) =====
    function showWithdrawModal() {
      document.getElementById('settings-dropdown').classList.remove('show');
      document.getElementById('withdraw-modal').classList.add('active');
    }

    function closeWithdrawModal() {
      document.getElementById('withdraw-modal').classList.remove('active');
    }

    async function executeWithdraw() {
      if (!sessionToken) {
        closeWithdrawModal();
        return;
      }
      try {
        const res = await fetch(`/api/withdraw/${sessionToken}`, { method: 'POST' });
        const data = await res.json();
        closeWithdrawModal();
        if (data.success) {
          // LocalStorage をクリアしてオンボーディングへ
          localStorage.removeItem('muchinavi_token');
          showWithdrawComplete();
        }
      } catch (e) {
        console.error('退会エラー:', e);
        closeWithdrawModal();
        alert('退会処理中にエラーが発生しました。もう一度お試しください。');
      }
    }

    function showWithdrawComplete() {
      document.getElementById('chat-screen').classList.remove('active');
      document.getElementById('onboarding').style.display = '';
      const card = document.getElementById('step-card');
      card.innerHTML = `
        <div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><path d="M18 11V6a2 2 0 0 0-4 0v3"/><path d="M14 10V4a2 2 0 0 0-4 0v7"/><path d="M10 10.5V5a2 2 0 0 0-4 0v9"/><path d="M18 11a2 2 0 1 1 4 0v3a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg></div>
        <h2 class="step-title">ご利用ありがとうございました</h2>
        <p class="step-subtitle">退会処理が完了しました。<br>またのご利用をお待ちしております。</p>
        <button class="btn-primary" onclick="location.href='/';" style="margin-top: 16px;">トップに戻る</button>
      `;
      document.getElementById('progress').style.display = 'none';
      history.replaceState(null, '', '/');
    }

    // ===== Block screen =====
    function showBlockedScreen() {
      document.getElementById('blocked-screen').classList.add('active');
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('chat-screen').classList.remove('active');
    }

    // ===== Profile Page Functions =====

    function populateProfileSelects() {
      // Birth year
      const yearSelect = document.getElementById('prof-birthYear');
      for (let y = 2010; y >= 1950; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + '年';
        yearSelect.appendChild(opt);
      }
      // Birth month
      const monthSelect = document.getElementById('prof-birthMonth');
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m + '月';
        monthSelect.appendChild(opt);
      }
      // Prefectures
      const prefSelect = document.getElementById('prof-prefecture');
      const prefs = ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'];
      prefs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        prefSelect.appendChild(opt);
      });
    }

    async function openProfile() {
      // Close settings dropdown
      document.getElementById('settings-dropdown').classList.remove('show');

      const token = localStorage.getItem('muchinavi_token');
      if (!token) return;

      try {
        const res = await fetch(`/api/customer/profile/${token}`);
        const data = await res.json();
        if (!data.success) return;

        const p = data.profile;
        document.getElementById('prof-name').value = p.name || '';
        document.getElementById('prof-birthYear').value = p.birthYear || '';
        document.getElementById('prof-birthMonth').value = p.birthMonth || '';
        document.getElementById('prof-prefecture').value = p.prefecture || '';
        document.getElementById('prof-family').value = p.family || '';
        document.getElementById('prof-householdIncome').value = p.householdIncome || '';
        document.getElementById('prof-propertyType').value = p.propertyType || '';
        document.getElementById('prof-area').value = p.area || '';
        document.getElementById('prof-budget').value = p.budget || '';
        document.getElementById('prof-email').value = p.email || '';
        document.getElementById('prof-phone').value = p.phone || '';

        document.getElementById('profile-screen').classList.add('active');
      } catch (e) {
        console.error('Profile load error:', e);
      }
    }

    function closeProfile() {
      document.getElementById('profile-screen').classList.remove('active');
    }

    async function saveProfile() {
      const token = localStorage.getItem('muchinavi_token');
      if (!token) return;

      const btn = document.getElementById('profile-save-btn');
      btn.disabled = true;
      btn.textContent = '保存中...';

      const profileData = {
        name: document.getElementById('prof-name').value.trim(),
        birthYear: document.getElementById('prof-birthYear').value,
        birthMonth: document.getElementById('prof-birthMonth').value,
        prefecture: document.getElementById('prof-prefecture').value,
        family: document.getElementById('prof-family').value.trim(),
        householdIncome: document.getElementById('prof-householdIncome').value,
        propertyType: document.getElementById('prof-propertyType').value,
        area: document.getElementById('prof-area').value.trim(),
        budget: document.getElementById('prof-budget').value.trim(),
        email: document.getElementById('prof-email').value.trim(),
        phone: document.getElementById('prof-phone').value.trim(),
      };

      try {
        const res = await fetch(`/api/customer/profile/${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData),
        });
        const data = await res.json();

        if (data.success) {
          showProfileToast('保存しました', 'success');
          // Update the chat header name display
          if (profileData.name) {
            document.getElementById('chat-customer-name').textContent = profileData.name + ' さん';
          }
          // Refresh progress bar (stage may have changed)
          loadProgressBar();
        } else {
          showProfileToast('保存に失敗しました', 'error');
        }
      } catch (e) {
        showProfileToast('通信エラーが発生しました', 'error');
      }

      btn.disabled = false;
      btn.textContent = '変更を保存する';
    }

    function showProfileToast(msg, type) {
      const toast = document.getElementById('profile-toast');
      toast.textContent = msg;
      toast.className = 'profile-toast ' + type + ' show';
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    async function changeCustomerPassword() {
      const pw = document.getElementById('prof-new-password').value;
      const pwConfirm = document.getElementById('prof-new-password-confirm').value;
      if (!pw || pw.length < 6) {
        showProfileToast('パスワードは6文字以上で入力してください', 'error');
        return;
      }
      if (pw !== pwConfirm) {
        showProfileToast('パスワードが一致しません', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/customer/change-password/${sessionToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword: pw }),
        });
        const data = await res.json();
        if (data.success) {
          showProfileToast('パスワードを変更しました', 'success');
          document.getElementById('prof-new-password').value = '';
          document.getElementById('prof-new-password-confirm').value = '';
        } else {
          showProfileToast(data.error || '変更に失敗しました', 'error');
        }
      } catch (e) {
        showProfileToast('通信エラーが発生しました', 'error');
      }
    }

    // Initialize profile selects
    populateProfileSelects();

    // ===== Service Worker 登録 =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then((reg) => {
        console.log('SW registered:', reg.scope);
      }).catch((err) => {
        console.log('SW registration failed:', err);
      });
    }

    // ===== ホーム画面追加の案内バナー（PWA Install Prompt） =====
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // チャット画面がアクティブな時に表示
      setTimeout(showInstallBanner, 3000);
    });

    function showInstallBanner() {
      if (!deferredPrompt) return;
      // 既に表示済みなら出さない
      if (localStorage.getItem('muchinavi_install_dismissed')) return;

      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.innerHTML = `
        <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;
          background:#1d1d1f;color:white;padding:16px 20px;border-radius:16px;
          box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:360px;width:calc(100% - 40px);
          display:flex;align-items:center;gap:14px;font-family:-apple-system,sans-serif;
          animation:slideUpBanner 0.4s ease-out;">
          <div style="flex-shrink:0;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;margin-bottom:4px;">ホーム画面に追加</div>
            <div style="font-size:12px;color:#aeaeb2;line-height:1.4;">アプリとして快適にご利用いただけます</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
            <button onclick="doInstallPWA()" style="background:#0071e3;color:white;border:none;
              padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;
              font-family:inherit;">追加</button>
            <button onclick="dismissInstallBanner()" style="background:none;color:#aeaeb2;border:none;
              padding:4px;font-size:11px;cursor:pointer;font-family:inherit;">後で</button>
          </div>
        </div>
      `;
      document.body.appendChild(banner);
    }

    function doInstallPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        deferredPrompt = null;
        const banner = document.getElementById('install-banner');
        if (banner) banner.remove();
        if (choice.outcome === 'accepted') {
          localStorage.setItem('muchinavi_install_dismissed', '1');
        }
      });
    }

    function dismissInstallBanner() {
      const banner = document.getElementById('install-banner');
      if (banner) banner.remove();
      localStorage.setItem('muchinavi_install_dismissed', '1');
    }

    // iOS Safari向け案内（beforeinstallpromptが発火しない）
    function checkIOSInstallPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.navigator.standalone === true;
      const dismissed = localStorage.getItem('muchinavi_ios_install_dismissed');

      if (isIOS && !isStandalone && !dismissed) {
        setTimeout(() => {
          const banner = document.createElement('div');
          banner.id = 'ios-install-banner';
          banner.innerHTML = `
            <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;
              background:#1d1d1f;color:white;padding:16px 20px;border-radius:16px;
              box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:380px;width:calc(100% - 40px);
              font-family:-apple-system,sans-serif;animation:slideUpBanner 0.4s ease-out;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <span><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style=""><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></span>
                <div>
                  <div style="font-weight:600;font-size:14px;">アプリとして使えます</div>
                  <div style="font-size:12px;color:#aeaeb2;margin-top:2px;">ホーム画面に追加して快適に</div>
                </div>
                <button onclick="dismissIOSBanner()" style="margin-left:auto;background:none;border:none;
                  color:#aeaeb2;font-size:18px;cursor:pointer;padding:4px;">✕</button>
              </div>
              <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;font-size:13px;line-height:1.6;">
                ① Safariのメニューバーにある<br>　 <span style="font-size:16px;">□↑</span>（共有）ボタンをタップ<br>
                ②「ホーム画面に追加」を選択<br>
                <span style="font-size:11px;color:#8e8e93;">※ 見つからない場合はメニューを<br>　 上にスクロールしてください</span>
              </div>
            </div>
          `;
          document.body.appendChild(banner);
        }, 5000);
      }
    }

    function dismissIOSBanner() {
      const banner = document.getElementById('ios-install-banner');
      if (banner) banner.remove();
      localStorage.setItem('muchinavi_ios_install_dismissed', '1');
    }

    // チャット画面表示後にiOS案内チェック
    // モバイルビューポート高さ修正（100vhがアドレスバーを含む問題対策）
    function fixMobileHeight() {
      const cs = document.querySelector('.chat-screen');
      if (cs && cs.classList.contains('active')) {
        cs.style.height = window.innerHeight + 'px';
      }
    }
    window.addEventListener('resize', fixMobileHeight);
    // visualViewport API対応ブラウザ（キーボード表示時の高さ変化に対応）
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', function() {
        const cs = document.querySelector('.chat-screen');
        if (cs && cs.classList.contains('active')) {
          cs.style.height = window.visualViewport.height + 'px';
        }
      });
    }

    const origStartChat = startChat;
    startChat = function() {
      origStartChat.apply(this, arguments);
      checkIOSInstallPrompt();
      fixMobileHeight();
    };

    init();
  </script>

  <style>
    @keyframes slideUpBanner {
      from { opacity: 0; transform: translateX(-50%) translateY(30px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</body>
</html>
