<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MuchiNavi ‚Äî „ÅÇ„Å™„Åü„ÅÆ‰Ωè„Åæ„ÅÑÊé¢„ÅóAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</title>
  <meta name="description" content="AI„Åå„ÅÇ„Å™„Åü„Å´„Å¥„Å£„Åü„Çä„ÅÆ‰Ωè„Åæ„ÅÑÊé¢„Åó„Çí„Çµ„Éù„Éº„Éà„ÄÇ‰ΩèÂÆÖ„É≠„Éº„É≥„Éª„Ç®„É™„Ç¢ÈÅ∏„Å≥„ÉªÁâ©‰ª∂„Çø„Ç§„Éó„ÅÆÁõ∏Ë´á„Åå24ÊôÇÈñìÁÑ°Êñô„ÄÇ‰∏çÂãïÁî£„Ç®„Éº„Ç∏„Çß„É≥„ÉàÂ≤°Êú¨Â≤≥Â§ß„ÅåÊèê‰æõ„Åô„ÇãAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÄÇ">
  <meta name="keywords" content="‰ΩèÂÆÖË≥ºÂÖ•,„Éû„Ç§„Éõ„Éº„É†,‰ΩèÂÆÖ„É≠„Éº„É≥,‰∏çÂãïÁî£Áõ∏Ë´á,AI,‰Ωè„Åæ„ÅÑÊé¢„Åó,TERASS">
  <meta name="author" content="Â≤°Êú¨Â≤≥Â§ß | TERASS">
  <!-- OGP -->
  <meta property="og:title" content="MuchiNavi ‚Äî „ÅÇ„Å™„Åü„ÅÆ‰Ωè„Åæ„ÅÑÊé¢„ÅóAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà">
  <meta property="og:description" content="AI„Åå‰ΩèÂÆÖË≥ºÂÖ•„Çí„Çµ„Éù„Éº„Éà„ÄÇ‰ΩèÂÆÖ„É≠„Éº„É≥„Éª„Ç®„É™„Ç¢ÈÅ∏„Å≥„ÉªÁâ©‰ª∂Êé¢„Åó„ÅÆÁõ∏Ë´á„Åå24ÊôÇÈñìÁÑ°Êñô„ÄÇ">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://muchinavi.com">
  <meta property="og:site_name" content="MuchiNavi">
  <meta property="og:locale" content="ja_JP">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MuchiNavi ‚Äî ‰Ωè„Åæ„ÅÑÊé¢„ÅóAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà">
  <meta name="twitter:description" content="AI„Åå‰ΩèÂÆÖË≥ºÂÖ•„Çí„Çµ„Éù„Éº„Éà„ÄÇ24ÊôÇÈñìÁÑ°Êñô„ÅßÁõ∏Ë´á„Åß„Åç„Åæ„Åô„ÄÇ">
  <meta name="theme-color" content="#1d1d1f">
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MuchiNavi">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    /* „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ: ‰ΩéÈÄüÁ´ØÊú´„Åß„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁÑ°ÂäπÂåñ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #1d1d1f;
      --accent: #0071e3;
      --accent-hover: #0077ED;
      --accent-subtle: rgba(0,113,227,0.06);
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.82);
      --text: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-light: #aeaeb2;
      --border: rgba(0,0,0,0.08);
      --success: #34c759;
      --danger: #ff3b30;
      --radius: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 48px rgba(0,0,0,0.12);
      --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* ===== Background decoration (ËªΩÈáèÁâà) ===== */
    .bg-glow {
      position: fixed;
      width: 600px; height: 600px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
      z-index: 0;
      will-change: auto;
    }
    .bg-glow-1 { top: -200px; right: -100px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); }
    .bg-glow-2 { bottom: -200px; left: -100px; background: radial-gradient(circle, #5856d6 0%, transparent 70%); }

    /* ===== Container ===== */
    .container {
      position: relative;
      z-index: 1;
      max-width: 520px;
      margin: 0 auto;
      padding: 24px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* ===== Step card ===== */
    .step-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 48px 36px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      animation: cardIn 0.35s ease-out;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(24px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes cardOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-20px) scale(0.96); }
    }
    .step-card.leaving {
      animation: cardOut 0.3s ease forwards;
    }

    /* ===== Step elements ===== */
    .step-icon {
      font-size: 56px;
      margin-bottom: 20px;
      display: inline-block;
      /* float„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂâäÈô§„ÅßËªΩÈáèÂåñ */
    }
    /* @keyframes float ÂâäÈô§Ê∏à„ÅøÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑÔºâ */
    .step-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      color: var(--primary);
    }
    .step-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: 28px;
    }
    .step-response {
      font-size: 14px;
      color: var(--accent);
      font-weight: 600;
      margin-top: 16px;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.2s ease;
    }
    .step-response.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ===== Progress bar ===== */
    .progress-container {
      margin-bottom: 32px;
      text-align: center;
    }
    .progress-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .progress-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s ease;
    }
    .progress-dot.active {
      background: var(--accent);
      width: 24px;
      border-radius: 4px;
    }
    .progress-dot.done {
      background: var(--success);
    }
    .progress-label {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 8px;
      font-weight: 500;
    }

    /* ===== Inputs ===== */
    .input-field {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      font-family: inherit;
      background: white;
      color: var(--text);
      outline: none;
      transition: all 0.3s ease;
      text-align: center;
    }
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }
    .input-field::placeholder {
      color: var(--text-light);
    }

    /* ===== Buttons ===== */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 40px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,113,227,0.3);
    }
    .btn-primary:active {
      transform: scale(0.97);
    }
    .btn-primary:disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 980px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover {
      background: rgba(0,0,0,0.04);
      color: var(--text);
    }
    .btn-login {
      background: none;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 12px 32px;
      border-radius: 980px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }
    .btn-login:hover {
      background: var(--accent);
      color: white;
    }

    /* ===== Login screen ===== */
    .login-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .login-screen.active { display: flex; }
    .login-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 48px 36px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 520px;
      width: 100%;
    }

    /* ===== Choice cards ===== */
    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    .choice-card {
      padding: 20px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    .choice-card:hover {
      border-color: rgba(0,113,227,0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .choice-card.selected {
      border-color: var(--accent);
      background: var(--accent-subtle);
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }
    .choice-icon { font-size: 28px; margin-bottom: 8px; }
    .choice-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
    }

    /* ===== Slider ===== */
    .slider-container {
      width: 100%;
      margin: 16px 0;
    }
    .budget-display {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, var(--accent), #5856d6);
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-light);
      margin-top: 8px;
    }

    /* ===== Sub-question ===== */
    .sub-question {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      animation: cardIn 0.4s ease;
    }
    .sub-question label {
      font-size: 13px;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 8px;
    }

    /* ===== Completion ===== */
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }
    .completion-check {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: var(--success);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      animation: checkPop 0.6s ease;
    }
    @keyframes checkPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .completion-check svg {
      width: 40px; height: 40px;
      stroke: white;
      stroke-width: 3;
      fill: none;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkDraw 0.6s 0.3s forwards;
    }
    @keyframes checkDraw {
      to { stroke-dashoffset: 0; }
    }

    /* ===== Chat UI ===== */
    .chat-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 100;
    }
    .chat-screen.active { display: flex; }

    .chat-header {
      padding: 20px 24px;
      text-align: center;
      background: #1d1d1f;
      color: white;
    }
    .chat-header-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 3px;
      opacity: 0.4;
      margin-bottom: 4px;
    }
    .chat-header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .chat-header-sub {
      font-size: 12px;
      opacity: 0.5;
      margin-top: 4px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .chat-message {
      display: flex;
      gap: 8px;
      animation: msgIn 0.4s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .chat-message.user { justify-content: flex-end; }
    .chat-bubble {
      max-width: 80%;
      padding: 14px 20px;
      font-size: 14px;
      line-height: 1.75;
      word-wrap: break-word;
    }
    .chat-message.assistant .chat-bubble {
      background: white;
      color: var(--text);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .chat-message.user .chat-bubble {
      background: var(--accent);
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
      box-shadow: 0 2px 8px rgba(0,113,227,0.25);
    }
    .chat-bubble p { margin: 0 0 8px 0; }
    .chat-bubble p:last-child { margin-bottom: 0; }
    .chat-bubble ul, .chat-bubble ol { margin: 6px 0; padding-left: 20px; }
    .chat-bubble li { margin-bottom: 4px; line-height: 1.6; }
    .chat-bubble strong { font-weight: 600; }

    /* ÂÄã‰∫∫„ÉÅ„É£„ÉÉ„ÉàÁî®„ÅÆËâ≤ÂàÜ„Åë */
    .chat-bubble.direct-user {
      background: #34c759;
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
      box-shadow: 0 2px 8px rgba(52,199,89,0.25);
    }
    .chat-bubble.direct-assistant {
      background: #f0faf3;
      color: var(--text);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid rgba(52,199,89,0.2);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    .chat-input-bar {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: white;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }
    .chat-input-bar textarea {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border 0.2s;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      line-height: 1.5;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chat-input-bar textarea:focus {
      border-color: var(--accent);
    }
    .chat-input-bar button {
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      height: 44px;
    }
    .chat-input-bar button:hover { background: var(--accent-hover); }
    .chat-input-bar button:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    .chat-room-tabs {
      display: flex;
      background: #f5f5f7;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 0;
    }
    .chat-room-tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      background: none;
      border: none;
      color: #6e6e73;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border-bottom: 2px solid transparent;
    }
    .chat-room-tab.active {
      color: #0071e3;
      border-bottom-color: #0071e3;
    }
    .chat-room-tab .tab-badge {
      display: none;
      position: absolute;
      top: 6px;
      right: calc(50% - 40px);
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }
    .chat-room-tab .tab-badge.show { display: block; }

    .chat-welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      padding: 40px 24px;
    }
    .chat-welcome-icon { font-size: 48px; margin-bottom: 16px; }
    .chat-welcome h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .chat-welcome p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.7;
      max-width: 300px;
    }
    .chat-hints {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 20px;
      justify-content: center;
    }
    .chat-hint {
      font-size: 12px;
      padding: 8px 14px;
      background: var(--accent-subtle);
      color: var(--accent);
      border-radius: 980px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all 0.2s;
    }
    .chat-hint:hover {
      background: var(--accent);
      color: white;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 18px;
      background: white;
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
      border: 1px solid var(--border);
      width: fit-content;
    }
    .typing-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--text-light);
      animation: typingBounce 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    /* ===== Article Card ===== */
    .article-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      margin: 12px 0 8px;
      background: linear-gradient(135deg, #f0f7ff 0%, #f5f0ff 100%);
      border: 1px solid rgba(0,113,227,0.12);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
    }
    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,113,227,0.15);
      border-color: var(--accent);
    }
    .article-card-icon {
      font-size: 24px;
      flex-shrink: 0;
      display: inline-block;
    }
    .article-card-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .article-card-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 2px;
      display: block;
    }
    .article-card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      line-height: 1.4;
      display: block;
    }
    .article-card-arrow {
      font-size: 16px;
      color: var(--accent);
      flex-shrink: 0;
      display: inline-block;
    }

    /* ===== Booking Card ===== */
    .booking-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      margin: 12px 0 8px;
      background: linear-gradient(135deg, #1d1d1f 0%, #2c2c2e 100%);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: white;
    }
    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .booking-card-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .booking-card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .booking-card-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      opacity: 0.5;
      margin-bottom: 2px;
      display: block;
    }
    .booking-card-title {
      font-size: 14px;
      font-weight: 600;
      display: block;
    }
    .booking-card-sub {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
      display: block;
    }
    .booking-card-arrow {
      font-size: 18px;
      opacity: 0.4;
      display: inline-block;
    }

    /* ===== Chat header action buttons ===== */
    .chat-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .chat-header-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 9px 16px;
      border-radius: 980px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      border: none;
      line-height: 1;
    }
    /* „Ç™„É≥„É©„Ç§„É≥Èù¢Ë´á ‚Äî ÁôΩÂú∞„Å´„Ç¢„ÇØ„Çª„É≥„Éà„Ç´„É©„Éº */
    .chat-header-btn.booking {
      background: white;
      color: #0071e3;
    }
    .chat-header-btn.booking:hover {
      background: #f0f0f0;
    }
    /* „Éû„Ç§„Éö„Éº„Ç∏ ‚Äî ÂçäÈÄèÊòéÁôΩ */
    .chat-header-btn.profile {
      background: rgba(255,255,255,0.18);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .chat-header-btn.profile:hover {
      background: rgba(255,255,255,0.3);
    }
    /* Ë®≠ÂÆö ‚Äî Êéß„Åà„ÇÅ */
    .chat-header-btn.settings-toggle {
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 9px 12px;
    }
    .chat-header-btn.settings-toggle:hover {
      background: rgba(255,255,255,0.18);
      color: white;
    }

    /* ===== Choice Chips in Chat ===== */
    .chat-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 4px;
    }
    .chat-choice-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: white;
      border: 2px solid var(--accent);
      border-radius: 980px;
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      line-height: 1.3;
    }
    .chat-choice-chip:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,113,227,0.25);
    }
    .chat-choice-chip:active {
      transform: scale(0.96);
    }
    .chat-choice-chip.used {
      background: var(--accent-subtle);
      border-color: rgba(0,113,227,0.2);
      color: var(--text-secondary);
      cursor: default;
      pointer-events: none;
    }
    .chat-choice-chip.used::before {
      content: '‚úì ';
    }

    /* ===== Settings dropdown ===== */
    .settings-wrapper {
      position: relative;
    }
    .settings-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      border: 1px solid var(--border);
      min-width: 180px;
      z-index: 200;
      animation: fadeInDown 0.2s ease;
    }
    .settings-dropdown.show { display: block; }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .settings-dropdown-item {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 13px;
      font-family: inherit;
      text-align: left;
      cursor: pointer;
      color: var(--text);
      transition: background 0.15s;
    }
    .settings-dropdown-item:hover { background: var(--bg); }
    .settings-dropdown-item.danger { color: var(--danger); }

    /* ===== Withdraw / Block modals ===== */
    .overlay-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      z-index: 500;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .overlay-modal.active { display: flex; }
    .modal-inner {
      background: white;
      border-radius: var(--radius-lg);
      padding: 36px 32px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      animation: cardIn 0.4s ease;
    }
    .modal-inner-icon { font-size: 48px; margin-bottom: 16px; }
    .modal-inner-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal-inner-text { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 24px; }
    .modal-btn-row { display: flex; gap: 12px; }
    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 980px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-btn-cancel {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .modal-btn-cancel:hover { background: #e8e8ed; }
    .modal-btn-danger {
      background: var(--danger);
      border: none;
      color: white;
    }
    .modal-btn-danger:hover { background: #e63329; }

    /* Block screen */
    .blocked-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 600;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }
    .blocked-screen.active { display: flex; flex-direction: column; }
    .blocked-icon { font-size: 64px; margin-bottom: 20px; }
    .blocked-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .blocked-text { font-size: 14px; color: var(--text-secondary); line-height: 1.7; }

    /* ===== Profile Screen ===== */
    .profile-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg);
      z-index: 150;
    }
    .profile-screen.active { display: flex; }

    .profile-header {
      padding: 20px 24px;
      text-align: center;
      background: #1d1d1f;
      color: white;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .profile-back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 0;
      font-weight: 600;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }
    .profile-back-btn:hover { opacity: 0.7; }
    .profile-header-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      flex: 1;
    }

    .profile-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .profile-section {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .profile-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.6;
    }

    .profile-field {
      margin-bottom: 16px;
    }
    .profile-field:last-child { margin-bottom: 0; }
    .profile-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .profile-field input,
    .profile-field select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      color: var(--text);
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .profile-field input:focus,
    .profile-field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .profile-save-btn {
      width: calc(100% - 32px);
      padding: 16px 24px;
      margin: 32px 16px 40px;
      font-size: 16px;
      font-weight: 700;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .profile-save-btn:hover { background: var(--accent-hover); }
    .profile-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .profile-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      max-width: 90%;
      text-align: center;
      z-index: 200;
    }
    .profile-toast.success {
      background: var(--success);
      color: white;
    }
    .profile-toast.error {
      background: var(--danger);
      color: white;
    }
    .profile-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Responsive ===== */
    @media (max-width: 560px) {
      /* Onboarding */
      .container { padding: 12px; }
      .step-card { padding: 28px 18px; }
      .step-icon { font-size: 40px; margin-bottom: 14px; }
      .step-title { font-size: 18px; }
      .step-subtitle { font-size: 13px; }
      .choices { grid-template-columns: 1fr 1fr; gap: 8px; }
      .choice-card { padding: 14px 10px; }
      .choice-icon { font-size: 24px; }
      .choice-label { font-size: 12px; }
      .input-field { font-size: 16px; padding: 12px 14px; }
      .next-btn { font-size: 15px; padding: 14px; }
      .prefecture-grid { grid-template-columns: repeat(5, 1fr); gap: 6px; }
      .prefecture-btn { padding: 10px 6px; font-size: 11px; }
      .birthdate-container { gap: 10px; }
      .birthdate-selector select { font-size: 13px; padding: 12px 10px; }
      .next-choice-btn { font-size: 14px; padding: 12px 28px; min-width: 140px; }

      /* Chat Header */
      .chat-header { padding: 14px 16px; }
      .chat-header-title { font-size: 17px; }
      .chat-header-label { font-size: 9px; letter-spacing: 2px; }
      .chat-header-sub { font-size: 11px; }
      .chat-header-actions { gap: 6px; margin-top: 10px; }
      .chat-header-btn { font-size: 12px; padding: 8px 14px; }
      .chat-header-btn.settings-toggle { padding: 8px 10px; }

      /* Chat Messages */
      .chat-messages { padding: 16px 10px; gap: 12px; }
      .chat-bubble {
        max-width: 88%;
        padding: 11px 14px;
        font-size: 13px;
        line-height: 1.7;
      }
      .chat-bubble p { margin: 0 0 6px 0; }
      .chat-bubble ul, .chat-bubble ol { padding-left: 16px; }

      /* Chat Input */
      .chat-input-bar { padding: 10px 10px; gap: 8px; }
      .chat-input-bar textarea {
        padding: 10px 14px;
        font-size: 16px; /* 16px prevents iOS zoom on focus */
        min-height: 40px;
        max-height: 100px;
      }
      .chat-input-bar button { padding: 10px 18px; font-size: 13px; height: 40px; }

      /* Article Card */
      .article-card { padding: 12px 14px; gap: 10px; margin: 8px 0 6px; }
      .article-card-icon { font-size: 20px; }
      .article-card-title { font-size: 12px; }
      .article-card-label { font-size: 9px; }

      /* Booking Card */
      .booking-card { padding: 14px 14px; gap: 10px; margin: 8px 0 6px; }
      .booking-card-icon { width: 36px; height: 36px; font-size: 16px; border-radius: 10px; }
      .booking-card-title { font-size: 13px; }
      .booking-card-sub { font-size: 10px; }
      .booking-card-label { font-size: 9px; }

      /* Choice Chips */
      .chat-choices { gap: 6px; margin: 8px 0 4px; }
      .chat-choice-chip { padding: 8px 12px; font-size: 12px; }

      /* Welcome */
      .chat-welcome { padding: 24px 16px; }
      .chat-welcome-icon { font-size: 36px; }
      .chat-welcome h3 { font-size: 16px; }
      .chat-welcome p { font-size: 12px; max-width: 260px; }
      .chat-hints { gap: 6px; margin-top: 14px; }
      .chat-hint { font-size: 11px; padding: 6px 10px; }

      /* Modal */
      .overlay-modal { padding: 16px; }
      .modal-inner { padding: 28px 20px; }
      .modal-inner-icon { font-size: 36px; margin-bottom: 12px; }
      .modal-inner-title { font-size: 16px; }
      .modal-inner-text { font-size: 13px; }
      .modal-btn { font-size: 14px; padding: 12px; }

      /* Settings dropdown */
      .settings-dropdown { min-width: 150px; right: 8px; }
    }

    /* Extra small screens (iPhone SE etc.) */
    @media (max-width: 375px) {
      .step-card { padding: 24px 14px; }
      .step-icon { font-size: 36px; }
      .step-title { font-size: 16px; }
      .chat-bubble { max-width: 92%; font-size: 12.5px; }
      .chat-header { padding: 12px 12px; }
      .chat-header-title { font-size: 15px; }
      .chat-input-bar textarea { padding: 10px 12px; }
      .chat-input-bar button { padding: 10px 14px; font-size: 12px; height: 38px; }
      .chat-choice-chip { padding: 6px 10px; font-size: 11px; }
      .chat-header-btn { font-size: 11px; padding: 7px 10px; }
    }

    /* Safe area support for notched devices */
    @supports (padding: env(safe-area-inset-bottom)) {
      .chat-input-bar {
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .chat-header {
        padding-top: calc(14px + env(safe-area-inset-top));
      }
    }

    /* ===== Back Button ===== */
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      padding: 8px 14px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 980px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .back-button:hover {
      background: rgba(0,0,0,0.04);
      color: var(--text);
    }

    /* ===== Next Button (for choice/prefecture) ===== */
    .next-choice-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 40px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 980px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
      margin-top: 16px;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
    }
    .next-choice-btn.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .next-choice-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,113,227,0.3);
    }
    .next-choice-btn:active {
      transform: scale(0.97);
    }

    /* ===== Prefecture Grid ===== */
    .prefecture-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 16px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }
    .prefecture-region-header {
      grid-column: 1 / -1;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 8px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .prefecture-btn {
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      font-family: inherit;
    }
    .prefecture-btn:hover {
      border-color: rgba(0,113,227,0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .prefecture-btn.selected {
      border-color: var(--accent);
      background: var(--accent-subtle);
      color: var(--accent);
      font-weight: 600;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
    }

    /* ===== Birthdate Selectors ===== */
    .birthdate-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .birthdate-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 120px;
    }
    .birthdate-selector label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .birthdate-selector select {
      padding: 14px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      background: white;
      color: var(--text);
      outline: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .birthdate-selector select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }

    /* ===== Powered by footer ===== */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 11px;
      color: var(--text-light);
    }
    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="bg-glow bg-glow-1"></div>
  <div class="bg-glow bg-glow-2"></div>

  <!-- ===== Onboarding ===== -->
  <div class="container" id="onboarding">
    <div class="progress-container" id="progress" style="display:none;">
      <div class="progress-dots" id="progress-dots"></div>
      <div class="progress-label" id="progress-label"></div>
    </div>

    <div class="step-card" id="step-card">
      <!-- Steps will be rendered here by JS -->
    </div>

    <div class="footer">
      Powered by <a href="https://muchinochi.com" target="_blank">muchinochi</a>
    </div>
  </div>

  <!-- ===== „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ ===== -->
  <div class="login-screen" id="login-screen">
    <!-- ÈÄöÂ∏∏„É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
    <div class="login-card" id="login-form-card">
      <div class="step-icon">üîë</div>
      <h2 class="step-title">„É≠„Ç∞„Ç§„É≥</h2>
      <p class="step-subtitle">ÁôªÈå≤ÊôÇ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
      <div style="text-align: left; display: flex; flex-direction: column; gap: 14px; margin-top: 24px;">
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input class="input-field" type="email" id="login-email" placeholder="example@email.com" style="text-align: left;">
        </div>
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„Éë„Çπ„ÉØ„Éº„Éâ</label>
          <div style="position: relative;">
            <input class="input-field" type="password" id="login-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" style="text-align: left; padding-right: 50px;" onkeypress="if(event.key==='Enter')doLogin()">
            <button type="button" onclick="togglePasswordVisibility('login-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
          </div>
        </div>
      </div>
      <div id="login-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div style="margin-top: 24px;">
        <button class="btn-primary" onclick="doLogin()">„É≠„Ç∞„Ç§„É≥</button>
      </div>
      <button onclick="showResetForm()" style="margin-top: 16px; background:none; border:none; color:var(--accent); font-size:13px; cursor:pointer; font-family:inherit;">„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„ÅÆÊñπ</button>
      <div style="margin-top: 12px;">
        <button class="btn-login" onclick="hideLoginForm()">‚Üê Êñ∞Ë¶èÁôªÈå≤„Å´Êàª„Çã</button>
      </div>
    </div>

    <!-- „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Éï„Ç©„Éº„É† -->
    <div class="login-card" id="reset-form-card" style="display: none;">
      <div class="step-icon">üîÑ</div>
      <h2 class="step-title">„Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆö</h2>
      <p class="step-subtitle">ÁôªÈå≤ÊôÇ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>Á¢∫Ë™çÂæå„ÄÅÊñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ</p>
      <div style="text-align: left; display: flex; flex-direction: column; gap: 14px; margin-top: 24px;">
        <div>
          <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input class="input-field" type="email" id="reset-email" placeholder="example@email.com" style="text-align: left;">
        </div>
        <div id="reset-password-section" style="display: none;">
          <div style="margin-bottom: 14px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ</label>
            <div style="position: relative;">
              <input class="input-field" type="password" id="reset-new-password" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä" style="text-align: left; padding-right: 50px;">
              <button type="button" onclick="togglePasswordVisibility('reset-new-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
            </div>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
            <div style="position: relative;">
              <input class="input-field" type="password" id="reset-new-password-confirm" placeholder="„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ" style="text-align: left; padding-right: 50px;" onkeypress="if(event.key==='Enter')doResetPassword()">
              <button type="button" onclick="togglePasswordVisibility('reset-new-password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
            </div>
          </div>
        </div>
      </div>
      <div id="reset-error" style="color: var(--danger); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div id="reset-success" style="color: var(--success); font-size: 13px; margin-top: 12px; display: none;"></div>
      <div style="margin-top: 24px;">
        <button class="btn-primary" id="reset-btn" onclick="doVerifyEmail()">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç</button>
      </div>
      <div style="margin-top: 12px;">
        <button class="btn-login" onclick="showLoginCard()">‚Üê „É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</button>
      </div>
    </div>
  </div>

  <!-- ===== Chat Screen ===== -->
  <div class="chat-screen" id="chat-screen">
    <div class="chat-header">
      <div class="chat-header-label">AI Assistant</div>
      <div class="chat-header-title">MuchiNavi</div>
      <div class="chat-header-sub" id="chat-customer-name"></div>
      <div class="chat-header-actions">
        <a class="chat-header-btn booking" id="chat-booking-btn" href="#" target="_blank" rel="noopener">
          üìÖ „Ç™„É≥„É©„Ç§„É≥Èù¢Ë´á
        </a>
        <button class="chat-header-btn profile" onclick="openProfile()">
          üë§ „Éû„Ç§„Éö„Éº„Ç∏
        </button>
        <div class="settings-wrapper">
          <button class="chat-header-btn settings-toggle" onclick="toggleSettings(event)">‚öôÔ∏è</button>
          <div class="settings-dropdown" id="settings-dropdown">
            <button class="settings-dropdown-item" onclick="doLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            <button class="settings-dropdown-item danger" onclick="showWithdrawModal()">ÈÄÄ‰ºö„Åô„Çã</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat room tab switcher -->
    <div class="chat-room-tabs">
      <button class="chat-room-tab active" id="tab-ai" onclick="switchChatRoom('ai')">
        ü§ñ MuchiNavi
        <span class="tab-badge" id="badge-ai"></span>
      </button>
      <button class="chat-room-tab" id="tab-direct" onclick="switchChatRoom('direct')">
        üí¨ „Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´Áõ∏Ë´á
        <span class="tab-badge" id="badge-direct"></span>
      </button>
    </div>

    <!-- AI Chat Room (existing) -->
    <div class="chat-messages" id="chat-messages" style="display: flex;">
      <div class="chat-welcome" id="chat-welcome">
        <div class="chat-welcome-icon">üè†</div>
        <h3>MuchiNavi„Å´‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</h3>
        <p>‰ΩèÂÆÖ„É≠„Éº„É≥„ÄÅÁâ©‰ª∂„ÅÆÈÅ∏„Å≥Êñπ„ÄÅ„Çπ„Ç±„Ç∏„É•„Éº„É´‚Ä¶<br>‰Ωè„Åæ„ÅÑÊé¢„Åó„ÅÆ„Åì„Å®„Å™„Çâ‰Ωï„Åß„ÇÇ„ÅäÊ∞óËªΩ„Å´„Å©„ÅÜ„Åû„ÄÇ</p>
        <div class="chat-hints">
          <button class="chat-hint" onclick="sendHint('‰ΩèÂÆÖ„É≠„Éº„É≥„Å£„Å¶‰Ωï„Åã„ÇâÂßã„ÇÅ„Çå„Å∞„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü')">‰ΩèÂÆÖ„É≠„Éº„É≥„ÅÆÂßã„ÇÅÊñπ</button>
          <button class="chat-hint" onclick="sendHint('Áâ©‰ª∂Êé¢„Åó„ÅßÂ§±Êïó„Åó„Å™„ÅÑ„Ç≥„ÉÑ„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">Áâ©‰ª∂Êé¢„Åó„ÅÆ„Ç≥„ÉÑ</button>
          <button class="chat-hint" onclick="sendHint('Ë≥ºÂÖ•„Åæ„Åß„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´ÊÑü„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ')">Ë≥ºÂÖ•„Çπ„Ç±„Ç∏„É•„Éº„É´</button>
        </div>
      </div>
    </div>
    <div class="chat-input-bar" id="ai-chat-input-bar">
      <textarea id="chat-input" placeholder="MuchiNavi„Å´Ë≥™Âïè‚Ä¶" rows="1"></textarea>
      <button onclick="sendMessage()" id="chat-send-btn">ÈÄÅ‰ø°</button>
    </div>

    <!-- Direct Chat Room (new) -->
    <div class="chat-messages" id="direct-chat-messages" style="display: none;">
      <div class="chat-welcome" id="direct-chat-welcome">
        <div class="chat-welcome-icon">üí¨</div>
        <h3>ÊãÖÂΩì„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´Áõ¥Êé•Áõ∏Ë´á„Åß„Åç„Åæ„Åô</h3>
        <p>AI„Åß„ÅØ„Å™„Åè„ÄÅÊãÖÂΩì„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´Áõ¥Êé•„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çå„Åæ„Åô„ÄÇ<br>„ÅäËøî‰∫ã„Åæ„Åß„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„ÅèÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</p>
      </div>
    </div>
    <div class="chat-input-bar" id="direct-chat-input-bar" style="display: none;">
      <textarea id="direct-chat-input" placeholder="„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´„É°„ÉÉ„Çª„Éº„Ç∏‚Ä¶" rows="1"></textarea>
      <button onclick="sendDirectMessage()" id="direct-send-btn">ÈÄÅ‰ø°</button>
    </div>
  </div>

  <!-- ===== „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜÁîªÈù¢ ===== -->
  <div class="profile-screen" id="profile-screen">
    <div class="profile-header">
      <button class="profile-back-btn" onclick="closeProfile()">‚Üê „ÉÅ„É£„ÉÉ„Éà„Å´Êàª„Çã</button>
      <div class="profile-header-title">„Éû„Ç§„Éö„Éº„Ç∏</div>
    </div>
    <div class="profile-body">
      <div class="profile-section">
        <div class="profile-section-title">Âü∫Êú¨ÊÉÖÂ†±</div>
        <div class="profile-field">
          <label>„ÅäÂêçÂâç</label>
          <input type="text" id="prof-name" placeholder="‰æã: Â±±Áî∞Â§™ÈÉé">
        </div>
        <div class="profile-field">
          <label>Áîü„Åæ„ÇåÂπ¥</label>
          <select id="prof-birthYear">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          </select>
        </div>
        <div class="profile-field">
          <label>Áîü„Åæ„ÇåÊúà</label>
          <select id="prof-birthMonth">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          </select>
        </div>
        <div class="profile-field">
          <label>„Åä‰Ωè„Åæ„ÅÑ„ÅÆÈÉΩÈÅìÂ∫úÁúå</label>
          <select id="prof-prefecture">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          </select>
        </div>
        <div class="profile-field">
          <label>„ÅîÂÆ∂ÊóèÊßãÊàê</label>
          <input type="text" id="prof-family" placeholder="‰æã: Â§´Â©¶ÔºãÂ≠ê„Å©„ÇÇ1‰∫∫">
        </div>
        <div class="profile-field">
          <label>‰∏ñÂ∏ØÂπ¥Âèé</label>
          <select id="prof-householdIncome" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="„Äú499‰∏áÂÜÜ">„Äú499‰∏áÂÜÜ</option>
            <option value="500„Äú999‰∏áÂÜÜ">500„Äú999‰∏áÂÜÜ</option>
            <option value="1,000„Äú1,499‰∏áÂÜÜ">1,000„Äú1,499‰∏áÂÜÜ</option>
            <option value="1,500„Äú1,999‰∏áÂÜÜ">1,500„Äú1,999‰∏áÂÜÜ</option>
            <option value="2,000„Äú2,499‰∏áÂÜÜ">2,000„Äú2,499‰∏áÂÜÜ</option>
            <option value="2,500„Äú2,999‰∏áÂÜÜ">2,500„Äú2,999‰∏áÂÜÜ</option>
            <option value="3,000‰∏áÂÜÜ„Äú">3,000‰∏áÂÜÜ„Äú</option>
          </select>
        </div>
      </div>

      <div class="profile-section">
        <div class="profile-section-title">„Åä‰Ωè„Åæ„ÅÑ„ÅÆÂ∏åÊúõ</div>
        <div class="profile-field">
          <label>Áâ©‰ª∂Á®ÆÂà•</label>
          <select id="prof-propertyType" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="‰∏≠Âè§Êà∏Âª∫„Å¶">‰∏≠Âè§Êà∏Âª∫„Å¶</option>
            <option value="‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥">‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥</option>
            <option value="Êñ∞ÁØâÊà∏Âª∫„Å¶">Êñ∞ÁØâÊà∏Âª∫„Å¶</option>
            <option value="Ê≥®Êñá‰ΩèÂÆÖ">Ê≥®Êñá‰ΩèÂÆÖ</option>
          </select>
        </div>
        <div class="profile-field">
          <label>Â∏åÊúõ„Ç®„É™„Ç¢</label>
          <input type="text" id="prof-area" placeholder="‰æã: Êù±‰∫¨ÈÉΩ‰∏ñÁî∞Ë∞∑Âå∫">
        </div>
        <div class="profile-field">
          <label>„Åî‰∫àÁÆó</label>
          <input type="text" id="prof-budget" placeholder="‰æã: 5000‰∏áÂÜÜ">
        </div>
      </div>

      <div class="profile-section">
        <div class="profile-section-title">ÈÄ£Áµ°ÂÖà</div>
        <div class="profile-field">
          <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input type="email" id="prof-email" placeholder="example@mail.com">
        </div>
        <div class="profile-field">
          <label>ÈõªË©±Áï™Âè∑</label>
          <input type="tel" id="prof-phone" placeholder="090-XXXX-XXXX">
        </div>
        <div class="profile-field">
          <label>LINE ID</label>
          <input type="text" id="prof-line" placeholder="LINE ID">
        </div>
      </div>

      <button class="profile-save-btn" id="profile-save-btn" onclick="saveProfile()">Â§âÊõ¥„Çí‰øùÂ≠ò„Åô„Çã</button>

      <div class="profile-section" style="margin-top: 20px;">
        <div class="profile-section-title">„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</div>
        <div class="profile-field">
          <label>Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ</label>
          <div style="position: relative;">
            <input type="password" id="prof-new-password" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä" style="padding-right: 50px;">
            <button type="button" onclick="togglePasswordVisibility('prof-new-password', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
          </div>
        </div>
        <div class="profile-field">
          <label>Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
          <div style="position: relative;">
            <input type="password" id="prof-new-password-confirm" placeholder="„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ" style="padding-right: 50px;">
            <button type="button" onclick="togglePasswordVisibility('prof-new-password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
          </div>
        </div>
        <button class="profile-save-btn" style="margin-top: 12px; background: #34c759;" onclick="changeCustomerPassword()">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åô„Çã</button>
      </div>

      <div class="profile-toast" id="profile-toast"></div>
    </div>
  </div>

  <!-- ===== ÈÄÄ‰ºöÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ ===== -->
  <div class="overlay-modal" id="withdraw-modal">
    <div class="modal-inner">
      <div class="modal-inner-icon">üò¢</div>
      <h2 class="modal-inner-title">Êú¨ÂΩì„Å´ÈÄÄ‰ºö„Åó„Åæ„Åô„ÅãÔºü</h2>
      <p class="modal-inner-text">ÈÄÄ‰ºö„Åô„Çã„Å®„ÄÅ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂê´„ÇÄ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
      <div class="modal-btn-row">
        <button class="modal-btn modal-btn-cancel" onclick="closeWithdrawModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-danger" onclick="executeWithdraw()">ÈÄÄ‰ºö„Åô„Çã</button>
      </div>
    </div>
  </div>

  <!-- ===== „Éñ„É≠„ÉÉ„ÇØÁîªÈù¢ ===== -->
  <div class="blocked-screen" id="blocked-screen">
    <div class="blocked-icon">üö´</div>
    <h2 class="blocked-title">„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åõ„Çì</h2>
    <p class="blocked-text">„Åì„ÅÆ„Çµ„Éº„Éì„Çπ„ÅØÁèæÂú®„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åõ„Çì„ÄÇ<br>„Åî‰∏çÊòé„Å™ÁÇπ„Åå„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„Çâ„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
  </div>

  <script>
    // ===== Version check =====
    console.log('[MuchiNavi v2] „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü - ÊúÄÊñ∞„Éê„Éº„Ç∏„Éß„É≥');

    // ===== State =====
    const customerData = {};
    let currentStep = 0;
    let chatMessages = [];
    let sessionToken = null;
    let selectedChoiceValue = null; // Track selected choice value for later submission
    let currentChatRoom = 'ai'; // 'ai' or 'direct'
    let directChatMessages = [];
    const TOTAL_STEPS = 14; // 0=welcome, 1=name, 2=birthdate, 3=prefecture, 4=family, 5=householdIncome, 6=propertyType, 7=purpose, 8=searchReason, 9=area, 10=budget, 11=freeComment, 12=contact, 13=password

    // Prefecture data organized by region
    const prefecturesByRegion = {
      'ÂåóÊµ∑ÈÅì„ÉªÊù±Âåó': ['ÂåóÊµ∑ÈÅì', 'ÈùíÊ£Æ', 'Â≤©Êâã', 'ÂÆÆÂüé', 'ÁßãÁî∞', 'Â±±ÂΩ¢', 'Á¶èÂ≥∂'],
      'Èñ¢Êù±': ['Ëå®Âüé', 'Ê†ÉÊú®', 'Áæ§È¶¨', 'ÂüºÁéâ', 'ÂçÉËëâ', 'Êù±‰∫¨', 'Á•ûÂ•àÂ∑ù'],
      '‰∏≠ÈÉ®': ['Êñ∞ÊΩü', 'ÂØåÂ±±', 'Áü≥Â∑ù', 'Á¶è‰∫ï', 'Â±±Ê¢®', 'Èï∑Èáé', 'Â≤êÈòú', 'ÈùôÂ≤°', 'ÊÑõÁü•'],
      'ËøëÁïø': ['‰∏âÈáç', 'ÊªãË≥Ä', '‰∫¨ÈÉΩ', 'Â§ßÈò™', 'ÂÖµÂ∫´', 'Â•àËâØ', 'ÂíåÊ≠åÂ±±'],
      '‰∏≠ÂõΩ„ÉªÂõõÂõΩ': ['È≥•Âèñ', 'Â≥∂Ê†π', 'Â≤°Â±±', 'Â∫ÉÂ≥∂', 'Â±±Âè£', 'Âæ≥Â≥∂', 'È¶ôÂ∑ù', 'ÊÑõÂ™õ', 'È´òÁü•'],
      '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ': ['Á¶èÂ≤°', '‰ΩêË≥Ä', 'Èï∑Â¥é', 'ÁÜäÊú¨', 'Â§ßÂàÜ', 'ÂÆÆÂ¥é', 'ÈπøÂÖêÂ≥∂', 'Ê≤ñÁ∏Ñ'],
    };

    // ===== Steps config =====
    const steps = [
      {
        type: 'welcome',
        icon: 'üè†',
        title: 'MuchiNavi„Å∏„Çà„ÅÜ„Åì„Åù',
        subtitle: 'AI„Åå„ÅÇ„Å™„Åü„ÅÆ‰Ωè„Åæ„ÅÑÊé¢„Åó„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ\nÁ∞°Âçò„Å™Ë≥™Âïè„Å´Á≠î„Åà„Çã„Å†„Åë„Åß„ÄÅ„ÅÇ„Å™„ÅüÂ∞ÇÁî®„ÅÆ„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº„ÅåÊ∫ñÂÇô„Åß„Åç„Åæ„Åô„ÄÇ',
        buttonText: '„ÅØ„Åò„ÇÅ„Çã ‚ú®',
      },
      {
        type: 'text',
        key: 'name',
        icon: 'üòä',
        title: '„ÅäÂêçÂâç„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: '‚Äª Êú¨Âêç„Åß„ÅÆ„ÅîË®òÂÖ•„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºà‰ªäÂæå„ÅÆ„ÇÑ„ÇäÂèñ„Çä„ÅßÊ≠£Á¢∫„Å´„Çµ„Éù„Éº„Éà„Åô„Çã„Åü„ÇÅÔºâ',
        placeholder: '‰æã: Â±±Áî∞Â§™ÈÉé',
        required: true,
        response: (val) => `${val}„Åï„Çì„ÄÅ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºÅ`,
      },
      {
        type: 'birthdate',
        key: 'birthInfo',
        icon: 'üéÇ',
        title: '{name}„Åï„Çì„ÅÆÁîü„Åæ„ÇåÂπ¥„Å®\nÁîü„Åæ„ÇåÊúà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: '„É©„Ç§„Éï„Éó„É©„É≥„ÅÆ‰ΩúÊàê„Å´‰ΩøÁî®„Åó„Åæ„Åô',
        required: true,
        response: (val) => `„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ`,
      },
      {
        type: 'prefecture',
        key: 'prefecture',
        icon: 'üóæ',
        title: '{name}„Åï„Çì„Åå\n‰ªä„Åä‰Ωè„Åæ„ÅÑ„ÅÆÈÉΩÈÅìÂ∫úÁúå„ÅØÔºü',
        subtitle: '',
        required: true,
        response: (val) => `${val}„Å´„Åä‰Ωè„Åæ„ÅÑ„Å™„Çì„Åß„Åô„Å≠ÔºÅ`,
      },
      {
        type: 'choice',
        key: 'family',
        icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
        title: '{name}„Åï„Çì„ÅØ\nË™∞„Å®‰∏ÄÁ∑í„Å´‰Ωè„ÇÄ‰∫àÂÆö„Åß„Åô„ÅãÔºü',
        subtitle: '',
        choices: [
          { icon: 'üßë', label: '„Åä„Å≤„Å®„Çä', value: 'ÂçòË∫´' },
          { icon: 'üë´', label: '„Éë„Éº„Éà„Éä„Éº„Å®', value: '„Éë„Éº„Éà„Éä„Éº„Å®‰∫å‰∫∫' },
          { icon: 'üë®‚Äçüë©‚Äçüëß', label: 'ÂÆ∂Êóè„Åß', value: 'ÂÆ∂Êóè', hasSubQuestion: true },
          { icon: 'ü§î', label: '„Åæ„Å†Ê±∫„ÇÅ„Å¶„Å™„ÅÑ', value: 'Êú™ÂÆö' },
        ],
        subQuestion: {
          label: '„ÅäÂ≠êÊßò„ÅØ‰Ωï‰∫∫„Åß„Åô„ÅãÔºü',
          type: 'choice-inline',
          options: ['1‰∫∫', '2‰∫∫', '3‰∫∫‰ª•‰∏ä'],
        },
        response: (val) => `${val}„Åß„ÅÆ„Åä‰Ωè„Åæ„ÅÑ„Åß„Åô„Å≠ÔºÅ`,
      },
      {
        type: 'choice',
        key: 'householdIncome',
        icon: 'üíº',
        title: '{name}„Åï„Çì„ÅÆ\n‰∏ñÂ∏ØÂπ¥Âèé„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: '„É≠„Éº„É≥„ÅÆÁõÆÂÆâ„ÇÑË≥áÈáëË®àÁîª„Å´Ê¥ªÁî®„Åó„Åæ„Åô',
        choices: [
          { icon: '', label: '„Äú499‰∏áÂÜÜ', value: '„Äú499‰∏áÂÜÜ' },
          { icon: '', label: '500„Äú999‰∏áÂÜÜ', value: '500„Äú999‰∏áÂÜÜ' },
          { icon: '', label: '1,000„Äú1,499‰∏áÂÜÜ', value: '1,000„Äú1,499‰∏áÂÜÜ' },
          { icon: '', label: '1,500„Äú1,999‰∏áÂÜÜ', value: '1,500„Äú1,999‰∏áÂÜÜ' },
          { icon: '', label: '2,000„Äú2,499‰∏áÂÜÜ', value: '2,000„Äú2,499‰∏áÂÜÜ' },
          { icon: '', label: '2,500„Äú2,999‰∏áÂÜÜ', value: '2,500„Äú2,999‰∏áÂÜÜ' },
          { icon: '', label: '3,000‰∏áÂÜÜ„Äú', value: '3,000‰∏áÂÜÜ„Äú' },
        ],
        response: (val) => `„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ`,
      },
      {
        type: 'choice',
        key: 'propertyType',
        icon: 'üèóÔ∏è',
        title: '„Å©„Çì„Å™‰Ωè„Åæ„ÅÑ„Çí„ÅäËÄÉ„Åà„Åß„Åô„ÅãÔºü',
        subtitle: '‰ªä„ÅÆ„Ç§„É°„Éº„Ç∏„ÅßÂ§ß‰∏àÂ§´„Åß„Åô',
        choices: [
          { icon: 'üè†', label: '‰∏≠Âè§Êà∏Âª∫„Å¶', value: '‰∏≠Âè§Êà∏Âª∫„Å¶' },
          { icon: 'üè¢', label: '‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥', value: '‰∏≠Âè§„Éû„É≥„Ç∑„Éß„É≥' },
          { icon: 'üè°', label: 'Êñ∞ÁØâÊà∏Âª∫„Å¶', value: 'Êñ∞ÁØâÊà∏Âª∫„Å¶' },
          { icon: 'üèóÔ∏è', label: 'Ê≥®Êñá‰ΩèÂÆÖ', value: 'Ê≥®Êñá‰ΩèÂÆÖ' },
        ],
        response: (val) => `${val}„Çí„ÅäÊé¢„Åó„Å™„Çì„Åß„Åô„Å≠ÔºÅ`,
      },
      {
        type: 'choice',
        key: 'purpose',
        icon: 'üéØ',
        title: '‰ªäÂõû„ÅØ„Å©„Çì„Å™„Åç„Å£„Åã„Åë„Åß\n„ÅîÁôªÈå≤„ÅÑ„Åü„Å†„Åç„Åæ„Åó„Åü„ÅãÔºü',
        subtitle: '‰∏ÄÁï™Ëøë„ÅÑ„ÇÇ„ÅÆ„Çí„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑ',
        choices: [
          { icon: 'üîç', label: '‰Ωè„Åæ„ÅÑÊé¢„ÅóÂÖ®Ëà¨', value: '‰Ωè„Åæ„ÅÑÊé¢„ÅóÂÖ®Ëà¨' },
          { icon: 'üì∞', label: 'Ë®ò‰∫ã„ÅåÂèÇËÄÉ„Å´„Å™„Å£„Åü', value: 'Ë®ò‰∫ã„ÅåÂèÇËÄÉ„Å´„Å™„Å£„Åü' },
          { icon: 'ü§ù', label: '„Éè„Ç¶„Çπ„É°„Éº„Ç´„ÉºÁ¥π‰ªã', value: '„Éè„Ç¶„Çπ„É°„Éº„Ç´„ÉºÁ¥π‰ªã„ÉªÂâ≤Âºï„ÇíÂèó„Åë„Åü„ÅÑ' },
          { icon: 'üí¨', label: '„Å®„Çä„ÅÇ„Åà„ÅöÁõ∏Ë´á', value: '„Å®„Çä„ÅÇ„Åà„ÅöÁõ∏Ë´á„Åó„Åü„ÅÑ' },
        ],
        response: (val) => `„Å™„Çã„Åª„Å©„ÄÅÊâøÁü•„Åó„Åæ„Åó„ÅüÔºÅ`,
      },
      {
        type: 'textarea',
        key: 'searchReason',
        icon: 'üìù',
        title: '{name}„Åï„Çì„Åå‰Ωè„Åæ„ÅÑ„ÇíÊé¢„Åó„Å¶„ÅÑ„Çã\nÁêÜÁî±„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: 'Ë©≥„Åó„ÅèÊõ∏„ÅÑ„Å¶„ÅÑ„Åü„Å†„Åè„Åª„Å©„ÄÅÁöÑÁ¢∫„Å™„Çµ„Éù„Éº„Éà„Åå„Åß„Åç„Åæ„Åô',
        placeholder: '‰æã: Â≠ê„Å©„ÇÇ„ÅåÂ∞èÂ≠¶Ê†°„Å´‰∏ä„Åå„Çã„Çø„Ç§„Éü„É≥„Ç∞„Åß„ÄÅÂ≠¶Âå∫„ÅÆËâØ„ÅÑ„Ç®„É™„Ç¢„Å´Âºï„Å£Ë∂ä„Åó„Åü„ÅÑ',
        required: true,
        response: (val) => `Ë©≥„Åó„Åè„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ`,
      },
      {
        type: 'text',
        key: 'area',
        icon: 'üìç',
        title: '„Å©„ÅÆ„ÅÇ„Åü„Çä„Å´‰Ωè„Åø„Åü„ÅÑ„Åß„Åô„ÅãÔºü',
        subtitle: '„Åæ„Å†Ê±∫„Åæ„Å£„Å¶„ÅÑ„Å™„Åè„Å¶„ÇÇÂ§ß‰∏àÂ§´„Åß„Åô',
        placeholder: '‰æã: ‰∏ñÁî∞Ë∞∑Âå∫„ÄÅÊ®™ÊµúÂ∏Ç',
        skipText: '„Åæ„Å†Ê±∫„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ',
        skipValue: 'Êú™ÂÆöÔºà‰∏ÄÁ∑í„Å´Êé¢„Åó„Åü„ÅÑÔºâ',
        skipResponse: 'Â§ß‰∏àÂ§´„Åß„ÅôÔºÅ‰∏ÄÁ∑í„Å´Êé¢„Åó„Åæ„Åó„Çá„ÅÜ üîç',
        response: (val) => `${val}„Ç®„É™„Ç¢„Åß„Åô„Å≠„ÄÅÁ¥†Êïµ„Å™Â†¥ÊâÄ„Åß„Åô„Å≠ÔºÅ`,
      },
      {
        type: 'slider',
        key: 'budget',
        icon: 'üí∞',
        title: '„Åî‰∫àÁÆó„ÅÆ„Ç§„É°„Éº„Ç∏„ÅØÔºü',
        subtitle: '„Åñ„Å£„Åè„Çä„ÅßÂ§ß‰∏àÂ§´„Åß„Åô„ÄÇ„ÅÇ„Å®„Åã„ÇâÂ§âÊõ¥„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ',
        min: 2000,
        max: 15000,
        step: 500,
        default: 5000,
        format: (val) => {
          if (val >= 10000) return `${(val/10000).toFixed(1)}ÂÑÑÂÜÜ`;
          return `${val.toLocaleString()}‰∏áÂÜÜ`;
        },
        skipText: '„Åæ„Å†„Çè„Åã„Çâ„Å™„ÅÑ',
        skipValue: 'Êú™ÂÆö',
        skipResponse: 'ÂÖ®ÁÑ∂OK„Åß„ÅôÔºÅ„Åì„Çå„Åã„Çâ‰∏ÄÁ∑í„Å´ËÄÉ„Åà„Åæ„Åó„Çá„ÅÜ üí°',
        response: (val) => `‰∫ÜËß£„Åß„ÅôÔºÅ„Å¥„Å£„Åü„Çä„ÅÆÁâ©‰ª∂„ÇíÊé¢„Åó„Åæ„Åó„Çá„ÅÜ`,
      },
      {
        type: 'textarea',
        key: 'freeComment',
        icon: 'üí¨',
        title: 'ÊúÄÂæå„Å´„ÄÅ‰Ωï„ÅãÊ∞ó„Å´„Å™„Çã„Åì„Å®„ÇÑ\n„ÅîË¶ÅÊúõ„Åå„ÅÇ„Çå„Å∞„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ',
        subtitle: '‰Ωï„Åß„ÇÇOK„Åß„ÅôÔºÅÁ©∫ÁôΩ„ÅÆ„Åæ„ÅæÈÄ≤„ÇÄ„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô',
        placeholder: '‰æã: ÈßÖËøë„Åå„ÅÑ„ÅÑ„ÄÅ„Éö„ÉÉ„ÉàÂèØ„ÅÆÁâ©‰ª∂„ÅåÂ∏åÊúõ„ÄÅ‰∫àÁÆóÂÜÖ„ÅßÊúÄÂ§ßÈôê„ÅÆÂ∫É„Åï„Åå„Åª„Åó„ÅÑ‚Ä¶„Å™„Å©',
        required: false,
        skipText: 'Áâπ„Å´„Å™„ÅÑ„ÅÆ„ÅßÊ¨°„Å∏',
        skipValue: '',
        skipResponse: '‰∫ÜËß£„Åß„ÅôÔºÅ',
        response: (val) => `„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Åó„Å£„Åã„ÇäÂèÇËÄÉ„Å´„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô`,
      },
      {
        type: 'contact',
        key: 'contact',
        icon: 'üì±',
        title: 'ÈÄ£Áµ°ÂÖà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: 'ÂÄã‰∫∫„ÉÅ„É£„ÉÉ„Éà„ÅÆÈÄöÁü•„ÇÑ„ÄÅÈáçË¶Å„Å™„ÅîÈÄ£Áµ°„Å´‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ\nÊÉÖÂ†±„ÅØÂé≥Èáç„Å´ÁÆ°ÁêÜ„Åó„Åæ„Åô„ÅÆ„Åß„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ',
        response: () => 'Ê¨°„Å∏ÈÄ≤„Åø„Åæ„ÅôÔºÅ',
      },
      {
        type: 'password',
        key: 'password',
        icon: 'üîí',
        title: '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        subtitle: '‰ªñ„ÅÆÁ´ØÊú´„Åã„Çâ„ÇÇ„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô',
        required: true,
        response: () => 'Ë®≠ÂÆöÂÆå‰∫ÜÔºÅ',
      },
    ];

    // ===== Render step =====
    function renderStep(stepIdx) {
      const step = steps[stepIdx];
      const card = document.getElementById('step-card');
      const progress = document.getElementById('progress');

      // Show progress from step 1
      if (stepIdx > 0) {
        progress.style.display = 'block';
        renderProgress(stepIdx);
      }

      // Replace title template
      let title = step.title;
      if (customerData.name) {
        title = title.replace('{name}', customerData.name);
      }
      let subtitle = step.subtitle || '';

      // Back button (appended after action buttons, not on welcome step 0)
      let backButtonHTML = '';
      if (stepIdx > 0) {
        backButtonHTML = `<div style="margin-top: 12px;"><button class="back-button" onclick="prevStep()">‚Üê Êàª„Çã</button></div>`;
      }

      let html = `
        <div class="step-icon">${step.icon}</div>
        <h2 class="step-title">${title.replace(/\n/g, '<br>')}</h2>
        ${subtitle ? `<p class="step-subtitle">${subtitle.replace(/\n/g, '<br>')}</p>` : ''}
      `;

      if (step.type === 'welcome') {
        html += `<button class="btn-primary" onclick="nextStep()">${step.buttonText}</button>`;
        html += `
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">„Åô„Åß„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ</p>
            <button class="btn-login" onclick="showLoginForm()">„É≠„Ç∞„Ç§„É≥</button>
          </div>
        `;
      }
      else if (step.type === 'text') {
        const prefillValue = step.key && customerData[step.key] ? customerData[step.key] : '';
        html += `
          <input class="input-field" type="text" id="step-input"
            placeholder="${step.placeholder || ''}"
            value="${prefillValue}"
            onkeypress="if(event.key==='Enter' && this.value.trim())nextStep(this.value.trim())">
          <div style="margin-top: 16px;">
            <button class="btn-primary" onclick="submitTextStep()" id="next-btn">Ê¨°„Å∏ ‚Üí</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'textarea') {
        const prefillValue = step.key && customerData[step.key] ? customerData[step.key] : '';
        html += `
          <textarea class="input-field" id="step-input"
            placeholder="${step.placeholder || ''}"
            rows="4"
            style="resize: vertical; min-height: 100px; font-family: inherit; line-height: 1.6;">${prefillValue}</textarea>
          <div style="margin-top: 16px;">
            <button class="btn-primary" onclick="submitTextStep()" id="next-btn">Ê¨°„Å∏ ‚Üí</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'choice') {
        html += `<div class="choices">`;
        step.choices.forEach((c, i) => {
          const isSelected = selectedChoiceValue === c.value;
          const selectedClass = isSelected ? 'selected' : '';
          html += `
            <div class="choice-card ${selectedClass}" onclick="selectChoice(${i}, '${c.value}', ${!!c.hasSubQuestion})">
              <div class="choice-icon">${c.icon}</div>
              <div class="choice-label">${c.label}</div>
            </div>
          `;
        });
        html += `</div>`;
        html += `<div id="sub-question-area"></div>`;
        const btnShowClass = selectedChoiceValue !== null ? 'show' : '';
        html += `<button class="next-choice-btn ${btnShowClass}" id="next-choice-btn" onclick="submitChoiceStep()">Ê¨°„Å∏ ‚Üí</button>`;
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'birthdate') {
        const currentYear = new Date().getFullYear();
        let yearOptions = '';
        for (let y = 2010; y >= 1950; y--) {
          const selected = customerData.birthYear === y ? 'selected' : '';
          yearOptions += `<option value="${y}" ${selected}>${y}Âπ¥</option>`;
        }
        let monthOptions = '';
        for (let m = 1; m <= 12; m++) {
          const selected = customerData.birthMonth === m ? 'selected' : '';
          monthOptions += `<option value="${m}" ${selected}>${m}Êúà</option>`;
        }
        html += `
          <div class="birthdate-container">
            <div class="birthdate-selector">
              <label>Áîü„Åæ„ÇåÂπ¥</label>
              <select id="birth-year" onchange="validateBirthdate()">
                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                ${yearOptions}
              </select>
            </div>
            <div class="birthdate-selector">
              <label>Áîü„Åæ„ÇåÊúà</label>
              <select id="birth-month" onchange="validateBirthdate()">
                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                ${monthOptions}
              </select>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-primary" id="submit-birthdate-btn" onclick="submitBirthdate()" disabled>Ê¨°„Å∏ ‚Üí</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'prefecture') {
        let prefectureHTML = '';
        for (const [region, prefs] of Object.entries(prefecturesByRegion)) {
          prefectureHTML += `<div class="prefecture-region-header">${region}</div>`;
          prefs.forEach(pref => {
            const selected = customerData.prefecture === pref ? 'selected' : '';
            prefectureHTML += `<button class="prefecture-btn ${selected}" onclick="selectPrefecture('${pref}', event)">${pref}</button>`;
          });
        }
        html += `
          <div class="prefecture-grid">
            ${prefectureHTML}
          </div>
          <button class="next-choice-btn" id="next-prefecture-btn" onclick="submitPrefectureStep()" style="display: ${customerData.prefecture ? 'inline-flex' : 'none'};">Ê¨°„Å∏ ‚Üí</button>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'slider') {
        // Try to restore previous budget value from customerData
        let sliderValue = step.default;
        if (step.key && customerData[step.key]) {
          // Extract the numeric value from the formatted budget string
          const budgetStr = customerData[step.key];
          const numMatch = budgetStr.match(/(\d+)/);
          if (numMatch) {
            sliderValue = parseInt(numMatch[1]) * 500; // Assuming 500 step
          }
        }
        html += `
          <div class="slider-container">
            <div class="budget-display" id="budget-display">${step.format(sliderValue)}</div>
            <input type="range" id="budget-slider"
              min="${step.min}" max="${step.max}" step="${step.step}" value="${sliderValue}"
              oninput="updateBudget(this.value)">
            <div class="slider-labels">
              <span>${step.format(step.min)}</span>
              <span>${step.format(step.max)}„Äú</span>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-primary" onclick="submitSlider()">Ê¨°„Å∏ ‚Üí</button>
          </div>
        `;
        if (step.skipText) {
          html += `<div style="margin-top: 12px;"><button class="btn-secondary" onclick="skipStep()">${step.skipText}</button></div>`;
        }
        html += `<div class="step-response" id="step-response"></div>`;
      }
      else if (step.type === 'contact') {
        html += `
          <div style="text-align: left; display: flex; flex-direction: column; gap: 14px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ <span style="color: var(--danger);">*</span></label>
              <input class="input-field" type="email" id="contact-email" placeholder="example@email.com" style="text-align: left;">
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">ÈõªË©±Áï™Âè∑Ôºà‰ªªÊÑèÔºâ</label>
              <input class="input-field" type="tel" id="contact-phone" placeholder="090-xxxx-xxxx" style="text-align: left;">
            </div>
          </div>
          <div style="margin-top: 24px;">
            <button class="btn-primary" onclick="submitContact()">Ê¨°„Å∏ ‚Üí</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }
      else if (step.type === 'password') {
        html += `
          <div style="text-align: left; display: flex; flex-direction: column; gap: 14px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„Éë„Çπ„ÉØ„Éº„Éâ <span style="color: var(--danger);">*</span></label>
              <div style="position: relative;">
                <input class="input-field" type="password" id="password-input" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä" style="text-align: left; padding-right: 50px;">
                <button type="button" onclick="togglePasswordVisibility('password-input', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
              </div>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px;">„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ <span style="color: var(--danger);">*</span></label>
              <div style="position: relative;">
                <input class="input-field" type="password" id="password-confirm" placeholder="„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ" style="text-align: left; padding-right: 50px;">
                <button type="button" onclick="togglePasswordVisibility('password-confirm', this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;font-family:inherit;font-weight:600;">Ë°®Á§∫</button>
              </div>
            </div>
            <p style="font-size: 11px; color: var(--text-light); margin-top: 4px;">
              ‚Äª „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Åì„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„Åß„ÄÅ„Å©„ÅÆÁ´ØÊú´„Åã„Çâ„Åß„ÇÇ„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åô
            </p>
          </div>
          <div style="margin-top: 24px;">
            <button class="btn-primary" onclick="submitPassword()">ÁôªÈå≤„Åô„Çã üéâ</button>
          </div>
          <div class="step-response" id="step-response"></div>
        `;
      }

      // Append back button at the bottom (after all action buttons)
      html += backButtonHTML;

      // Animate transition
      card.classList.add('leaving');
      setTimeout(() => {
        card.classList.remove('leaving');
        card.innerHTML = html;
        card.style.animation = 'none';
        card.offsetHeight; // trigger reflow
        card.style.animation = '';

        // Focus input
        const input = document.getElementById('step-input');
        if (input) setTimeout(() => input.focus(), 300);
      }, 250);
    }

    function renderProgress(stepIdx) {
      const dots = document.getElementById('progress-dots');
      const label = document.getElementById('progress-label');
      let html = '';
      for (let i = 1; i < TOTAL_STEPS; i++) {
        let cls = 'progress-dot';
        if (i < stepIdx) cls += ' done';
        else if (i === stepIdx) cls += ' active';
        html += `<div class="${cls}"></div>`;
      }
      dots.innerHTML = html;
      label.textContent = `„Çπ„ÉÜ„ÉÉ„Éó ${stepIdx} / ${TOTAL_STEPS - 1}`;
    }

    // ===== Step handlers =====
    function nextStep(value) {
      const step = steps[currentStep];
      if (value !== undefined && step.key) {
        customerData[step.key] = value;
      }

      // Show response if exists
      if (step.response && value !== undefined) {
        showResponse(step.response(value));
        setTimeout(() => {
          currentStep++;
          if (currentStep < TOTAL_STEPS) {
            renderStep(currentStep);
          } else {
            showCompletion();
          }
        }, 1200);
      } else {
        currentStep++;
        if (currentStep < TOTAL_STEPS) {
          renderStep(currentStep);
        } else {
          showCompletion();
        }
      }
    }

    function submitTextStep() {
      const input = document.getElementById('step-input');
      const val = input.value.trim();
      if (!val) {
        input.style.borderColor = 'var(--danger)';
        input.focus();
        return;
      }
      nextStep(val);
    }

    function skipStep() {
      const step = steps[currentStep];
      customerData[step.key] = step.skipValue;
      showResponse(step.skipResponse);
      setTimeout(() => {
        currentStep++;
        renderStep(currentStep);
      }, 1200);
    }

    function selectChoice(idx, value, hasSub) {
      // Highlight selected
      document.querySelectorAll('.choice-card').forEach((c, i) => {
        c.classList.toggle('selected', i === idx);
      });

      if (hasSub) {
        const step = steps[currentStep];
        const area = document.getElementById('sub-question-area');
        selectedChoiceValue = value; // Store the value with sub-question
        area.innerHTML = `
          <div class="sub-question">
            <label>${step.subQuestion.label}</label>
            <div style="display: flex; gap: 8px; justify-content: center;">
              ${step.subQuestion.options.map(opt =>
                `<button class="chat-hint" onclick="submitChoiceWithSub('${value}', '${opt}')" style="font-size: 14px; padding: 10px 18px;">${opt}</button>`
              ).join('')}
            </div>
          </div>
        `;
        // Show next button after sub-question appears
        const nextBtn = document.getElementById('next-choice-btn');
        if (nextBtn) {
          setTimeout(() => nextBtn.classList.add('show'), 100);
        }
      } else {
        // No sub-question: store value and show next button
        selectedChoiceValue = value;
        const nextBtn = document.getElementById('next-choice-btn');
        if (nextBtn) {
          nextBtn.classList.add('show');
        }
      }
    }

    function submitChoiceStep() {
      if (selectedChoiceValue !== null) {
        nextStep(selectedChoiceValue);
        selectedChoiceValue = null;
      }
    }

    function submitChoiceWithSub(mainVal, subVal) {
      nextStep(`${mainVal}ÔºàÂ≠ê„Å©„ÇÇ${subVal}Ôºâ`);
      selectedChoiceValue = null;
    }

    function validateBirthdate() {
      const yearSelect = document.getElementById('birth-year');
      const monthSelect = document.getElementById('birth-month');
      const submitBtn = document.getElementById('submit-birthdate-btn');
      const year = yearSelect.value;
      const month = monthSelect.value;

      if (year && month) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
    }

    function submitBirthdate() {
      const year = parseInt(document.getElementById('birth-year').value);
      const month = parseInt(document.getElementById('birth-month').value);

      if (!year || !month) {
        return;
      }

      // Calculate age
      const today = new Date();
      let age = today.getFullYear() - year;
      if (today.getMonth() < month - 1 || (today.getMonth() === month - 1 && today.getDate() < 1)) {
        age--;
      }

      customerData.birthYear = year;
      customerData.birthMonth = month;
      customerData.age = age;

      nextStep(`${year}Âπ¥${month}ÊúàÁîü„Åæ„Çå`);
    }

    function selectPrefecture(prefName, evt) {
      // Unselect all, select this one
      document.querySelectorAll('.prefecture-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      if (evt && evt.target) {
        evt.target.classList.add('selected');
      }
      customerData.prefecture = prefName;

      // Show next button
      const nextBtn = document.getElementById('next-prefecture-btn');
      if (nextBtn) {
        nextBtn.style.display = 'inline-flex';
        setTimeout(() => nextBtn.classList.add('show'), 50);
      }
    }

    function submitPrefectureStep() {
      if (customerData.prefecture) {
        nextStep(customerData.prefecture);
      }
    }

    function prevStep() {
      // Go back one step
      if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
      }
    }

    function updateBudget(val) {
      const step = steps[currentStep];
      document.getElementById('budget-display').textContent = step.format(parseInt(val));
    }

    function submitSlider() {
      const step = steps[currentStep];
      const val = document.getElementById('budget-slider').value;
      nextStep(step.format(parseInt(val)));
    }

    function submitContact() {
      const email = document.getElementById('contact-email').value.trim();
      const phone = document.getElementById('contact-phone').value.trim();

      if (!email || !email.includes('@')) {
        document.getElementById('contact-email').style.borderColor = 'var(--danger)';
        document.getElementById('contact-email').focus();
        return;
      }

      customerData.email = email;
      customerData.phone = phone || 'Êú™ÂÖ•Âäõ';
      nextStep('contact-done');
    }

    function submitPassword() {
      const pw = document.getElementById('password-input').value;
      const pwConfirm = document.getElementById('password-confirm').value;

      if (!pw || pw.length < 6) {
        document.getElementById('password-input').style.borderColor = 'var(--danger)';
        document.getElementById('password-input').focus();
        return;
      }
      if (pw !== pwConfirm) {
        document.getElementById('password-confirm').style.borderColor = 'var(--danger)';
        document.getElementById('password-confirm').focus();
        return;
      }

      customerData.password = pw;
      // „Éë„Çπ„ÉØ„Éº„ÉâËá™‰Ωì„Çí value „Å®„Åó„Å¶Ê∏°„ÅôÔºànextStep„Åßstep.key='password'„Å´pw„ÅåÂÖ•„ÇãÔºù‰∏äÊõ∏„Åç„Åï„Çå„Å¶„ÇÇÂêå„ÅòÂÄ§Ôºâ
      nextStep(pw);
    }

    function showResponse(text) {
      const el = document.getElementById('step-response');
      if (el) {
        el.textContent = text;
        setTimeout(() => el.classList.add('show'), 50);
      }
    }

    // ===== Login Functions =====
    function showLoginForm() {
      document.getElementById('login-screen').classList.add('active');
      setTimeout(() => document.getElementById('login-email').focus(), 100);
    }

    function hideLoginForm() {
      document.getElementById('login-screen').classList.remove('active');
      document.getElementById('login-error').style.display = 'none';
    }

    // ===== „Éë„Çπ„ÉØ„Éº„ÉâË°®Á§∫ÂàáÊõø =====
    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'ÈùûË°®Á§∫';
      } else {
        input.type = 'password';
        btn.textContent = 'Ë°®Á§∫';
      }
    }

    // ===== „É™„Çª„ÉÉ„Éà„Éï„Ç©„Éº„É†Ë°®Á§∫ÂàáÊõø =====
    function showResetForm() {
      document.getElementById('login-form-card').style.display = 'none';
      document.getElementById('reset-form-card').style.display = '';
      document.getElementById('reset-email').value = '';
      document.getElementById('reset-error').style.display = 'none';
      document.getElementById('reset-success').style.display = 'none';
      document.getElementById('reset-password-section').style.display = 'none';
      document.getElementById('reset-btn').textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç';
      document.getElementById('reset-btn').onclick = doVerifyEmail;
      setTimeout(() => document.getElementById('reset-email').focus(), 100);
    }

    function showLoginCard() {
      document.getElementById('reset-form-card').style.display = 'none';
      document.getElementById('login-form-card').style.display = '';
      document.getElementById('login-error').style.display = 'none';
      setTimeout(() => document.getElementById('login-email').focus(), 100);
    }

    // ===== „É°„Éº„É´Á¢∫Ë™ç ‚Üí „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà =====
    async function doVerifyEmail() {
      const email = document.getElementById('reset-email').value.trim();
      const errorDiv = document.getElementById('reset-error');
      const successDiv = document.getElementById('reset-success');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!email) {
        errorDiv.textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        const data = await res.json();

        if (!res.ok || !data.verified) {
          errorDiv.textContent = data.error || 'Á¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
          errorDiv.style.display = 'block';
          return;
        }

        // „É°„Éº„É´Á¢∫Ë™çÊàêÂäü ‚Üí „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•ÂäõÊ¨Ñ„ÇíË°®Á§∫
        successDiv.textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÁ¢∫Ë™ç„Åß„Åç„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        successDiv.style.display = 'block';
        document.getElementById('reset-password-section').style.display = '';
        document.getElementById('reset-email').disabled = true;
        document.getElementById('reset-btn').textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçË®≠ÂÆö„Åô„Çã';
        document.getElementById('reset-btn').onclick = doResetPassword;
        setTimeout(() => document.getElementById('reset-new-password').focus(), 100);
      } catch (e) {
        errorDiv.textContent = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        errorDiv.style.display = 'block';
      }
    }

    async function doResetPassword() {
      const email = document.getElementById('reset-email').value.trim();
      const pw = document.getElementById('reset-new-password').value;
      const pwConfirm = document.getElementById('reset-new-password-confirm').value;
      const errorDiv = document.getElementById('reset-error');
      const successDiv = document.getElementById('reset-success');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!pw || pw.length < 6) {
        errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        errorDiv.style.display = 'block';
        return;
      }
      if (pw !== pwConfirm) {
        errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: pw }),
        });
        const data = await res.json();

        if (!res.ok || !data.reset) {
          errorDiv.textContent = data.error || 'ÂÜçË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
          errorDiv.style.display = 'block';
          return;
        }

        successDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Å£„Å¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        successDiv.style.display = 'block';
        document.getElementById('reset-btn').style.display = 'none';
        setTimeout(() => showLoginCard(), 2500);
      } catch (e) {
        errorDiv.textContent = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        errorDiv.style.display = 'block';
      }
    }

    async function doLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');

      if (!email) {
        errorDiv.textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: password || '' }),
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          errorDiv.textContent = data.error || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
          errorDiv.style.display = 'block';
          return;
        }

        // Login success
        sessionToken = data.token;
        localStorage.setItem('muchinavi_token', sessionToken);
        history.replaceState(null, '', `?t=${sessionToken}`);
        Object.assign(customerData, data.customer);
        chatMessages = data.chatHistory || [];
        directChatMessages = data.directChatHistory || [];

        hideLoginForm();
        startChat();

        // „Éë„Çπ„ÉØ„Éº„ÉâÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÄÅ„Éû„Ç§„Éö„Éº„Ç∏„ÇíÈñã„ÅÑ„Å¶„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö„Çí‰øÉ„Åô
        if (data.needsPassword) {
          setTimeout(() => {
            openProfile();
            showProfileToast('„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅ„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
          }, 500);
        }
      } catch (e) {
        errorDiv.textContent = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        errorDiv.style.display = 'block';
      }
    }

    // ===== Completion =====
    function showCompletion() {
      document.getElementById('progress').style.display = 'none';
      const card = document.getElementById('step-card');
      card.classList.add('leaving');

      setTimeout(() => {
        card.classList.remove('leaving');
        card.innerHTML = `
          <div class="completion-check">
            <svg viewBox="0 0 24 24"><polyline points="4 12 10 18 20 6"></polyline></svg>
          </div>
          <h2 class="step-title">ÁôªÈå≤ÂÆå‰∫ÜÔºÅ</h2>
          <p class="step-subtitle">
            ${customerData.name}„Åï„ÇìÂ∞ÇÁî®„ÅÆ<br>AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅåÊ∫ñÂÇô„Åß„Åç„Åæ„Åó„Åü
          </p>
          <button class="btn-primary" onclick="startChat()" style="margin-top: 8px;">
            MuchiNavi„Å´Áõ∏Ë´á„Åô„Çã üí¨
          </button>
          <p style="font-size: 11px; color: var(--text-light); margin-top: 16px;">
            Â≤°Êú¨„Åã„ÇâÁõ¥Êé•„ÅîÈÄ£Áµ°„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô
          </p>
        `;
        card.style.animation = 'none';
        card.offsetHeight;
        card.style.animation = '';

        // Send notification to agent
        notifyAgent();
      }, 250);
    }

    // ===== Notify Agent & Save =====
    async function notifyAgent() {
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customerData),
        });
        const data = await res.json();
        if (data.token) {
          sessionToken = data.token;
          // Save token to localStorage AND update URL
          localStorage.setItem('muchinavi_token', sessionToken);
          history.replaceState(null, '', `?t=${sessionToken}`);
        }
      } catch (e) {
        console.error('ÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:', e);
      }
    }

    // ===== Chat =====
    function startChat() {
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('chat-screen').classList.add('active');
      document.getElementById('chat-customer-name').textContent =
        `${customerData.name}„Åï„Çì„ÅÆ‰Ωè„Åæ„ÅÑÁõ∏Ë´á`;

      // Restore chat history if any
      if (chatMessages.length > 0) {
        document.getElementById('chat-welcome').style.display = 'none';
        renderChatMessages();
      }

      document.getElementById('chat-input').focus();
    }

    function sendHint(text) {
      document.getElementById('chat-input').value = text;
      sendMessage();
    }

    async function sendMessage() {
      console.log('[MuchiNavi v2] sendMessage called, isSending:', isSending);
      if (isSending) { console.log('[MuchiNavi] blocked: isSending is true'); return; }

      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) { console.log('[MuchiNavi] blocked: empty text'); return; }

      isSending = true;
      console.log('[MuchiNavi] sending:', text);

      // Hide welcome (may not exist if session restored)
      const welcomeEl = document.getElementById('chat-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';

      // Add user message
      chatMessages.push({ role: 'user', content: text });
      renderChatMessages();
      input.value = '';
      input.style.height = 'auto';
      input.focus();

      // Show typing indicator
      showTyping();

      // Disable send
      document.getElementById('chat-send-btn').disabled = true;

      try {
        console.log('[MuchiNavi] fetching /api/chat...');
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000);

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer: customerData,
            messages: chatMessages,
            token: sessionToken,
          }),
          signal: controller.signal,
        });
        clearTimeout(timeout);
        console.log('[MuchiNavi] response status:', res.status);
        const data = await res.json();
        console.log('[MuchiNavi] response data:', data);
        hideTyping();

        if (data.error) {
          chatMessages.push({ role: 'assistant', content: data.error });
        } else {
          chatMessages.push({ role: 'assistant', content: data.reply });
        }
        renderChatMessages();
      } catch (e) {
        console.error('[MuchiNavi] fetch error:', e);
        hideTyping();
        const msg = e.name === 'AbortError'
          ? 'ÂõûÁ≠î„ÅÆÁîüÊàê„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
          : '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        chatMessages.push({ role: 'assistant', content: msg });
        renderChatMessages();
      }

      document.getElementById('chat-send-btn').disabled = false;
      isSending = false;
    }

    function switchChatRoom(room) {
      currentChatRoom = room;

      // Toggle tab active state
      document.getElementById('tab-ai').classList.toggle('active', room === 'ai');
      document.getElementById('tab-direct').classList.toggle('active', room === 'direct');

      // Toggle message containers
      document.getElementById('chat-messages').style.display = room === 'ai' ? 'flex' : 'none';
      document.getElementById('ai-chat-input-bar').style.display = room === 'ai' ? 'flex' : 'none';
      document.getElementById('direct-chat-messages').style.display = room === 'direct' ? 'flex' : 'none';
      document.getElementById('direct-chat-input-bar').style.display = room === 'direct' ? 'flex' : 'none';

      // Clear badge
      document.getElementById(`badge-${room}`).classList.remove('show');

      if (room === 'direct') {
        renderDirectMessages();
        scrollDirectChat();
      }
    }

    function renderDirectMessages() {
      const container = document.getElementById('direct-chat-messages');
      const welcome = document.getElementById('direct-chat-welcome');

      if (directChatMessages.length === 0) {
        // Show welcome, clear any rendered messages except welcome
        container.innerHTML = '';
        const welcomeClone = welcome.cloneNode(true);
        container.appendChild(welcomeClone);
        return;
      }

      // Build messages HTML (LINEÈ¢®: Ëá™ÂàÜ„ÅåÂè≥„ÄÅ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅåÂ∑¶)
      let html = '';
      directChatMessages.forEach(msg => {
        const isUser = msg.role === 'user';
        const side = isUser ? 'user' : 'assistant';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : '';
        html += `<div class="chat-message ${side}">
          <div class="chat-bubble direct-${side}">
            ${isUser ? '' : '<div style="font-size:10px;font-weight:600;color:#34c759;margin-bottom:4px;">ÊãÖÂΩì„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>'}
            <div style="white-space:pre-wrap;">${msg.content}</div>
            ${time ? `<div style="font-size:10px;color:${isUser ? 'rgba(255,255,255,0.6)' : '#aeaeb2'};margin-top:4px;text-align:${isUser?'right':'left'}">${time}</div>` : ''}
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function scrollDirectChat() {
      const el = document.getElementById('direct-chat-messages');
      setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
    }

    async function sendDirectMessage() {
      const input = document.getElementById('direct-chat-input');
      const text = input.value.trim();
      if (!text) return;

      const msg = { role: 'user', content: text, timestamp: new Date().toISOString() };
      directChatMessages.push(msg);
      renderDirectMessages();
      scrollDirectChat();
      input.value = '';
      input.style.height = 'auto';
      input.focus();

      // Save to server
      try {
        await fetch(`/api/direct-chat-history/${sessionToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: directChatMessages }),
        });
      } catch (e) {
        console.error('Direct chat save error:', e);
      }
    }

    // Poll for new direct messages every 15 seconds
    setInterval(async () => {
      if (!sessionToken) return;
      try {
        const res = await fetch(`/api/session/${sessionToken}`);
        const data = await res.json();
        if (data.directChatHistory && data.directChatHistory.length > directChatMessages.length) {
          directChatMessages = data.directChatHistory;
          if (currentChatRoom === 'direct') {
            renderDirectMessages();
            scrollDirectChat();
          } else {
            // Show badge on direct tab
            document.getElementById('badge-direct').classList.add('show');
          }
        }
      } catch (e) {}
    }, 15000);

    // TimeRex URL (injected from server config)
    let timerexURL = '';
    fetch('/api/config').then(r => r.json()).then(d => { timerexURL = d.timerexURL || ''; updateBookingButton(); }).catch(() => {});

    function updateBookingButton() {
      const btn = document.getElementById('chat-booking-btn');
      if (btn && timerexURL) {
        btn.href = timerexURL;
        btn.style.display = 'inline-flex';
      } else if (btn) {
        btn.style.display = 'none';
      }
    }

    function formatContent(text) {
      if (!text) return '';

      // Extract article tags before HTML escaping
      const articles = [];
      text = text.replace(/\{\{ARTICLE\|(.+?)\|(.+?)\}\}/g, (_, title, url) => {
        articles.push({ title, url });
        return `__ARTICLE_${articles.length - 1}__`;
      });

      // Extract choice chips
      const choiceSets = [];
      text = text.replace(/\{\{CHOICES\|(.+?)\}\}/g, (_, choicesStr) => {
        const options = choicesStr.split('|').map(s => s.trim()).filter(Boolean);
        choiceSets.push(options);
        return `__CHOICES_${choiceSets.length - 1}__`;
      });

      // Extract TERASS Picks tags
      let terassPicksInfo = null;
      text = text.replace(/\{\{TERASS_PICKS\|(.+?)\|(.+?)\}\}/g, (_, desc, cta) => {
        terassPicksInfo = { desc, cta };
        return '__TERASS_PICKS__';
      });

      // Extract booking tags
      let bookingURL = '';
      text = text.replace(/\{\{BOOKING\|(.+?)\}\}/g, (_, url) => {
        bookingURL = url;
        return '__BOOKING__';
      });

      let html = text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/„Äê(.+?)„Äë/g, '<strong>„Äê$1„Äë</strong>')
        .replace(/^[\-‚Ä¢]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/^\d+[\.\)]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
        .replace(/\n\n+/g, '</p><p>')
        .replace(/\n/g, '<br>');
      html = '<p>' + html + '</p>';
      html = html.replace(/<p>\s*<\/p>/g, '').replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');

      // Replace article placeholders with cards (use <span> to avoid <p>/<div> nesting issues)
      articles.forEach((a, i) => {
        const card = `</p><a class="article-card" href="${a.url}" target="_blank" rel="noopener"><span class="article-card-icon">üìñ</span><span class="article-card-content"><span class="article-card-label">„Åä„Åô„Åô„ÇÅË®ò‰∫ã</span><span class="article-card-title">${a.title}</span></span><span class="article-card-arrow">‚Üí</span></a><p>`;
        html = html.replace(`__ARTICLE_${i}__`, card);
      });

      // Replace booking placeholder with card
      if (bookingURL) {
        const card = `</p><a class="booking-card" href="${bookingURL}" target="_blank" rel="noopener"><span class="booking-card-icon">üìÖ</span><span class="booking-card-content"><span class="booking-card-label">ÁÑ°ÊñôÁõ∏Ë´á</span><span class="booking-card-title">Â≤°Êú¨„Å®„Ç™„É≥„É©„Ç§„É≥Èù¢Ë´á</span><span class="booking-card-sub">„ÅîÈÉΩÂêà„ÅÆ„ÅÑ„ÅÑÊó•ÊôÇ„ÇíÈÅ∏„Åπ„Åæ„Åô</span></span><span class="booking-card-arrow">‚Üí</span></a><p>`;
        html = html.replace('__BOOKING__', card);
      }

      // Replace TERASS Picks placeholder with card
      if (terassPicksInfo) {
        const card = `</p><div style="background: linear-gradient(135deg, #f0f7ff, #e8f4f8); border: 1px solid #b3d4fc; border-radius: 16px; padding: 20px; margin: 12px 0;"><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;"><span style="font-size: 24px;">üè†</span><strong style="color: #0071e3; font-size: 15px;">TERASS Picks</strong></div><p style="font-size: 14px; line-height: 1.7; color: #333; margin: 0 0 12px 0;">${terassPicksInfo.desc}</p><p style="font-size: 13px; color: #666; margin: 0;"><span style="background: #0071e3; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 6px;">‚ú®</span>${terassPicksInfo.cta}</p></div><p>`;
        html = html.replace('__TERASS_PICKS__', card);
      }

      // Replace choice chip placeholders
      choiceSets.forEach((options, i) => {
        const chips = `</p><div class="chat-choices" data-choice-set="${i}">${options.map(opt => `<button class="chat-choice-chip" onclick="selectChatChoice(this, '${opt.replace(/'/g, "\\'")}')">${opt}</button>`).join('')}</div><p>`;
        html = html.replace(`__CHOICES_${i}__`, chips);
      });

      // Clean up empty <p> tags and stray <br> around cards
      html = html.replace(/<p>\s*<\/p>/g, '');
      html = html.replace(/<br>\s*(<a class="article-card)/g, '$1');
      html = html.replace(/<br>\s*(<a class="booking-card)/g, '$1');
      html = html.replace(/<br>\s*(<div class="chat-choices)/g, '$1');
      html = html.replace(/<br>\s*(<div style="background: linear-gradient)/g, '$1');
      html = html.replace(/(<\/a>)\s*<br>/g, '$1');
      html = html.replace(/(<\/div>)\s*<br>/g, '$1');

      return html;
    }

    let isSending = false; // ‰∫åÈáçÈÄÅ‰ø°Èò≤Ê≠¢

    // ===== textarea Ëá™ÂãïÈ´ò„ÅïË™øÊï¥ & „Ç≠„Éº„Éè„É≥„Éâ„É© =====
    function setupChatTextarea(textareaId, sendFunction) {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;

      // Ëá™ÂãïÈ´ò„ÅïË™øÊï¥
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // PC: Enter = ÊîπË°åÔºà„Éá„Éï„Ç©„É´„ÉàÂãï‰ΩúÔºâ„ÄÅShift+Enter = ÈÄÅ‰ø°
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          sendFunction();
        }
      });
    }

    // DOMË™≠„ÅøËæº„ÅøÂæå„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
    document.addEventListener('DOMContentLoaded', function() {
      setupChatTextarea('chat-input', sendMessage);
      setupChatTextarea('direct-chat-input', sendDirectMessage);
    });

    function selectChatChoice(btn, text) {
      if (isSending) return; // ÈÄÅ‰ø°‰∏≠„Å™„ÇâÁÑ°Ë¶ñ

      // ÂÖ®„ÉÅ„ÉÉ„Éó„ÇíÁÑ°ÂäπÂåñ
      const container = btn.closest('.chat-choices');
      if (container) {
        container.querySelectorAll('.chat-choice-chip').forEach(chip => {
          chip.classList.add('used');
          chip.onclick = null;
        });
        btn.classList.remove('used');
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
      }

      // Áõ¥Êé•„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°Ôºàinput„ÇíÁµåÁî±„Åó„Å™„ÅÑÔºâ
      sendChoiceMessage(text);
    }

    async function sendChoiceMessage(text) {
      if (isSending || !text) return;
      isSending = true;

      // Hide welcome (may not exist if session restored)
      const welcomeEl = document.getElementById('chat-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';
      chatMessages.push({ role: 'user', content: text });
      renderChatMessages();
      document.getElementById('chat-input').value = '';
      showTyping();
      document.getElementById('chat-send-btn').disabled = true;

      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000);

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer: customerData,
            messages: chatMessages,
            token: sessionToken,
          }),
          signal: controller.signal,
        });
        clearTimeout(timeout);
        const data = await res.json();
        hideTyping();
        if (data.error) {
          chatMessages.push({ role: 'assistant', content: data.error });
        } else {
          chatMessages.push({ role: 'assistant', content: data.reply });
        }
        renderChatMessages();
      } catch (e) {
        hideTyping();
        const msg = e.name === 'AbortError'
          ? 'ÂõûÁ≠î„ÅÆÁîüÊàê„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
          : '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        chatMessages.push({ role: 'assistant', content: msg });
        renderChatMessages();
      }

      document.getElementById('chat-send-btn').disabled = false;
      isSending = false;
    }

    function renderChatMessages() {
      const container = document.getElementById('chat-messages');
      container.innerHTML = chatMessages.map((m, idx) => {
        if (m.role === 'user') {
          const escaped = m.content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div class="chat-message user"><div class="chat-bubble" style="white-space:pre-wrap;">${escaped}</div></div>`;
        }
        // AI message - check if the NEXT message is a user picking a choice
        const nextMsg = chatMessages[idx + 1];
        let content = formatContent(m.content);

        // If next user message exists and this AI message had choices, mark them as used
        if (nextMsg && nextMsg.role === 'user' && content.includes('chat-choices')) {
          const selectedText = nextMsg.content;
          // Disable all chips and highlight the selected one
          content = content.replace(/class="chat-choice-chip"/g, 'class="chat-choice-chip used" disabled');
          content = content.replace(
            new RegExp(`class="chat-choice-chip used" disabled>` + selectedText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + `<`),
            `class="chat-choice-chip" style="background:var(--accent);color:white;border-color:var(--accent);pointer-events:none">${selectedText}<`
          );
          // Remove onclick from all chips in this message
          content = content.replace(/onclick="selectChatChoice\([^"]*\)"/g, '');
        }

        return `<div class="chat-message assistant"><div class="chat-bubble">${content}</div></div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('chat-messages');
      const el = document.createElement('div');
      el.id = 'typing';
      el.className = 'chat-message assistant';
      el.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      container.appendChild(el);
      container.scrollTop = container.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById('typing');
      if (el) el.remove();
    }

    // ===== Init: Check for existing session =====
    async function init() {
      // Check URL param first, then localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromURL = urlParams.get('t');
      const tokenFromStorage = localStorage.getItem('muchinavi_token');
      const token = tokenFromURL || tokenFromStorage;
      const withdrawParam = urlParams.get('withdraw');

      if (token) {
        try {
          const res = await fetch(`/api/session/${token}`);
          const data = await res.json();

          // „Éñ„É≠„ÉÉ„ÇØÊ∏à„Åø
          if (data.found && data.blocked) {
            localStorage.removeItem('muchinavi_token');
            showBlockedScreen();
            return;
          }

          if (data.found) {
            // Restore session
            sessionToken = token;
            localStorage.setItem('muchinavi_token', token);
            history.replaceState(null, '', `?t=${token}`);

            // Restore customer data
            Object.assign(customerData, data.customer);
            chatMessages = data.chatHistory || [];
            if (data.directChatHistory && data.directChatHistory.length > 0) {
              directChatMessages = data.directChatHistory;
            }

            // URL„Å´ withdraw=true „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈÄÄ‰ºöÁ¢∫Ë™ç„ÇíË°®Á§∫
            if (withdrawParam === 'true') {
              startChat();
              showWithdrawModal();
              return;
            }

            // Skip onboarding, go to chat
            startChat();
            return;
          }
        } catch (e) {
          console.error('„Çª„ÉÉ„Ç∑„Éß„É≥Âæ©ÂÖÉ„Ç®„É©„Éº:', e);
        }
      }

      // No session found ‚Äî show onboarding
      renderStep(0);
    }

    // ===== Settings menu =====
    function toggleSettings(event) {
      event.stopPropagation();
      const dd = document.getElementById('settings-dropdown');
      dd.classList.toggle('show');
    }
    // Close dropdown when clicking elsewhere
    document.addEventListener('click', () => {
      document.getElementById('settings-dropdown').classList.remove('show');
    });

    // ===== Logout =====
    function doLogout() {
      document.getElementById('settings-dropdown').classList.remove('show');
      localStorage.removeItem('muchinavi_token');
      sessionToken = null;
      chatMessages = [];
      directChatMessages = [];
      Object.keys(customerData).forEach(k => delete customerData[k]);
      // Reload to show welcome/login screen
      window.location.href = window.location.pathname;
    }

    // ===== Withdraw (ÈÄÄ‰ºö) =====
    function showWithdrawModal() {
      document.getElementById('settings-dropdown').classList.remove('show');
      document.getElementById('withdraw-modal').classList.add('active');
    }

    function closeWithdrawModal() {
      document.getElementById('withdraw-modal').classList.remove('active');
    }

    async function executeWithdraw() {
      if (!sessionToken) {
        closeWithdrawModal();
        return;
      }
      try {
        const res = await fetch(`/api/withdraw/${sessionToken}`, { method: 'POST' });
        const data = await res.json();
        closeWithdrawModal();
        if (data.success) {
          // LocalStorage „Çí„ÇØ„É™„Ç¢„Åó„Å¶„Ç™„É≥„Éú„Éº„Éá„Ç£„É≥„Ç∞„Å∏
          localStorage.removeItem('muchinavi_token');
          showWithdrawComplete();
        }
      } catch (e) {
        console.error('ÈÄÄ‰ºö„Ç®„É©„Éº:', e);
        closeWithdrawModal();
        alert('ÈÄÄ‰ºöÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
      }
    }

    function showWithdrawComplete() {
      document.getElementById('chat-screen').classList.remove('active');
      document.getElementById('onboarding').style.display = '';
      const card = document.getElementById('step-card');
      card.innerHTML = `
        <div class="step-icon">üëã</div>
        <h2 class="step-title">„ÅîÂà©Áî®„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü</h2>
        <p class="step-subtitle">ÈÄÄ‰ºöÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ<br>„Åæ„Åü„ÅÆ„ÅîÂà©Áî®„Çí„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ</p>
        <button class="btn-primary" onclick="location.href='/';" style="margin-top: 16px;">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
      `;
      document.getElementById('progress').style.display = 'none';
      history.replaceState(null, '', '/');
    }

    // ===== Block screen =====
    function showBlockedScreen() {
      document.getElementById('blocked-screen').classList.add('active');
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('chat-screen').classList.remove('active');
    }

    // ===== Profile Page Functions =====

    function populateProfileSelects() {
      // Birth year
      const yearSelect = document.getElementById('prof-birthYear');
      for (let y = 2010; y >= 1950; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + 'Âπ¥';
        yearSelect.appendChild(opt);
      }
      // Birth month
      const monthSelect = document.getElementById('prof-birthMonth');
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m + 'Êúà';
        monthSelect.appendChild(opt);
      }
      // Prefectures
      const prefSelect = document.getElementById('prof-prefecture');
      const prefs = ['ÂåóÊµ∑ÈÅì','ÈùíÊ£ÆÁúå','Â≤©ÊâãÁúå','ÂÆÆÂüéÁúå','ÁßãÁî∞Áúå','Â±±ÂΩ¢Áúå','Á¶èÂ≥∂Áúå','Ëå®ÂüéÁúå','Ê†ÉÊú®Áúå','Áæ§È¶¨Áúå','ÂüºÁéâÁúå','ÂçÉËëâÁúå','Êù±‰∫¨ÈÉΩ','Á•ûÂ•àÂ∑ùÁúå','Êñ∞ÊΩüÁúå','ÂØåÂ±±Áúå','Áü≥Â∑ùÁúå','Á¶è‰∫ïÁúå','Â±±Ê¢®Áúå','Èï∑ÈáéÁúå','Â≤êÈòúÁúå','ÈùôÂ≤°Áúå','ÊÑõÁü•Áúå','‰∏âÈáçÁúå','ÊªãË≥ÄÁúå','‰∫¨ÈÉΩÂ∫ú','Â§ßÈò™Â∫ú','ÂÖµÂ∫´Áúå','Â•àËâØÁúå','ÂíåÊ≠åÂ±±Áúå','È≥•ÂèñÁúå','Â≥∂Ê†πÁúå','Â≤°Â±±Áúå','Â∫ÉÂ≥∂Áúå','Â±±Âè£Áúå','Âæ≥Â≥∂Áúå','È¶ôÂ∑ùÁúå','ÊÑõÂ™õÁúå','È´òÁü•Áúå','Á¶èÂ≤°Áúå','‰ΩêË≥ÄÁúå','Èï∑Â¥éÁúå','ÁÜäÊú¨Áúå','Â§ßÂàÜÁúå','ÂÆÆÂ¥éÁúå','ÈπøÂÖêÂ≥∂Áúå','Ê≤ñÁ∏ÑÁúå'];
      prefs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        prefSelect.appendChild(opt);
      });
    }

    async function openProfile() {
      // Close settings dropdown
      document.getElementById('settings-dropdown').classList.remove('show');

      const token = localStorage.getItem('muchinavi_token');
      if (!token) return;

      try {
        const res = await fetch(`/api/customer/profile/${token}`);
        const data = await res.json();
        if (!data.success) return;

        const p = data.profile;
        document.getElementById('prof-name').value = p.name || '';
        document.getElementById('prof-birthYear').value = p.birthYear || '';
        document.getElementById('prof-birthMonth').value = p.birthMonth || '';
        document.getElementById('prof-prefecture').value = p.prefecture || '';
        document.getElementById('prof-family').value = p.family || '';
        document.getElementById('prof-householdIncome').value = p.householdIncome || '';
        document.getElementById('prof-propertyType').value = p.propertyType || '';
        document.getElementById('prof-area').value = p.area || '';
        document.getElementById('prof-budget').value = p.budget || '';
        document.getElementById('prof-email').value = p.email || '';
        document.getElementById('prof-phone').value = p.phone || '';
        document.getElementById('prof-line').value = p.line || '';

        document.getElementById('profile-screen').classList.add('active');
      } catch (e) {
        console.error('Profile load error:', e);
      }
    }

    function closeProfile() {
      document.getElementById('profile-screen').classList.remove('active');
    }

    async function saveProfile() {
      const token = localStorage.getItem('muchinavi_token');
      if (!token) return;

      const btn = document.getElementById('profile-save-btn');
      btn.disabled = true;
      btn.textContent = '‰øùÂ≠ò‰∏≠...';

      const profileData = {
        name: document.getElementById('prof-name').value.trim(),
        birthYear: document.getElementById('prof-birthYear').value,
        birthMonth: document.getElementById('prof-birthMonth').value,
        prefecture: document.getElementById('prof-prefecture').value,
        family: document.getElementById('prof-family').value.trim(),
        householdIncome: document.getElementById('prof-householdIncome').value,
        propertyType: document.getElementById('prof-propertyType').value,
        area: document.getElementById('prof-area').value.trim(),
        budget: document.getElementById('prof-budget').value.trim(),
        email: document.getElementById('prof-email').value.trim(),
        phone: document.getElementById('prof-phone').value.trim(),
        line: document.getElementById('prof-line').value.trim(),
      };

      try {
        const res = await fetch(`/api/customer/profile/${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData),
        });
        const data = await res.json();

        if (data.success) {
          showProfileToast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úì', 'success');
          // Update the chat header name display
          if (profileData.name) {
            document.getElementById('chat-customer-name').textContent = profileData.name + ' „Åï„Çì';
          }
        } else {
          showProfileToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
      } catch (e) {
        showProfileToast('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Â§âÊõ¥„Çí‰øùÂ≠ò„Åô„Çã';
    }

    function showProfileToast(msg, type) {
      const toast = document.getElementById('profile-toast');
      toast.textContent = msg;
      toast.className = 'profile-toast ' + type + ' show';
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    async function changeCustomerPassword() {
      const pw = document.getElementById('prof-new-password').value;
      const pwConfirm = document.getElementById('prof-new-password-confirm').value;
      if (!pw || pw.length < 6) {
        showProfileToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }
      if (pw !== pwConfirm) {
        showProfileToast('„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/customer/change-password/${sessionToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword: pw }),
        });
        const data = await res.json();
        if (data.success) {
          showProfileToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü ‚úì', 'success');
          document.getElementById('prof-new-password').value = '';
          document.getElementById('prof-new-password-confirm').value = '';
        } else {
          showProfileToast(data.error || 'Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
      } catch (e) {
        showProfileToast('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
      }
    }

    // Initialize profile selects
    populateProfileSelects();

    // ===== Service Worker ÁôªÈå≤ =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then((reg) => {
        console.log('SW registered:', reg.scope);
      }).catch((err) => {
        console.log('SW registration failed:', err);
      });
    }

    // ===== „Éõ„Éº„É†ÁîªÈù¢ËøΩÂä†„ÅÆÊ°àÂÜÖ„Éê„Éä„ÉºÔºàPWA Install PromptÔºâ =====
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÊôÇ„Å´Ë°®Á§∫
      setTimeout(showInstallBanner, 3000);
    });

    function showInstallBanner() {
      if (!deferredPrompt) return;
      // Êó¢„Å´Ë°®Á§∫Ê∏à„Åø„Å™„ÇâÂá∫„Åï„Å™„ÅÑ
      if (localStorage.getItem('muchinavi_install_dismissed')) return;

      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.innerHTML = `
        <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;
          background:#1d1d1f;color:white;padding:16px 20px;border-radius:16px;
          box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:360px;width:calc(100% - 40px);
          display:flex;align-items:center;gap:14px;font-family:-apple-system,sans-serif;
          animation:slideUpBanner 0.4s ease-out;">
          <div style="font-size:32px;flex-shrink:0;">üì±</div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;margin-bottom:4px;">„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†</div>
            <div style="font-size:12px;color:#aeaeb2;line-height:1.4;">„Ç¢„Éó„É™„Å®„Åó„Å¶Âø´ÈÅ©„Å´„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
            <button onclick="doInstallPWA()" style="background:#0071e3;color:white;border:none;
              padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;
              font-family:inherit;">ËøΩÂä†</button>
            <button onclick="dismissInstallBanner()" style="background:none;color:#aeaeb2;border:none;
              padding:4px;font-size:11px;cursor:pointer;font-family:inherit;">Âæå„Åß</button>
          </div>
        </div>
      `;
      document.body.appendChild(banner);
    }

    function doInstallPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        deferredPrompt = null;
        const banner = document.getElementById('install-banner');
        if (banner) banner.remove();
        if (choice.outcome === 'accepted') {
          localStorage.setItem('muchinavi_install_dismissed', '1');
        }
      });
    }

    function dismissInstallBanner() {
      const banner = document.getElementById('install-banner');
      if (banner) banner.remove();
      localStorage.setItem('muchinavi_install_dismissed', '1');
    }

    // iOS SafariÂêë„ÅëÊ°àÂÜÖÔºàbeforeinstallprompt„ÅåÁô∫ÁÅ´„Åó„Å™„ÅÑÔºâ
    function checkIOSInstallPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.navigator.standalone === true;
      const dismissed = localStorage.getItem('muchinavi_ios_install_dismissed');

      if (isIOS && !isStandalone && !dismissed) {
        setTimeout(() => {
          const banner = document.createElement('div');
          banner.id = 'ios-install-banner';
          banner.innerHTML = `
            <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;
              background:#1d1d1f;color:white;padding:16px 20px;border-radius:16px;
              box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:380px;width:calc(100% - 40px);
              font-family:-apple-system,sans-serif;animation:slideUpBanner 0.4s ease-out;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <span style="font-size:28px;">üì±</span>
                <div>
                  <div style="font-weight:600;font-size:14px;">„Ç¢„Éó„É™„Å®„Åó„Å¶‰Ωø„Åà„Åæ„Åô</div>
                  <div style="font-size:12px;color:#aeaeb2;margin-top:2px;">„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶Âø´ÈÅ©„Å´</div>
                </div>
                <button onclick="dismissIOSBanner()" style="margin-left:auto;background:none;border:none;
                  color:#aeaeb2;font-size:18px;cursor:pointer;padding:4px;">‚úï</button>
              </div>
              <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;font-size:13px;line-height:1.6;">
                ‚ë† Safari„ÅÆ„É°„Éã„É•„Éº„Éê„Éº„Å´„ÅÇ„Çã<br>„ÄÄ <span style="font-size:16px;">‚ñ°‚Üë</span>ÔºàÂÖ±ÊúâÔºâ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó<br>
                ‚ë°„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„ÇíÈÅ∏Êäû<br>
                <span style="font-size:11px;color:#8e8e93;">‚Äª Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„É°„Éã„É•„Éº„Çí<br>„ÄÄ ‰∏ä„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
              </div>
            </div>
          `;
          document.body.appendChild(banner);
        }, 5000);
      }
    }

    function dismissIOSBanner() {
      const banner = document.getElementById('ios-install-banner');
      if (banner) banner.remove();
      localStorage.setItem('muchinavi_ios_install_dismissed', '1');
    }

    // „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢Ë°®Á§∫Âæå„Å´iOSÊ°àÂÜÖ„ÉÅ„Çß„ÉÉ„ÇØ
    const origStartChat = startChat;
    startChat = function() {
      origStartChat.apply(this, arguments);
      checkIOSInstallPrompt();
    };

    init();
  </script>

  <style>
    @keyframes slideUpBanner {
      from { opacity: 0; transform: translateX(-50%) translateY(30px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</body>
</html>
